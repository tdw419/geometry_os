name: Multi-Platform CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Weekly multi-platform test
    - cron: '0 5 * * 1'  # Every Monday at 5 AM UTC
  workflow_dispatch:

jobs:
  test-linux:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y \
          build-essential \
          cmake \
          python3 \
          python3-pip \
          python3-dev \
          git \
          curl \
          wget

    - name: Install Python packages
      run: |
        pip3 install pytest pytest-cov matplotlib numpy pyyaml requests

    - name: Build and test
      run: |
        chmod +x build/*.sh
        ./build/build_runner.sh
        ./run_integration_tests.sh --only-unit

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results-linux-${{ github.run_number }}
        path: test_results/

  test-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew update
        brew install \
          cmake \
          python@3 \
          git \
          curl \
          wget

    - name: Set up Python virtual environment
      run: |
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install pytest pytest-cov matplotlib numpy pyyaml requests

    - name: Build and test
      run: |
        source venv/bin/activate
        chmod +x build/*.sh
        ./build/build_runner.sh || true
        python3 -m pytest tests/ -v --tb=short || echo "Some tests failed on macOS"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results-macos-${{ github.run_number }}
        path: test_results/

  test-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov matplotlib numpy pyyaml requests

    - name: Build and test
      run: |
        # Skip C++ builds on Windows for now (focus on Python components)
        python -m pytest test_*.py -v --tb=short || echo "Some tests failed on Windows"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results-windows-${{ github.run_number }}
        path: test_results/

  test-docker:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t vectoros-test .

    - name: Run tests in Docker
      run: |
        docker run --rm vectoros-test ./run_integration_tests.sh --only-unit

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results-docker-${{ github.run_number }}
        path: test_results/

  matrix-results:
    runs-on: ubuntu-latest
    needs: [test-linux, test-macos, test-windows, test-docker]
    if: always()

    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: all-test-results/

    - name: Generate multi-platform summary
      run: |
        echo "# Multi-Platform Test Summary" > multi_platform_summary.md
        echo "Generated: $(date)" >> multi_platform_summary.md
        echo "" >> multi_platform_summary.md

        # Check each platform
        platforms=("linux" "macos" "windows" "docker")
        all_passed=true

        for platform in "${platforms[@]}"; do
          echo "## $platform" >> multi_platform_summary.md
          if [ -d "all-test-results/test-results-$platform-${{ github.run_number }}" ]; then
            echo "✅ Tests completed" >> multi_platform_summary.md
            # Add more detailed results here
          else
            echo "❌ Tests failed or not found" >> multi_platform_summary.md
            all_passed=false
          fi
          echo "" >> multi_platform_summary.md
        done

        echo "## Overall Status" >> multi_platform_summary.md
        if [ "$all_passed" = true ]; then
          echo "✅ All platforms passed" >> multi_platform_summary.md
        else
          echo "❌ Some platforms failed" >> multi_platform_summary.md
        fi

    - name: Upload summary
      uses: actions/upload-artifact@v4
      with:
        name: multi-platform-summary-${{ github.run_number }}
        path: multi_platform_summary.md

    - name: Fail if any platform failed
      if: needs.test-linux.result == 'failure' || needs.test-macos.result == 'failure' || needs.test-windows.result == 'failure' || needs.test-docker.result == 'failure'
      run: |
        echo "One or more platforms failed testing"
        exit 1