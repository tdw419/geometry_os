name: Nightly Build

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  nightly-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        apt-get update
        apt-get install -y \
          build-essential \
          cmake \
          python3 \
          python3-pip \
          python3-dev \
          git \
          curl \
          wget \
          grub-pc-bin \
          xorriso \
          libssl-dev \
          pkg-config \
          libgtk-3-dev \
          libcairo2-dev \
          libpango1.0-dev \
          libgdk-pixbuf2.0-dev \
          libatk1.0-dev \
          valgrind \
          clang \
          clang-tidy

    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install \
          pytest \
          pytest-cov \
          pytest-xdist \
          matplotlib \
          numpy \
          pyyaml \
          requests

    - name: Build VectorOS components
      run: |
        chmod +x build/*.sh
        ./build/build_vector_linux_overnight.sh

    - name: Run comprehensive test suite
      run: |
        ./run_integration_tests.sh
        ./run_performance_benchmarks.sh --ci

    - name: Generate performance baselines
      run: |
        ./run_performance_benchmarks.sh --baseline

    - name: Build ISO and documentation
      run: |
        ./build/build_cortex_bundle.sh
        ./build/build_vector_iso.sh
        ./build_docs.sh

    - name: Upload nightly artifacts
      uses: actions/upload-artifact@v3
      with:
        name: nightly-build-${{ github.run_number }}
        path: |
          VectorOS_v*.iso
          VectorOS_v*.sha256
          docs/_build/
          benchmark_results/
          test_results/

    - name: Create nightly release
      if: github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: nightly-${{ github.run_number }}
        release_name: Nightly Build ${{ github.run_number }}
        body: |
          Automated nightly build of VectorOS.

          ## Changes
          - Latest commits from main branch
          - Updated performance baselines
          - Full test suite execution

          ## Artifacts
          - VectorOS ISO image
          - Documentation
          - Test reports
          - Performance benchmarks
        draft: false
        prerelease: true

  performance-regression-check:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y python3 python3-pip
        pip3 install matplotlib numpy pyyaml requests

    - name: Check performance regressions
      run: |
        ./run_performance_benchmarks.sh --ci
        # Check for regressions in the output
        if grep -q "REGRESSION DETECTED" benchmark_results/performance_report_*.md; then
          echo "Performance regression detected!"
          exit 1
        else
          echo "No performance regressions detected."
        fi

  security-audit:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install security tools
      run: |
        python3 -m pip install --upgrade pip
        pip3 install bandit safety

    - name: Run security audit
      run: |
        bandit -r . -f json -o nightly_security_report.json
        safety check --json > nightly_safety_report.json

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: nightly-security-${{ github.run_number }}
        path: |
          nightly_security_report.json
          nightly_safety_report.json