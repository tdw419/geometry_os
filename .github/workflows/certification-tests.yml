name: Certification Tests

on:
  # Trigger nightly at 03:00 UTC
  schedule:
    - cron: '0 3 * * *'

  # Allow manual workflow dispatch
  workflow_dispatch:
    inputs:
      level:
        description: 'Certification level to run (leave empty for all levels)'
        required: false
        type: string
        default: ''

  # Allow this workflow to be called from other workflows
  workflow_call:
    inputs:
      level:
        description: 'Certification level to run (leave empty for all levels)'
        required: false
        type: string
        default: ''

jobs:
  certification-tests:
    name: WordPress Certification Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      # MariaDB 10.11 service container
      mariadb:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
          MYSQL_USER: wordpress
          MYSQL_PASSWORD: wordpress
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      # WordPress 6.4 service container
      wordpress:
        image: wordpress:6.4-php8.2-apache
        env:
          WORDPRESS_DB_HOST: mariadb:3306
          WORDPRESS_DB_NAME: wordpress
          WORDPRESS_DB_USER: wordpress
          WORDPRESS_DB_PASSWORD: wordpress
          WORDPRESS_TABLE_PREFIX: wp_
          # Certbot secrets (must be configured in GitHub repo settings)
          CERTBOT_SECRET: ${{ secrets.CERTBOT_SECRET }}
          CERTBOT_PASSWORD: ${{ secrets.CERTBOT_PASSWORD }}
        ports:
          - 8080:80
        options: >-
          --health-cmd="curl -f http://localhost/ || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
          --health-start-period=30s
        volumes:
          - ${{ github.workspace }}/wordpress_zone/wordpress/wp-content:/var/www/html/wp-content:ro

    env:
      WP_URL: http://localhost:8080
      WP_USER: certbot
      WP_PASS: ${{ secrets.CERTBOT_PASSWORD }}
      HEADLESS: "true"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Wait for WordPress
        run: |
          echo "Waiting for WordPress to be ready..."
          for i in {1..60}; do
            if curl -s -f http://localhost:8080/ > /dev/null 2>&1; then
              echo "WordPress is ready!"
              exit 0
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done
          echo "WordPress failed to start!"
          exit 1

      - name: Setup certbot user
        env:
          CERTBOT_SECRET: ${{ secrets.CERTBOT_SECRET }}
          CERTBOT_PASSWORD: ${{ secrets.CERTBOT_PASSWORD }}
        run: |
          echo "Creating certbot user via REST endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "http://localhost:8080/wp-json/geometry-os/v1/create-certbot" \
            -H "Content-Type: application/json" \
            -d "{\"secret\": \"${CERTBOT_SECRET}\", \"password\": \"${CERTBOT_PASSWORD}\"}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Failed to create certbot user!"
            exit 1
          fi
          echo "Certbot user created successfully!"

      - name: Run certification tests
        env:
          WP_URL: http://localhost:8080/wp-admin/tools.php?page=geoos-certify
          WP_USER: certbot
          WP_PASS: ${{ secrets.CERTBOT_PASSWORD }}
          HEADLESS: "true"
        run: |
          LEVEL="${{ github.event.inputs.level || inputs.level || '' }}"
          if [ -n "$LEVEL" ]; then
            echo "Running certification level: $LEVEL"
            node systems/visual_shell/web/tests/cli_certification_runner.js "$LEVEL"
          else
            echo "Running all certification levels..."
            node systems/visual_shell/web/tests/cli_certification_runner.js
          fi
