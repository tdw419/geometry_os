---
spec: wordpress-git-coordination
basePath: specs/wordpress-git-coordination
phase: research
task: 0/0
updated: 2026-02-21T12:30:00Z
---

# Progress: wordpress-git-coordination

## Original Goal

Multi-agent coordination system using WordPress as Track Board with file locking, branch-per-track enforcement, and visual pulse integration.

## Completed Tasks

- [x] 1.1 Create geometry-tracks.php plugin with track_claim CPT
- [x] 1.2 Add track handlers to ai-publisher.php
- [x] 1.3 Create TrackManager Python client

- [x] 1.4 Add CLI interface to track_manager.py

## Current Task

Task 2.4 complete. Ready for Task 3.1: Unit tests for TrackManager.

## Learnings

### Research Phase (2026-02-21)
- Existing WordPress plugins (Swarm Node, WebMCP) provide perfect REST API patterns
- Pre-commit hook already exists for WGSL checks - can chain track check after
- `ai-publisher.php` uses switch-case dispatcher - add track handlers there, not new REST routes
- Visual Bridge already has `wordpress_publish` handler - add `track_claim`/`track_release` following same pattern
- Git worktrees in use at `.worktrees/feat/` - branch-per-track already supported
- Conductor tracks.md format: `**[track-id](./path)**: description`
- Race condition mitigation: `get_posts()` + `wp_insert_post()` has ~50ms race window - acceptable for human-speed agents
- Quality commands: `make lint`, `make check`, `make test-unit`, `make test-integration`
- `geometry.agent-id` git config not set - install script should create it

## Blockers

- None currently

## Next

Complete research, then proceed to requirements

## Requirements Phase (2026-02-21)

### Learnings
- 5 user stories cover full ecosystem: agents, developers, end users
- P0 requirements: claim/release handlers, CPT registration, Python client, pre-commit hook
- P1 requirements: heartbeat expiry, Visual Bridge integration, git config setup
- Graceful degradation is critical: commits must succeed when WordPress unavailable
- 10-min heartbeat expiry balances stale claim cleanup with agent flexibility
- `strpos()` path prefix check is simpler and faster than regex for file overlap detection

### Decisions Made
- Claims stored as WordPress `track_claim` CPT (not custom table)
- Pre-commit hook chains after existing WGSL check (not replacement)
- Skip check via `SKIP_TRACK_CHECK=true` for emergency commits
- Visual Bridge handlers follow existing `wordpress_publish` pattern

## Design Phase (2026-02-21)

### Architecture Decisions
- Single Python client (`TrackManager`) handles both agent operations and git hook checks
- Exit code convention: 0=no conflict, 1=conflict, 2=WordPress unavailable (graceful)
- CPT admin columns: Track ID, Agent ID, Files Count, Heartbeat (with EXPIRED badge)
- WebSocket pulse format: `TRACK_CLAIMED`/`TRACK_RELEASED` with track_id, agent_id, coordinates

### Interface Patterns
- `ai-publisher.php`: Switch-case with `$action` and `$args` (same as existing handlers)
- `TrackManager`: Methods `claim()`, `release()`, `check_conflicts()`, `heartbeat()`, `list_active()`
- Visual Bridge: `elif msg_type == 'track_claim':` pattern (same as `wordpress_publish`)

### Technical Constraints
- 5s HTTP timeout for pre-commit hook (must not block developer)
- `strpos()` for path prefix overlap (O(n*m) acceptable for < 10 claims)
- Heartbeat stored in post meta as ISO datetime string
- Coordinates for pulse derived from hash of track_id (consistent per track)

### Unresolved
- Expired claim handling: mark as `trash` vs delete (recommend trash for audit)
- Coordinate derivation algorithm: hash vs lookup (recommend hash for simplicity)

## Tasks Phase (2026-02-21)

### Task Planning Learnings
- 20 tasks total across 5 phases (POC, Refactoring, Testing, Quality Gates, PR Lifecycle)
- POC phase focuses on claim/release cycle: CPT + handlers + TrackManager + CLI
- Visual Bridge integration deferred to Phase 2 (refactoring) to validate core first
- Pre-commit hook chains after existing WGSL check (lines 1-37 of current hook)
- Exit codes for CLI: 0=no conflict, 1=conflict, 2=WordPress unavailable (graceful)
- Tests use pytest with unittest.mock for HTTP mocking
- Quality commands: `python3 -m py_compile`, `python3 -m flake8`, `python3 -m pytest`

### Task Dependencies
- 1.2 (ai-publisher handlers) requires 1.1 (CPT registration) for query/insert
- 1.4 (CLI) requires 1.3 (TrackManager class) for implementation
- 2.4 (Visual Bridge) requires 1.2 (handlers) for trigger points
- 3.1 (unit tests) requires 1.3 (TrackManager) complete
- 4.1 (pre-commit) requires 1.4 (CLI) for invocation

### Risk Areas
- WordPress not running during verification - added graceful fallback
- Race condition on claim (~50ms window) - acceptable per design
- Test flakiness with WordPress integration - marked with skipif

## Implementation Phase (2026-02-21)

### Task 1.1 Complete
- Created `wordpress_zone/wordpress/wp-content/plugins/geometry-tracks.php`
- Registered `track_claim` CPT on `init` hook with clipboard menu icon
- Added admin columns: Agent ID, Files Count, Heartbeat, Status
- Added EXPIRED badge for heartbeat > 10 min (red text)
- Added dashboard widget for active claims overview
- Plugin requires manual activation in WordPress admin (or via WP-CLI)

### Learnings
- Plugin follows WordPress coding standards from `hello.php` example
- CPT is `public => false` but `show_ui => true` for admin-only access
- `current_time('timestamp')` returns local blog time for heartbeat comparison
- Dashboard widget shows top 10 recent claims with status indicators

### Task 1.2 Complete
- Added 4 switch cases to ai-publisher.php: claimTrack, releaseTrack, listTracks, heartbeatTrack
- Implemented `handle_claim_track()`: validates input, checks overlaps via strpos(), creates CPT, returns claim_id
- Implemented `handle_release_track()`: verifies agent_id owner, moves to trash (audit trail)
- Implemented `handle_list_tracks()`: queries active claims with heartbeat filter (10 min expiry)
- Implemented `handle_heartbeat_track()`: updates meta_heartbeat timestamp
- Added `notify_visual_bridge()` for non-blocking UDP notification to port 8769
- Added `check_file_overlaps()` helper using strpos() for path prefix matching
- All handlers verified with curl returning valid JSON

### Learnings
- PHP socket extension may not be available - graceful degradation with `function_exists('socket_create')` check
- WordPress already has test claim from previous POC testing
- 10-minute heartbeat filter uses DATETIME comparison in meta_query

### Task 1.3 Complete
- Created `wordpress_zone/track_manager.py` with TrackManager class
- Implemented all methods: `claim()`, `release()`, `check_conflicts()`, `heartbeat()`, `list_active()`
- Added CLI interface with `check` and `list` subcommands
- Added exit codes: 0=no conflict, 1=conflict, 2=WordPress unavailable
- Added `SKIP_TRACK_CHECK=true` environment variable bypass
- Custom exceptions: `TrackManagerError`, `WordPressUnavailableError`, `TrackConflictError`
- All methods verified working with WordPress API

### Learnings
- Using `urllib.request` instead of `requests` to avoid external dependency
- `_post()` helper centralizes error handling and JSON parsing
- `check_conflicts()` returns empty list on WordPress unavailable for graceful degradation
- CLI includes `list` subcommand for debugging active claims
- Environment variable `WORDPRESS_TRACK_URL` allows custom WordPress URL

### Task 1.4 Complete
- CLI interface was already implemented in Task 1.3 (argparse with `check` and `list` subcommands)
- Fixed exit code behavior: `check_conflicts()` now raises `WordPressUnavailableError` instead of swallowing it
- Exit codes verified: 0=no conflict, 1=conflict, 2=WordPress unavailable
- Added docstring update noting `WordPressUnavailableError` is raised for CLI handling

### Task 1.5 Complete - POC Checkpoint
- End-to-end claim/release cycle verified:
  1. `TrackManager().claim('test-track', ['test/path/'], 'test-agent')` -> success=True, claim_id=8251
  2. Claim appeared in `list_active()` output
  3. `TrackManager().release('test-track', 'test-agent')` -> success=True
  4. Claim removed from `list_active()` output
- WordPress admin accessible at localhost:8080 (requires auth for UI)
- Verify command passes: `python3 -c "from wordpress_zone.track_manager import TrackManager; m=TrackManager(); print('OK' if m.claim('e2e-test',['e2e/'],'test')['success'] else 'FAIL')"` -> OK

### POC Phase Complete
All 5 POC tasks verified working. Core claim/release cycle validated end-to-end.

### Task 2.1 Complete - Error Handling
- Added input validation to all track handlers with detailed missing field messages
- HTTP status codes implemented:
  - 200: Success
  - 400: Missing/invalid required fields
  - 403: Agent ID mismatch (forbidden)
  - 404: No claim found
  - 409: Track already claimed or file conflict
  - 410: Claim expired (gone)
  - 500: Internal server error
- Consistent error format: `{"success": false, "error": "..."}`
- Edge cases handled:
  - Release non-existent claim: returns success with informative message (idempotent)
  - Release already trashed claim: returns success (idempotent)
  - Heartbeat on expired claim: returns 410 Gone with last_heartbeat info
  - Empty files array: returns 400 Bad Request
- All handlers have PHPDoc comments documenting status codes

### Learnings
- Idempotent release behavior prevents unnecessary error states
- Empty string check (`empty()`) catches both missing and blank fields
- HTTP status codes make API behavior explicit for clients

### Task 2.2 Complete - TrackManager Error Handling
- Added `socket` import for timeout handling
- Enhanced `_post()` method with comprehensive exception handling:
  - `socket.timeout`: Raises `WordPressUnavailableError` with timeout message
  - `URLError`: Raises `WordPressUnavailableError` with URL details
  - `HTTPError`: Returns structured error dict with `success: false` and `error` key
  - `json.JSONDecodeError`: Raises `TrackManagerError` for invalid JSON
  - Generic `Exception`: Catch-all wrapped in `TrackManagerError`
- All HTTP errors now return structured error dicts with `success` and `error` keys
- All public methods have complete docstrings with Args, Returns, and Raises sections
- Verify command passes: `TrackManager('http://invalid:9999').claim('x',[],'y')` raises `WordPressUnavailableError`

### Learnings
- `socket.timeout` is not a subclass of `URLError`, must be caught separately
- HTTPError responses can contain JSON error data that should be parsed and returned
- Structured error format `{"success": false, "error": "..."}` enables graceful client handling

### Task 2.3 Complete - Quality Checkpoint
- Python syntax verification: PASS (`python3 -m py_compile` succeeded)
- Lint check: SKIPPED (flake8 not installed, acceptable for POC per task spec)
- File compiles without syntax errors

### Verification: 2.3 [VERIFY] Quality checkpoint
- Status: PASS
- Commands:
  - `python3 -m py_compile wordpress_zone/track_manager.py` -> exit 0, "Syntax OK"
  - `python3 -m flake8` -> skipped (module not installed)
- Result: Python compiles without syntax errors

### Task 2.4 Complete - Visual Bridge Track Handlers
- Added `track_claim` handler in `handle_client()` switch statement
- Added `track_release` handler in `handle_client()` switch statement
- Broadcasts `TRACK_CLAIMED` event with track_id, agent_id, files, coordinates, timestamp
- Broadcasts `TRACK_RELEASED` event with track_id, agent_id, timestamp
- Handlers follow existing pattern (similar to `wordpress_publish` handler)
- Syntax verification passed: `python3 -m py_compile visual_bridge.py` -> OK

### Learnings
- Visual Bridge handlers follow switch-case pattern in `handle_client()` method
- Use `await self._broadcast({...})` to send events to all connected WebSocket clients
- Track coordinates derived from track_id (hash-based, consistent per track)
- Integration with existing ai-publisher.php `notify_visual_bridge()` function
