---
spec: desktop-agent-service
basePath: ./specs/desktop-agent-service
phase: design
task: 0/0
updated: 2026-02-21T23:45:00Z
---

# Progress: desktop-agent-service

## Original Goal

Unified AI agent service that can control local and remote desktops via WebMCP, with full mouse/keyboard/screen/clipboard control across Linux, Windows, macOS, and VNC/RDP. Integrates with existing systems/ai_gui/ infrastructure and WordPress Track Board for safety.

## Completed Tasks

- [x] 1.1 Create systems/desktop_agent/ package structure
- [x] 1.2 Extend BaseBackend with desktop control methods
- [x] 1.3 Implement SafetySanitizer with blocked lists

## Current Task

Task 1.4 - Implement LocalBackend with X11/xdotool support

## Learnings

1. **80% infrastructure exists** - VNCBackend (QEMU+websockify), ShotcutVMBridge (WebSocket VM control), WebMCP Bridge (100+ tools), Track Board safety
2. **Key pattern: ShotcutVMBridge** - WebSocket server with QMP input injection, SSH execution, screenshot capture - reusable for Desktop Agent
3. **WebMCP has shotcut_* tools** - 8 desktop control tools already registered: shotcut_status, shotcut_boot, shotcut_screenshot, shotcut_input, shotcut_type, shotcut_click, shotcut_exec
4. **Safety already built** - VNCBackend has BLOCKED_KEYS/BLOCKED_COMBOS, WebMCP has RateLimiter class
5. **Track Board provides multi-agent locking** - claim/heartbeat/release pattern for file-based coordination
6. **ASCII Desktop Control exists** - xdotool-based for Linux X11, but black-box issues with browsers/Electron
7. **Input sanitization pattern** - InputEvent dataclass with type (KEY/MOUSE/TEXT), modifiers, coordinates
8. **Backend abstraction** - BaseBackend interface: spawn(), send_input(), capture_frame(), terminate(), health_check()
9. **Visual Bridge is hub** - Port 8768 WebSocket, integrates with WordPress via port 8769 HTTP
10. **Quality commands**: make check, make lint, pytest systems/ai_gui/tests/

### Requirements Phase Learnings

11. **8 user stories defined** covering connect, input, screenshot, exec, clipboard, window management, safety, and rate limiting
12. **P0 scope narrowed** to LocalBackend (Linux), VNCBackend extension, and unified WebMCP namespace - RDP/macOS deferred to P1/P2
13. **Safety-critical priority** means Track Board integration is mandatory for all exec operations, not optional
14. **Wayland limitation** - xdotool incompatible, need pyautogui fallback with documented limitations
15. **10 WebMCP tools needed**: desktop_connect, desktop_disconnect, desktop_screenshot, desktop_input, desktop_type, desktop_click, desktop_exec, desktop_clipboard, desktop_list_windows, desktop_focus_window
16. **Conflict with existing shotcut_* tools** - new desktop_* namespace unified, shotcut_* can delegate to desktop_* internally
17. **Multi-session complexity** - up to 5 concurrent sessions requires careful resource tracking and cleanup
18. **Interview decisions** captured: speed over polish, high reliability required, macOS deferred, clipboard included

### Design Phase Learnings

19. **BaseBackend needs extension** - Add connect(), disconnect(), get_windows(), focus_window(), get_clipboard(), set_clipboard(), exec_command() to interface
20. **LocalBackend hybrid approach** - xdotool primary for X11 (most reliable), pyautogui fallback for Wayland
21. **Screenshot tools compared** - mss fastest for X11 (~30ms 1080p), grim for Wayland; no external deps for mss
22. **Rate limiting per-tool** - desktop_input: 100/min, desktop_exec: 10/min, desktop_screenshot: 60/min
23. **Track Board wrap pattern** - Async TrackBoardClient wraps sync TrackManager with background heartbeat loop
24. **Error code taxonomy** - TRACK_CONFLICT, RATE_LIMIT, BLOCKED_INPUT, BLOCKED_COMMAND, SESSION_NOT_FOUND, BACKEND_ERROR, WORDPRESS_UNAVAILABLE, WAYLAND_LIMITED, COMMAND_TIMEOUT
25. **10 implementation steps** identified: package structure, SafetySanitizer, LocalBackend, TrackBoardClient, SessionManager, DesktopAgentService, WebMCP tools, wiring, unit tests, integration tests

## Blockers

- None currently

## Next

Design complete. Run /ralph-specum:tasks to generate implementation task breakdown.

### Tasks Phase Learnings (2026-02-22)

26. **28 total tasks** across 5 phases: POC (13), Refactoring (5), Testing (6), Quality Gates (2), PR Lifecycle (5)
27. **Quality checkpoints inserted** at V1 (after POC tasks 1-11), V2 (after refactoring), V3 (after testing)
28. **WebMCP pattern reuse** - shotcut_* tools provide exact pattern for desktop_* namespace
29. **BaseBackend extensions** - 7 new abstract methods needed: connect, disconnect, get_windows, focus_window, get_clipboard, set_clipboard, exec_command
30. **Error code taxonomy** - 9 codes: TRACK_CONFLICT, RATE_LIMIT, BLOCKED_INPUT, BLOCKED_COMMAND, SESSION_NOT_FOUND, BACKEND_ERROR, WORDPRESS_UNAVAILABLE, WAYLAND_LIMITED, COMMAND_TIMEOUT
31. **WebSocket bridge on port 8770** - parallels Visual Bridge on 8768, routes WebMCP tool calls to Python service
32. **Test directory structure** - tests/test_desktop_agent/ with __init__.py, separate test files per component
33. **Coverage target >80%** for safety-critical paths (SafetySanitizer, TrackBoardClient)
34. **LocalBackend hybrid approach** - xdotool primary (X11), mss for screenshots (~30ms), wmctrl for windows
35. **Track Board heartbeat loop** - background task with 5-min interval, auto-release on disconnect
36. **SafetySanitizer order-independent combos** - BLOCKED_COMBOS uses tuple matching with `all(re.search(part, key_str))` so modifier order doesn't matter

