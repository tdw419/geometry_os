#!/bin/bash
#
# Geometry OS Pre-Commit Hook
# Runs linting, type checking, and quick tests before each commit
#

set -e

echo "=== Geometry OS Pre-Commit Checks ==="

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No staged files to check"
    exit 0
fi

# JavaScript/TypeScript checks
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|ts|jsx|tsx)$' || true)
if [ -n "$JS_FILES" ]; then
    echo ""
    echo "üì¶ Checking JavaScript/TypeScript files..."
    
    # ESLint
    if command -v eslint &> /dev/null; then
        echo "  Running ESLint..."
        echo "$JS_FILES" | xargs eslint --quiet --max-warnings=0 || {
            echo "‚ùå ESLint found issues"
            exit 1
        }
    fi
    
    # TypeScript check
    if [ -f "tsconfig.json" ]; then
        echo "  Running TypeScript check..."
        npx tsc --noEmit --incremental false || {
            echo "‚ùå TypeScript errors found"
            exit 1
        }
    fi
fi

# Python checks
PY_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' || true)
if [ -n "$PY_FILES" ]; then
    echo ""
    echo "üêç Checking Python files..."
    
    # Black format check
    if command -v black &> /dev/null; then
        echo "  Checking Black formatting..."
        black --check --quiet $PY_FILES || {
            echo "‚ùå Python formatting issues. Run: black $PY_FILES"
            exit 1
        }
    fi
    
    # Ruff linting
    if command -v ruff &> /dev/null; then
        echo "  Running Ruff linter..."
        ruff check $PY_FILES || {
            echo "‚ùå Ruff found issues"
            exit 1
        }
    fi
    
    # Type checking
    if command -v mypy &> /dev/null; then
        echo "  Running MyPy type check..."
        mypy $PY_FILES --ignore-missing-imports || {
            echo "‚ö†Ô∏è  MyPy warnings (non-blocking)"
        }
    fi
fi

# WebMCP bridge validation
WEBMCP_FILE="systems/visual_shell/web/webmcp_bridge.js"
if echo "$STAGED_FILES" | grep -q "$WEBMCP_FILE"; then
    echo ""
    echo "üîß Validating WebMCP Bridge..."
    
    # Check syntax
    node --check "$WEBMCP_FILE" || {
        echo "‚ùå WebMCP Bridge syntax error"
        exit 1
    }
    
    # Validate tool registration format
    node -e "
        const fs = require('fs');
        const content = fs.readFileSync('$WEBMCP_FILE', 'utf8');
        const toolCount = (content.match(/name:\s*['\"]/g) || []).length;
        console.log('  Found ' + toolCount + ' tool registrations');
        if (toolCount < 8) {
            console.error('  ‚ùå Expected at least 8 tools');
            process.exit(1);
        }
        console.log('  ‚úì WebMCP tools validated');
    " || exit 1
fi

# Quick test for critical paths
if echo "$STAGED_FILES" | grep -qE "(webmcp|pixel_cpu|infinite_map)"; then
    echo ""
    echo "üß™ Running quick tests..."
    
    # Just check test file syntax for now (full tests in CI)
    for test_file in systems/visual_shell/web/test_*.html; do
        if [ -f "$test_file" ]; then
            # Basic HTML validation
            if grep -q "</html>" "$test_file"; then
                echo "  ‚úì $test_file valid"
            fi
        fi
    done
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
exit 0
