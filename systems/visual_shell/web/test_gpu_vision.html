<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry OS - GPU Vision Test</title>
    <style>
        body {
            font-family: monospace;
            background: #111;
            color: #ddd;
            padding: 20px;
        }

        .log {
            background: #222;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #444;
        }

        .success {
            color: #8f8;
        }

        .error {
            color: #f88;
        }

        button {
            padding: 8px 16px;
            background: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
        }

        canvas {
            border: 1px solid #555;
            margin: 5px;
        }
    </style>
</head>

<body>
    <h1>Milestone 3: GPU Pattern Detection</h1>

    <button onclick="runTests()">Run Vision Pipeline</button>
    <div id="canvases"></div>
    <div id="log" class="log">Ready...</div>

    <script type="module">
        import { GPUPatternDetector } from './gpu_pattern_detector.js';

        async function runTests() {
            const logEl = document.getElementById('log');
            const log = (msg, type = '') => {
                logEl.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
                console.log(msg);
            };

            if (!navigator.gpu) {
                log("WebGPU not supported.", 'error');
                return;
            }

            try {
                const adapter = await navigator.gpu.requestAdapter();
                const device = await adapter.requestDevice();

                const detector = new GPUPatternDetector(device);
                await detector.initialize();
                log("Detector Initialized.", 'success');

                // 1. Create Test Image (Canvas)
                const canvas = document.createElement('canvas');
                canvas.width = 256;
                canvas.height = 256;
                const ctx = canvas.getContext('2d');

                // Draw shapes
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, 256, 256);

                ctx.fillStyle = 'white';
                ctx.fillRect(50, 50, 100, 100); // White box

                ctx.beginPath();
                ctx.arc(180, 180, 50, 0, Math.PI * 2); // White circle
                ctx.fill();

                document.getElementById('canvases').appendChild(canvas);
                log("Created Source Image (256x256)");

                // 2. Detect Edges
                log("Running Sobel Filter on GPU...");
                const start = performance.now();
                const outputTensor = await detector.detectEdges(canvas);
                const end = performance.now();
                log(`Detection took ${(end - start).toFixed(2)}ms (includes upload/download overhead)`, 'info');

                // 3. Visualize Output
                const resultData = await outputTensor.download();
                outputTensor.dispose(); // Free GPU memory

                // Render Float32 result to new canvas
                const outCanvas = document.createElement('canvas');
                outCanvas.width = 256;
                outCanvas.height = 256;
                const outCtx = outCanvas.getContext('2d');
                const outImgData = outCtx.createImageData(256, 256);

                let matches = 0;
                for (let i = 0; i < resultData.length; i++) {
                    const val = resultData[i]; // 0.0 or 1.0 (thresholded) or magnitude
                    const byteVal = Math.min(255, Math.max(0, val * 255));

                    if (val > 0.1) matches++;

                    outImgData.data[i * 4] = byteVal;     // R
                    outImgData.data[i * 4 + 1] = byteVal; // G
                    outImgData.data[i * 4 + 2] = byteVal; // B
                    outImgData.data[i * 4 + 3] = 255;     // Alpha
                }

                outCtx.putImageData(outImgData, 0, 0);
                document.getElementById('canvases').appendChild(outCanvas);

                log("Displayed Edge Map.", 'success');
                log(`Non-zero pixels (edges): ${matches}`, 'info');

                if (matches > 0) {
                    log("✅ Sobel Filter Success: Edges detected!", 'success');
                } else {
                    log("⚠️ Warning: No edges detected (check shader)", 'error');
                }

            } catch (e) {
                log(`Test Failed: ${e.message}`, 'error');
                console.error(e);
            }
        }

        window.runTests = runTests;
    </script>
</body>

</html>