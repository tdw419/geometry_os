<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase K: Neural Kernel Tools Test</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            line-height: 1.6;
        }
        h1 {
            color: #4ecca3;
            border-bottom: 2px solid #4ecca3;
            padding-bottom: 10px;
        }
        h2 {
            color: #9d8df1;
            margin-top: 30px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s, transform 0.1s;
        }
        button:hover {
            background: #3db892;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
        }
        .test-result {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .pass {
            background: #1e4d2b;
            border-left: 4px solid #4ecca3;
        }
        .fail {
            background: #4d1e1e;
            border-left: 4px solid #ff6b6b;
        }
        .pending {
            background: #2a2a4a;
            border-left: 4px solid #666;
        }
        .test-number {
            font-weight: bold;
            color: #9d8df1;
            min-width: 25px;
        }
        .test-status {
            font-weight: bold;
            min-width: 50px;
        }
        .pass .test-status { color: #4ecca3; }
        .fail .test-status { color: #ff6b6b; }
        .pending .test-status { color: #666; }
        .test-name {
            flex: 1;
        }
        .test-detail {
            color: #888;
            font-size: 11px;
            margin-top: 5px;
            padding-left: 35px;
        }
        #output {
            margin-top: 20px;
        }
        #summary {
            background: #16213e;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-value {
            font-size: 28px;
            font-weight: bold;
        }
        .summary-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }
        #total .summary-value { color: #9d8df1; }
        #passed .summary-value { color: #4ecca3; }
        #failed .summary-value { color: #ff6b6b; }
        #progress-bar {
            height: 6px;
            background: #2a2a4a;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        #progress-fill {
            height: 100%;
            background: #4ecca3;
            width: 0%;
            transition: width 0.3s ease;
        }
        .running {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <h1>Phase K: Neural Kernel Tools Test</h1>

    <div id="summary">
        <div class="summary-item" id="total">
            <div class="summary-value">12</div>
            <div class="summary-label">Total Tests</div>
        </div>
        <div class="summary-item" id="passed">
            <div class="summary-value">0</div>
            <div class="summary-label">Passed</div>
        </div>
        <div class="summary-item" id="failed">
            <div class="summary-value">0</div>
            <div class="summary-label">Failed</div>
        </div>
    </div>

    <div id="progress-bar">
        <div id="progress-fill"></div>
    </div>

    <div class="controls">
        <button id="runBtn" onclick="runAllTests()">Run All Tests</button>
        <button onclick="resetTests()">Reset</button>
    </div>

    <div id="output"></div>

    <script src="kernel_bridge.js"></script>
    <script>
        // Test state
        let passCount = 0;
        let failCount = 0;
        let currentTest = 0;
        const totalTests = 12;

        // Helper to update UI
        function updateSummary() {
            document.querySelector('#passed .summary-value').textContent = passCount;
            document.querySelector('#failed .summary-value').textContent = failCount;
            document.querySelector('#progress-fill').style.width = `${((passCount + failCount) / totalTests) * 100}%`;
        }

        // Helper to output test result
        function outputTest(num, name, passed, detail = '') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <span class="test-number">#${num}</span>
                <span class="test-status">${passed ? 'PASS' : 'FAIL'}</span>
                <span class="test-name">${name}</span>
            `;
            if (detail) {
                div.innerHTML += `<div class="test-detail">${detail}</div>`;
            }
            output.appendChild(div);

            if (passed) {
                passCount++;
            } else {
                failCount++;
            }
            updateSummary();
        }

        // Test assertion helper
        function assert(condition, message) {
            if (!condition) {
                throw new Error(message || 'Assertion failed');
            }
        }

        // Reset test environment
        function resetTests() {
            window.kernelBridge.clear();
            document.getElementById('output').innerHTML = '';
            passCount = 0;
            failCount = 0;
            currentTest = 0;
            updateSummary();
            document.getElementById('runBtn').disabled = false;
        }

        // Test 1: kernel_list returns empty list initially
        async function test_kernelListEmpty() {
            window.kernelBridge.clear();
            const result = await window.kernelBridge.listKernels();
            assert(result.success === true, 'listKernels should succeed');
            assert(result.total === 0, 'Should have 0 kernels initially');
            assert(Array.isArray(result.kernels), 'kernels should be an array');
            assert(result.kernels.length === 0, 'kernels array should be empty');
            return 'Empty kernel list verified';
        }

        // Test 2: kernel_register creates hybrid kernel
        async function test_kernelRegisterCreatesKernel() {
            const result = await window.kernelBridge.createKernel(
                'test-neural-kernel',
                'neural',
                true,
                '1.0.0',
                ['neural', 'test'],
                true
            );
            assert(result.success === true, 'createKernel should succeed');
            assert(result.kernel.name === 'test-neural-kernel', 'Kernel name should match');
            assert(result.kernel.type === 'neural', 'Kernel type should be neural');
            assert(result.kernel.gpuEnabled === true, 'GPU should be enabled');
            assert(result.kernel.version === '1.0.0', 'Version should match');
            return `Created kernel: ${result.kernel.name} (type: ${result.kernel.type}, gpu: ${result.kernel.gpuEnabled})`;
        }

        // Test 3: kernel_list shows registered kernel
        async function test_kernelListShowsKernel() {
            const result = await window.kernelBridge.listKernels();
            assert(result.success === true, 'listKernels should succeed');
            assert(result.total === 1, 'Should have 1 kernel');
            assert(result.kernels[0].name === 'test-neural-kernel', 'Kernel name should match');
            assert(result.active === 'test-neural-kernel', 'Active kernel should be set');
            return `Found 1 kernel: ${result.kernels[0].name} (active: ${result.active})`;
        }

        // Test 4: kernel_register creates second kernel
        async function test_kernelRegisterSecondKernel() {
            const result = await window.kernelBridge.createKernel(
                'compute-kernel',
                'compute',
                false,
                '2.0.0',
                ['compute', 'production'],
                false
            );
            assert(result.success === true, 'createKernel should succeed');
            assert(result.kernel.name === 'compute-kernel', 'Kernel name should match');
            assert(result.kernel.type === 'compute', 'Kernel type should be compute');
            assert(result.kernel.gpuEnabled === false, 'GPU should be disabled');

            const list = await window.kernelBridge.listKernels();
            assert(list.total === 2, 'Should have 2 kernels');
            return `Created second kernel: ${result.kernel.name}, total kernels: ${list.total}`;
        }

        // Test 5: kernel_swap changes active kernel
        async function test_kernelSwapChangesActive() {
            const result = await window.kernelBridge.swapKernel('compute-kernel');
            assert(result.success === true, 'swapKernel should succeed');
            assert(result.previousKernel === 'test-neural-kernel', 'Previous kernel should be correct');
            assert(result.activeKernel === 'compute-kernel', 'Active kernel should be compute-kernel');
            return `Swapped from ${result.previousKernel} to ${result.activeKernel}`;
        }

        // Test 6: kernel_list shows correct active kernel
        async function test_kernelListShowsActive() {
            const result = await window.kernelBridge.listKernels();
            assert(result.success === true, 'listKernels should succeed');
            assert(result.active === 'compute-kernel', 'Active should be compute-kernel');

            const activeKernel = result.kernels.find(k => k.name === 'compute-kernel');
            assert(activeKernel !== undefined, 'compute-kernel should exist');
            assert(activeKernel.state === 'active', 'compute-kernel should be active');

            return `Active kernel: ${result.active}`;
        }

        // Test 7: kernel_health returns health status
        async function test_kernelHealthStatus() {
            const result = await window.kernelBridge.healthCheck('compute-kernel');
            assert(result.success === true, 'healthCheck should succeed');
            assert(result.name === 'compute-kernel', 'Kernel name should match');
            assert(result.healthy === true, 'Kernel should be healthy');
            assert(result.status === 'healthy', 'Status should be healthy');
            return `Health check for ${result.name}: healthy=${result.healthy}, status=${result.status}`;
        }

        // Test 8: kernel_health (all) returns all kernels
        async function test_kernelHealthAll() {
            const result = await window.kernelBridge.healthCheck(null);
            assert(result.success === true, 'healthCheck should succeed');
            assert(result.total === 2, 'Should have 2 kernels');
            assert(result.healthy === 2, 'All kernels should be healthy');
            assert(result.unhealthy === 0, 'No unhealthy kernels');
            assert(Array.isArray(result.kernels), 'kernels should be an array');
            assert(result.kernels.length === 2, 'kernels array should have 2 items');
            return `All kernels healthy: ${result.healthy}/${result.total}`;
        }

        // Test 9: kernel_metrics returns performance data
        async function test_kernelMetrics() {
            const result = await window.kernelBridge.getMetrics(null);
            assert(result.success === true, 'getMetrics should succeed');
            assert(result.totalKernels === 2, 'Should have 2 kernels');
            assert(result.activeKernel === 'compute-kernel', 'Active kernel should be compute-kernel');
            assert(result.metrics['compute-kernel'] !== undefined, 'Should have metrics for compute-kernel');
            assert(result.metrics['test-neural-kernel'] !== undefined, 'Should have metrics for test-neural-kernel');

            const computeMetrics = result.metrics['compute-kernel'];
            assert(typeof computeMetrics.useCount === 'number', 'useCount should be a number');
            assert(typeof computeMetrics.uptime === 'number', 'uptime should be a number');

            return `Metrics for ${result.totalKernels} kernels, swap history: ${result.swapHistoryLength}`;
        }

        // Test 10: Rollback to previous kernel
        async function test_kernelRollback() {
            const result = await window.kernelBridge.rollback();
            assert(result.success === true, 'rollback should succeed');
            assert(result.previousKernel === 'compute-kernel', 'Previous should be compute-kernel');
            assert(result.activeKernel === 'test-neural-kernel', 'Active should be test-neural-kernel');

            const list = await window.kernelBridge.listKernels();
            assert(list.active === 'test-neural-kernel', 'Active in list should match');

            return `Rolled back from ${result.previousKernel} to ${result.activeKernel}`;
        }

        // Test 11: kernel_swap to non-existent fails gracefully
        async function test_kernelSwapNonExistent() {
            const result = await window.kernelBridge.swapKernel('non-existent-kernel');
            assert(result.success === false, 'swapKernel should fail');
            assert(result.error !== undefined, 'Should have error message');
            assert(result.error.includes('not found'), 'Error should mention not found');

            // Verify active kernel unchanged
            const list = await window.kernelBridge.listKernels();
            assert(list.active === 'test-neural-kernel', 'Active kernel should be unchanged');

            return `Correctly rejected non-existent kernel: ${result.error}`;
        }

        // Test 12: kernel_register duplicate name fails
        async function test_kernelRegisterDuplicate() {
            const result = await window.kernelBridge.createKernel(
                'test-neural-kernel',
                'neural',
                true
            );
            assert(result.success === false, 'createKernel should fail');
            assert(result.error !== undefined, 'Should have error message');
            assert(result.error.includes('already exists'), 'Error should mention already exists');

            return `Correctly rejected duplicate: ${result.error}`;
        }

        // All tests array
        const tests = [
            { name: 'kernel_list returns empty list initially', fn: test_kernelListEmpty },
            { name: 'kernel_register creates hybrid kernel', fn: test_kernelRegisterCreatesKernel },
            { name: 'kernel_list shows registered kernel', fn: test_kernelListShowsKernel },
            { name: 'kernel_register creates second kernel', fn: test_kernelRegisterSecondKernel },
            { name: 'kernel_swap changes active kernel', fn: test_kernelSwapChangesActive },
            { name: 'kernel_list shows correct active kernel', fn: test_kernelListShowsActive },
            { name: 'kernel_health returns health status', fn: test_kernelHealthStatus },
            { name: 'kernel_health (all) returns all kernels', fn: test_kernelHealthAll },
            { name: 'kernel_metrics returns performance data', fn: test_kernelMetrics },
            { name: 'Rollback to previous kernel', fn: test_kernelRollback },
            { name: 'kernel_swap to non-existent fails gracefully', fn: test_kernelSwapNonExistent },
            { name: 'kernel_register duplicate name fails', fn: test_kernelRegisterDuplicate },
        ];

        // Run all tests
        async function runAllTests() {
            const runBtn = document.getElementById('runBtn');
            runBtn.disabled = true;
            runBtn.classList.add('running');

            // Reset environment
            window.kernelBridge.clear();
            document.getElementById('output').innerHTML = '';
            passCount = 0;
            failCount = 0;
            updateSummary();

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                const testNum = i + 1;

                try {
                    const detail = await test.fn();
                    outputTest(testNum, test.name, true, detail);
                } catch (error) {
                    outputTest(testNum, test.name, false, error.message);
                }

                // Small delay for visual feedback
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            runBtn.disabled = false;
            runBtn.classList.remove('running');

            // Final summary
            console.log(`\n=== Test Results ===`);
            console.log(`Passed: ${passCount}/${totalTests}`);
            console.log(`Failed: ${failCount}/${totalTests}`);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            updateSummary();
        });
    </script>
</body>
</html>
