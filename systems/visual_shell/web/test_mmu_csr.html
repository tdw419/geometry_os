<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMU CSR Register Tests</title>
    <style>
        body {
            background: #111;
            color: #eee;
            font-family: 'Courier New', monospace;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 { color: #4a9; border-bottom: 2px solid #4a9; padding-bottom: 10px; }
        h2 { color: #8b4; margin-top: 30px; }
        .test-controls { margin: 20px 0; }
        button {
            background: #234;
            color: #fff;
            border: 1px solid #4a9;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            border-radius: 4px;
        }
        button:hover { background: #345; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid;
            background: #222;
        }
        .test-result.pass { border-color: #4a9; }
        .test-result.pass::before { content: '[PASS] '; color: #4a9; font-weight: bold; }
        .test-result.fail { border-color: #f44; }
        .test-result.fail::before { content: '[FAIL] '; color: #f44; font-weight: bold; }
        .test-result.info { border-color: #aa4; }
        .test-result.info::before { content: '[INFO] '; color: #aa4; font-weight: bold; }
        #results {
            margin-top: 20px;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #333;
            min-height: 100px;
        }
        .progress {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .progress.pending { background: #666; }
        .progress.running { background: #ea0; animation: pulse 0.5s infinite; }
        .progress.pass { background: #4a9; }
        .progress.fail { background: #f44; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .test-summary {
            margin-top: 20px;
            padding: 15px;
            background: #2a2a2a;
            border: 1px solid #444;
        }
        .stats { display: flex; gap: 20px; margin-top: 10px; }
        .stat { display: flex; flex-direction: column; }
        .stat-label { font-size: 11px; color: #888; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .stat-total .stat-value { color: #fff; }
        .stat-passed .stat-value { color: #4a9; }
        .stat-failed .stat-value { color: #f44; }
    </style>
</head>
<body>
    <h1>WGPU MMU - CSR Register Tests</h1>
    <p>Testing RISC-V CSR (Control and Status Registers) for Memory Management Unit support</p>

    <div class="test-controls">
        <button id="btnRunAll" onclick="runAllTests()">Run All Tests</button>
        <button id="btnTest1" onclick="runTest(1)">Test 1: CSR Registers</button>
        <button id="btnTest2" onclick="runTest(2)">Test 2: Halt Location</button>
        <button id="btnTest3" onclick="runTest(3)">Test 3: Extended State Size</button>
        <button id="btnTest4" onclick="runTest(4)">Test 4: CSR Instruction Encoding</button>
        <button id="btnTest5" onclick="runTest(5)">Test 5: CSR Instruction Execution</button>
        <button id="btnClear" onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <div class="test-summary" id="summary" style="display: none;">
        <h3>Test Summary</h3>
        <div class="stats">
            <div class="stat stat-total">
                <span class="stat-label">Total</span>
                <span class="stat-value" id="statTotal">0</span>
            </div>
            <div class="stat stat-passed">
                <span class="stat-label">Passed</span>
                <span class="stat-value" id="statPassed">0</span>
            </div>
            <div class="stat stat-failed">
                <span class="stat-label">Failed</span>
                <span class="stat-value" id="statFailed">0</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { testCSRRegisters, testCSRHaltLocation, testExtendedStateSize, testCSRRWInstruction, testCSRExecution }
            from './tests/test_mmu_csr.js';

        const results = document.getElementById('results');
        const summary = document.getElementById('summary');
        let testStats = { total: 0, passed: 0, failed: 0 };

        function addResult(status, message) {
            const div = document.createElement('div');
            div.className = `test-result ${status}`;
            div.textContent = message;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = testStats.total;
            document.getElementById('statPassed').textContent = testStats.passed;
            document.getElementById('statFailed').textContent = testStats.failed;
            summary.style.display = 'block';
        }

        async function runTest(num) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);

            const indicator = document.createElement('span');
            indicator.className = 'progress running';
            const buttonId = `btnTest${num}`;
            const btn = document.getElementById(buttonId);
            if (btn) btn.insertBefore(indicator, btn.firstChild);

            try {
                addResult('info', `Starting Test ${num}...`);

                if (num === 1) {
                    await testCSRRegisters();
                    addResult('pass', 'Test 1: CSR Registers - CSR fields exist in state');
                    testStats.passed++;
                } else if (num === 2) {
                    await testCSRHaltLocation();
                    addResult('pass', 'Test 2: Halt Location - Halted flag at correct index');
                    testStats.passed++;
                } else if (num === 3) {
                    await testExtendedStateSize();
                    addResult('pass', 'Test 3: Extended State - State buffer is 39 u32s');
                    testStats.passed++;
                } else if (num === 4) {
                    await testCSRRWInstruction();
                    addResult('pass', 'Test 4: CSR Instruction Encoding - CSRRW/CSRRS encoding verified');
                    testStats.passed++;
                } else if (num === 5) {
                    await testCSRExecution();
                    addResult('pass', 'Test 5: CSR Instruction Execution - CSRRW executes correctly');
                    testStats.passed++;
                }

                testStats.total++;
            } catch (e) {
                addResult('fail', `Test ${num} failed: ${e.message}`);
                console.error(e);
                testStats.total++;
                testStats.failed++;
            } finally {
                if (indicator && indicator.parentNode) {
                    indicator.className = testStats.failed > (testStats.total - testStats.passed - testStats.failed) ? 'progress fail' : 'progress pass';
                }
                buttons.forEach(b => b.disabled = false);
                updateStats();
            }
        }

        async function runAllTests() {
            clearResults();
            addResult('info', 'Running all MMU CSR tests...');

            await runTest(1);
            await runTest(2);
            await runTest(3);
            await runTest(4);
            await runTest(5);

            addResult('info', `All tests complete. Passed: ${testStats.passed}/${testStats.total}`);
        }

        function clearResults() {
            results.innerHTML = '';
            testStats = { total: 0, passed: 0, failed: 0 };
            updateStats();
            document.querySelectorAll('.progress').forEach(p => p.remove());
        }

        // Export to window for onclick handlers
        window.runAllTests = runAllTests;
        window.runTest = runTest;
        window.clearResults = clearResults;

        // Auto-check WebGPU support
        if (!navigator.gpu) {
            addResult('fail', 'WebGPU not supported in this browser');
            document.querySelectorAll('button').forEach(b => b.disabled = true);
        } else {
            addResult('info', 'WebGPU available. Ready to run tests.');
        }
    </script>
</body>
</html>
