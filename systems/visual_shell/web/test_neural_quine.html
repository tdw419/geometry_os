<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry OS: Neural Quine - Self-Hosting Evolution</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #0f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: #00ffff;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .panel {
            background: #111;
            border: 1px solid #0f0;
            padding: 15px;
            border-radius: 5px;
        }

        .panel h2 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #0ff;
        }

        #evolutionCanvas {
            display: block;
            image-rendering: pixelated;
            width: 256px;
            height: 256px;
            border: 1px solid #0f0;
            background: #000;
        }

        .stats {
            min-width: 200px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #222;
        }

        .stat-label {
            opacity: 0.7;
        }

        .stat-value {
            color: #0ff;
        }

        .fitness-bar {
            width: 100%;
            height: 10px;
            border: 1px solid #0f0;
            margin-top: 10px;
            background: #000;
        }

        .fitness-fill {
            height: 100%;
            background: linear-gradient(90deg, #f00, #ff0, #0f0);
            width: 0%;
            transition: width 0.1s;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            padding: 10px;
            background: #222;
            border: 1px solid #0f0;
            color: #0f0;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #0f0;
            color: #000;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log {
            width: 100%;
            max-width: 600px;
            height: 150px;
            background: #000;
            border: 1px solid #0f0;
            padding: 10px;
            overflow-y: auto;
            font-size: 0.8rem;
            margin-top: 20px;
        }

        .log-entry {
            padding: 2px 0;
        }

        .log-entry.info {
            color: #0ff;
        }

        .log-entry.success {
            color: #0f0;
        }

        .log-entry.header {
            color: #ff0;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .status-badge.stopped {
            background: #f00;
            color: #fff;
        }

        .status-badge.running {
            background: #0f0;
            color: #000;
        }

        .status-badge.complete {
            background: #00f;
            color: #fff;
        }
    </style>
</head>

<body>
    <h1>Neural Quine: Self-Hosting Evolution</h1>
    <div class="subtitle">Shared Reality Protocol | The Screen is the Hard Drive</div>

    <div class="container">
        <div class="panel">
            <h2>
                Evolution Canvas
                <span id="statusBadge" class="status-badge stopped">STOPPED</span>
            </h2>
            <canvas id="evolutionCanvas" width="32" height="32"></canvas>

            <div class="controls">
                <button id="startBtn">START</button>
                <button id="stopBtn" disabled>STOP</button>
                <button id="saveBtn" disabled>SAVE</button>
                <button id="resetBtn">RESET</button>
            </div>
        </div>

        <div class="panel" style="max-width: 300px;">
            <h2>LM Studio Director</h2>
            <div style="font-size: 0.8rem; margin-bottom: 10px; color: #aaa;">
                Recursive Improvement Loop
            </div>
            <textarea id="lmPrompt"
                style="width: 100%; height: 60px; background: #222; color: #fff; border: 1px solid #555; padding: 5px;"
                placeholder="Enter command (e.g. 'Build a WASM module')"></textarea>
            <button id="askLmBtn" style="width: 100%; margin-top: 5px;">DIRECT EVOLUTION</button>
            <div id="lmThought"
                style="margin-top: 10px; font-size: 0.8rem; color: #ff0; font-style: italic; min-height: 40px;"></div>
        </div>

        <div class="panel stats">
            <h2>Statistics</h2>
            <div class="stat">
                <span class="stat-label">Generation:</span>
                <span id="genValue" class="stat-value">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">Fitness:</span>
                <span id="fitnessValue" class="stat-value">0.00</span>
            </div>
            <div class="stat">
                <span class="stat-label">Best Fitness:</span>
                <span id="bestFitnessValue" class="stat-value">0.00</span>
            </div>
            <div class="stat">
                <span class="stat-label">Population:</span>
                <span id="popValue" class="stat-value">50</span>
            </div>
            <div class="stat">
                <span class="stat-label">Target:</span>
                <span class="stat-value">WASM_HEADER</span>
            </div>
            <div class="fitness-bar">
                <div id="fitnessFill" class="fitness-fill"></div>
            </div>
        </div>
    </div>

    <div id="log" class="log"></div>

    <script src="js/evolution_engine.js"></script>
    <script src="js/lm_studio_director.js"></script>
    <script src="js/ace_visual_bridge.js"></script>
    <script src="js/aspirational_layer.js"></script>
    <script>
        // DOM Elements
        const canvas = document.getElementById('evolutionCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const saveBtn = document.getElementById('saveBtn');
        const resetBtn = document.getElementById('resetBtn');

        // LM Studio Elements
        const lmPrompt = document.getElementById('lmPrompt');
        const askLmBtn = document.getElementById('askLmBtn');
        const lmThought = document.getElementById('lmThought');

        const statusBadge = document.getElementById('statusBadge');
        const genValue = document.getElementById('genValue');
        const fitnessValue = document.getElementById('fitnessValue');
        const bestFitnessValue = document.getElementById('bestFitnessValue');
        const fitnessFill = document.getElementById('fitnessFill');
        const log = document.getElementById('log');

        // Evolution Engine
        let engine = null;
        let bestFitness = 0;

        // Logging
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Initialize engine
        function initEngine() {
            engine = new VisualEvolutionEngine({
                gridSize: 32,
                populationSize: 50,
                mutationRate: 0.08
            });

            // Register evolution callback
            engine.onEvolution((event) => {
                if (event.type === 'step') {
                    // Update canvas with genome pixels
                    const imageData = event.imageData;
                    ctx.putImageData(imageData, 0, 0);

                    // Update stats
                    genValue.textContent = event.generation;
                    fitnessValue.textContent = event.fitness.toFixed(2);

                    // Track best fitness
                    if (event.fitness > bestFitness) {
                        bestFitness = event.fitness;
                        bestFitnessValue.textContent = bestFitness.toFixed(2);
                    }

                    // Update fitness bar (normalize to ~60000 target)
                    const fitnessPercent = Math.min(100, (event.fitness / 60000) * 100);
                    fitnessFill.style.width = `${fitnessPercent}%`;

                    // Log header discovery
                    if (event.fitness >= 1000 && event.fitness < 1100) {
                        addLog(`Valid WASM header discovered at gen ${event.generation}!`, 'header');
                    }
                } else if (event.type === 'complete') {
                    addLog(`EVOLUTION COMPLETE! Final fitness: ${event.fitness.toFixed(2)}`, 'success');
                    stopEvolution();
                }
            });

            // Initial render
            const initialGenome = engine.population[0];
            const initialImageData = engine.genomeToImageData(initialGenome);
            ctx.putImageData(initialImageData, 0, 0);

            addLog('Neural Quine initialized - Ready to evolve', 'success');
        }

        // Start evolution
        function startEvolution() {
            if (!engine) return;

            engine.start();
            statusBadge.textContent = 'RUNNING';
            statusBadge.className = 'status-badge running';
            startBtn.disabled = true;
            stopBtn.disabled = false;
            saveBtn.disabled = false;
            resetBtn.disabled = true;

            addLog('Evolution started...', 'info');
        }

        // Stop evolution
        function stopEvolution() {
            if (!engine) return;

            engine.stop();
            statusBadge.textContent = 'STOPPED';
            statusBadge.className = 'status-badge stopped';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            resetBtn.disabled = false;

            addLog('Evolution paused', 'info');
        }

        // Reset evolution
        function resetEvolution() {
            if (!engine) return;

            engine.stop();
            bestFitness = 0;
            bestFitnessValue.textContent = '0.00';
            genValue.textContent = '0';
            fitnessValue.textContent = '0.00';
            fitnessFill.style.width = '0%';

            initEngine();

            addLog('Evolution reset', 'info');
        }

        // Save best organism
        function saveOrganism() {
            if (!engine || !engine.bestOrganism) {
                addLog('No evolved organism to save yet', 'info');
                return;
            }

            const dataUrl = engine.saveOrganism(engine.bestOrganism);
            const link = document.createElement('a');
            link.download = `neural_quine_gen_${engine.generation}.rts.png`;
            link.href = dataUrl;
            link.click();

            addLog(`Saved: neural_quine_gen_${engine.generation}.rts.png`, 'success');
        }

        // Initialize ACE Layers
        let director = null;
        let aceBridge = null;
        let aspirationalLayer = null;

        // Event listeners
        startBtn.addEventListener('click', startEvolution);
        stopBtn.addEventListener('click', stopEvolution);
        resetBtn.addEventListener('click', resetEvolution);
        saveBtn.addEventListener('click', saveOrganism);

        // ACE Telemetry Listener
        window.addEventListener('ace-telemetry', (e) => {
            const detail = e.detail;
            if (detail.type === 'TASK_STARTED') {
                addLog(`ACE Task Started: ${detail.data.target}`, 'header');
            }
        });

        askLmBtn.addEventListener('click', async () => {
            if (!engine) initEngine();

            // Lazy Init Stack
            if (!aceBridge) aceBridge = new AceVisualBridge(engine);
            if (!director) director = new LMStudioDirector(engine);
            if (!aspirationalLayer) aspirationalLayer = new AspirationalLayer();

            const request = lmPrompt.value;
            if (!request) return;

            askLmBtn.disabled = true;
            lmThought.textContent = "⚖️ Aspirational Layer: Validating directive...";

            // STEP 1: Aspirational Review
            const judgment = await aspirationalLayer.validateDirective(request);

            if (!judgment.allowed) {
                // REJECTED
                lmThought.style.color = "#f00";
                lmThought.textContent = `❌ BLOCKED: ${judgment.reason}`;
                addLog(`Aspirational Layer blocked request: "${request}"`, 'stopped');
                askLmBtn.disabled = false;
                return;
            }

            lmThought.style.color = "#ff0";
            lmThought.textContent = `✅ Approved: Sending to Global Strategy...`;

            // STEP 2: Global Strategy (LM Studio)
            // The Director acts as the interface to the brain
            const thought = await director.prompt(request);

            // STEP 3: Execution
            aceBridge.emitTelemetry("STRATEGY_DECISION", {
                thought: thought,
                aspirational_score: judgment.scores
            });

            lmThought.textContent = thought;
            askLmBtn.disabled = false;

            addLog(`ACE Directive Executing: "${request}"`, 'header');

            // Update visual status
            startEvolution();
        });

        // Initialize on load
        window.addEventListener('load', () => {
            if (typeof VisualEvolutionEngine !== 'undefined') {
                initEngine();
            } else {
                addLog('ERROR: VisualEvolutionEngine not loaded', 'info');
                statusBadge.textContent = 'ERROR';
            }
        });
    </script>
</body>

</html>