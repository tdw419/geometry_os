<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural City Shader Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #0a0a0f;
            color: #e0e0e0;
        }
        #status {
            padding: 20px;
            border-radius: 8px;
            background: #1a1a2e;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        .success { border-color: #00ff88 !important; color: #00ff88; }
        .error { border-color: #ff4444 !important; color: #ff4444; }
        #canvas {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 8px;
        }
        .info {
            font-size: 14px;
            color: #888;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Neural City Shader Test</h1>
    <div id="status">Initializing WebGPU...</div>
    <canvas id="canvas"></canvas>
    <div class="info">
        This test validates the neural_city.wgsl procedural building shader.
    </div>

    <script type="module">
        async function test() {
            const status = document.getElementById('status');
            const canvas = document.getElementById('canvas');

            try {
                // Check WebGPU support
                if (!navigator.gpu) {
                    status.textContent = 'WebGPU not supported - please use Chrome/Edge with WebGPU enabled';
                    status.classList.add('error');
                    return;
                }

                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    status.textContent = 'No WebGPU adapter found';
                    status.classList.add('error');
                    return;
                }

                const device = await adapter.requestDevice();
                status.textContent = 'WebGPU initialized - Adapter: ' + adapter.info.architecture;
                status.classList.add('success');

                // Configure context
                const context = canvas.getContext('webgpu');
                const format = navigator.gpu.getPreferredCanvasFormat();
                context.configure({
                    device,
                    format,
                    alphaMode: 'premultiplied',
                });

                // Load shader
                const shaderCode = await fetch('../shaders/neural_city.wgsl').then(r => r.text());
                const shaderModule = device.createShaderModule({ code: shaderCode });

                // Check for compilation errors
                const compilationInfo = await shaderModule.getCompilationInfo();
                if (compilationInfo.messages.length > 0) {
                    console.log('Shader compilation messages:');
                    for (const msg of compilationInfo.messages) {
                        console.log(`  ${msg.lineNum}:${msg.linePos} - ${msg.message}`);
                    }
                }

                status.textContent = 'Shader compiled successfully - WebGPU ready for neural city rendering';
                status.classList.add('success');

                // Create uniform buffer
                const uniformBuffer = device.createBuffer({
                    size: 16, // 4 floats * 4 bytes
                    usage: GPUBufferUsage.UNIFORM | GPUBufferUsage.COPY_DST,
                });

                // Create test building data
                const buildingData = new Float32Array([
                    0.0, 0.0, 50.0, 0.8, 0.0,  // Building 1: pos(0,0), height=50, activity=0.8, district=cognitive
                    10.0, 5.0, 35.0, 0.6, 1.0,  // Building 2: pos(10,5), height=35, activity=0.6, district=metabolic
                    -8.0, -12.0, 60.0, 0.9, 2.0,  // Building 3: pos(-8,-12), height=60, activity=0.9, district=substrate
                ]);

                const buildingBuffer = device.createBuffer({
                    size: buildingData.byteLength,
                    usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_DST,
                    mappedAtCreation: true,
                });
                new Float32Array(buildingBuffer.getMappedRange()).set(buildingData);
                buildingBuffer.unmap();

                // Create render pipeline (simplified test)
                const pipeline = device.createRenderPipeline({
                    layout: 'auto',
                    vertex: {
                        module: shaderModule,
                        entryPoint: 'vertex_main',
                    },
                    fragment: {
                        module: shaderModule,
                        entryPoint: 'fragment_main',
                        targets: [{ format }],
                    },
                    primitive: {
                        topology: 'triangle-list',
                    },
                });

                console.log('Neural City shader test pipeline created successfully');
                console.log('Buildings buffer size:', buildingData.length / 4, 'buildings');

            } catch (error) {
                status.textContent = 'Error: ' + error.message;
                status.classList.add('error');
                console.error('WebGPU test failed:', error);
            }
        }

        test();
    </script>
</body>
</html>
