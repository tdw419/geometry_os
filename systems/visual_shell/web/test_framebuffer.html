<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry OS: Framebuffer Integration Test</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }

        #app-container {
            width: 100%;
            height: 100%;
        }

        #test-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00AAFF;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            min-width: 300px;
        }

        #test-controls h2 {
            margin-top: 0;
            color: #00AAFF;
            font-size: 16px;
        }

        .test-button {
            background-color: #00AAFF;
            color: #000;
            border: none;
            padding: 8px 16px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            width: 100%;
        }

        .test-button:hover {
            background-color: #00CCFF;
        }

        .test-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #test-output {
            margin-top: 15px;
            background-color: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 10px;
            color: #00FF00;
        }

        #test-output .success {
            color: #00FF00;
        }

        #test-output .error {
            color: #FF0000;
        }

        #test-output .warning {
            color: #FFFF00;
        }

        #test-output .info {
            color: #00AAFF;
        }

        #performance-stats {
            margin-top: 10px;
            font-size: 11px;
            color: #FFFFFF;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }

        .stat-label {
            color: #AAAAAA;
        }

        .stat-value {
            color: #00FF00;
            font-weight: bold;
        }
    </style>
    <!-- PixiJS -->
    <script src="https://pixijs.download/v8.1.0/pixi.min.js"></script>

    <!-- Geometry OS Modules -->
    <script src="pixel_cpu.js"></script>
    <script src="pixel_cpu_integration.js"></script>
    <script src="test_framebuffer_integration.js"></script>
</head>

<body>
    <div id="app-container"></div>

    <div id="test-controls">
        <h2>üß™ Framebuffer Integration Tests</h2>

        <button id="run-all-tests" class="test-button">Run All Tests</button>
        <button id="run-single-test" class="test-button">Run Single Test</button>
        <button id="clear-output" class="test-button">Clear Output</button>

        <div id="performance-stats">
            <div class="stat-row">
                <span class="stat-label">Last Update Time:</span>
                <span class="stat-value" id="stat-last-update">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Avg Update Time:</span>
                <span class="stat-value" id="stat-avg-update">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Dirty Rects:</span>
                <span class="stat-value" id="stat-dirty-rects">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Resolution:</span>
                <span class="stat-value" id="stat-resolution">--</span>
            </div>
        </div>

        <div id="test-output"></div>
    </div>

    <script>
        // Global variables
        let app = null;
        let testRunner = null;
        let pixelCPUIntegration = null;
        let updateInterval = null;

        // Initialize PixiJS
        async function initializeApp() {
            app = new PIXI.Application({
                resizeTo: window,
                backgroundColor: 0x111111,
                antialias: true,
                resolution: window.devicePixelRatio || 1,
                autoDensity: true
            });
            document.getElementById('app-container').appendChild(app.view);

            log('info', '‚úÖ PixiJS initialized');
        }

        // Log to test output
        function log(type, message) {
            const output = document.getElementById('test-output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type.toLowerCase();

            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        // Clear test output
        function clearOutput() {
            document.getElementById('test-output').innerHTML = '';
        }

        // Update performance stats display
        function updatePerformanceStats() {
            if (!pixelCPUIntegration) return;

            const stats = pixelCPUIntegration.getPerformanceStats();
            const resolution = pixelCPUIntegration.getFramebufferResolution();
            const dirtyRects = pixelCPUIntegration.cpu.getDirtyRects();

            document.getElementById('stat-last-update').textContent =
                stats.lastFramebufferUpdateTime.toFixed(3) + 'ms';
            document.getElementById('stat-avg-update').textContent =
                (stats.framebufferUpdateCount > 0 ?
                    (stats.lastFramebufferUpdateTime / stats.framebufferUpdateCount).toFixed(3) : '--') + 'ms';
            document.getElementById('stat-dirty-rects').textContent = dirtyRects.length;
            document.getElementById('stat-resolution').textContent =
                `${resolution.width}x${resolution.height}`;
        }

        // Run all tests
        async function runAllTests() {
            const button = document.getElementById('run-all-tests');
            button.disabled = true;

            try {
                log('info', 'üß™ Starting Framebuffer Integration Tests...\n');

                // Create test runner
                testRunner = new FramebufferIntegrationTest();

                // Run all tests
                const results = await testRunner.runAllTests();

                // Display results
                const passed = results.filter(r => r.passed).length;
                const total = results.length;

                if (passed === total) {
                    log('success', `\n‚úÖ All tests passed! (${passed}/${total})`);
                } else {
                    log('error', `\n‚ùå Some tests failed (${passed}/${total} passed)`);
                }

                // Start performance monitoring
                startPerformanceMonitoring();
            } catch (error) {
                log('error', `‚ùå Test suite failed: ${error.message}`);
                console.error(error);
            } finally {
                button.disabled = false;
            }
        }

        // Run single test (interactive demo)
        async function runSingleTest() {
            const button = document.getElementById('run-single-test');
            button.disabled = true;

            try {
                log('info', 'üß™ Starting Interactive Demo...\n');

                // Initialize if not already done
                if (!pixelCPUIntegration) {
                    // Create mock infinite map
                    const infiniteMap = {
                        world: new PIXI.Container(),
                        app: app
                    };

                    // Create PixelCPUIntegration
                    pixelCPUIntegration = new PixelCPUIntegration(infiniteMap, {
                        framebufferWidth: 640,
                        framebufferHeight: 480,
                        cyclesPerFrame: 1000
                    });

                    // Create framebuffer
                    pixelCPUIntegration.createFramebufferTexture();

                    log('success', '‚úÖ PixelCPUIntegration initialized');
                }

                // Run a simple demo - draw random pixels
                log('info', 'Drawing random pixels to framebuffer...');

                const cpu = pixelCPUIntegration.cpu;
                const fbBase = cpu.framebufferBase;

                // Draw 1000 random pixels
                for (let i = 0; i < 1000; i++) {
                    const x = Math.floor(Math.random() * 640);
                    const y = Math.floor(Math.random() * 480);
                    const offset = (y * 640 + x) * 4;

                    cpu.writeMemory(fbBase + offset, Math.floor(Math.random() * 256));     // R
                    cpu.writeMemory(fbBase + offset + 1, Math.floor(Math.random() * 256)); // G
                    cpu.writeMemory(fbBase + offset + 2, Math.floor(Math.random() * 256)); // B
                    cpu.writeMemory(fbBase + offset + 3, 255);                            // A
                }

                // Update framebuffer
                const startTime = performance.now();
                pixelCPUIntegration.updateFramebuffer();
                const updateTime = performance.now() - startTime;

                log('success', `‚úÖ Drew 1000 pixels, updated in ${updateTime.toFixed(3)}ms`);
                log('info', `Dirty rectangles tracked: ${cpu.getDirtyRects().length}`);

                // Start performance monitoring
                startPerformanceMonitoring();
            } catch (error) {
                log('error', `‚ùå Demo failed: ${error.message}`);
                console.error(error);
            } finally {
                button.disabled = false;
            }
        }

        // Start performance monitoring
        function startPerformanceMonitoring() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }

            updateInterval = setInterval(() => {
                if (pixelCPUIntegration) {
                    // Draw a few random pixels
                    const cpu = pixelCPUIntegration.cpu;
                    const fbBase = cpu.framebufferBase;

                    for (let i = 0; i < 10; i++) {
                        const x = Math.floor(Math.random() * 640);
                        const y = Math.floor(Math.random() * 480);
                        const offset = (y * 640 + x) * 4;

                        cpu.writeMemory(fbBase + offset, Math.floor(Math.random() * 256));
                        cpu.writeMemory(fbBase + offset + 1, Math.floor(Math.random() * 256));
                        cpu.writeMemory(fbBase + offset + 2, Math.floor(Math.random() * 256));
                        cpu.writeMemory(fbBase + offset + 3, 255);
                    }

                    // Update framebuffer
                    pixelCPUIntegration.updateFramebuffer();

                    // Update stats display
                    updatePerformanceStats();
                }
            }, 16); // ~60 FPS
        }

        // Event listeners
        document.getElementById('run-all-tests').addEventListener('click', runAllTests);
        document.getElementById('run-single-test').addEventListener('click', runSingleTest);
        document.getElementById('clear-output').addEventListener('click', clearOutput);

        // Initialize on load
        window.addEventListener('load', async () => {
            await initializeApp();
            log('info', 'üöÄ Ready to run framebuffer integration tests');
            log('info', 'Click "Run All Tests" to start the test suite');
            log('info', 'Click "Run Single Test" for an interactive demo\n');
        });
    </script>
</body>

</html>