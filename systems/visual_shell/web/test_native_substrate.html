<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry OS: Native Substrate Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border: 1px solid #00ff88;
            font-size: 12px;
            z-index: 1000;
            max-width: 400px;
        }

        #blinking-tile {
            position: absolute;
            width: 100px;
            height: 100px;
            background: #ff0000;
            border: 2px solid #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            transition: background-color 0.1s ease;
        }

        .tile-label {
            text-align: center;
            line-height: 1.2;
        }
    </style>
</head>

<body>
    <div id="status">
        <div>Geometry OS: Native Substrate Test</div>
        <div id="kernel-status">Initializing...</div>
        <div id="tick-count">Ticks: 0</div>
        <div id="counter-value">Counter: 0</div>
    </div>

    <div id="blinking-tile">
        <div class="tile-label">
            RTS CPU<br />
            <span id="tile-counter">0</span>
        </div>
    </div>

    <!-- Load PixiJS -->
    <script src="lib/pixi.min.js"></script>
    <script src="lib/pixi-ui.min.js"></script>
    <script src="lib/typed-signals.min.js"></script>

    <!-- Load Geometry OS Components -->
    <script src="pixi_adapter.js"></script>
    <script src="application.js"></script>
    <script src="compute_integration.js"></script>

    <script>
        // Global test variables
        let kernelCounter = 0;
        let tickCount = 0;
        let computeSystem = null;

        async function initTest() {
            console.log("üöÄ Starting Native Substrate Test...");

            try {
                // Initialize PixiJS Application
                const app = new PIXI.Application();
                await app.init({
                    resizeTo: window,
                    backgroundColor: 0x000000,
                    antialias: true,
                    resolution: window.devicePixelRatio || 1,
                    autoDensity: true,
                    preference: 'webgpu' // Force WebGPU
                });

                document.body.appendChild(app.canvas);

                // Initialize Compute System
                computeSystem = new ComputeIntegrationSystem(app);

                // Position the blinking tile
                const tile = document.getElementById('blinking-tile');
                tile.style.left = '50px';
                tile.style.top = '100px';

                // Boot the test kernel immediately
                console.log("üîå Booting test kernel...");
                await computeSystem.bootKernel('lib/pixi_runtime.rts.png', 'test_kernel');

                updateStatus("Kernel booted successfully!", "green");

                // Start the main loop
                app.ticker.add((delta) => {
                    // Tick the compute system
                    computeSystem.tick();
                    tickCount++;

                    // Read memory to get counter value (simplified - in real impl we'd read from buffer)
                    // For demo, we'll simulate a counter increment
                    kernelCounter = (kernelCounter + 1) % 256;

                    // Update tile color based on counter
                    updateTileColor(kernelCounter);

                    // Update status
                    document.getElementById('tick-count').textContent = `Ticks: ${tickCount}`;
                    document.getElementById('counter-value').textContent = `Counter: ${kernelCounter}`;
                    document.getElementById('tile-counter').textContent = kernelCounter;
                });

            } catch (error) {
                console.error("‚ùå Test failed:", error);
                updateStatus(`Error: ${error.message}`, "red");
            }
        }

        function updateStatus(message, color = "white") {
            const statusDiv = document.getElementById('kernel-status');
            statusDiv.textContent = message;
            statusDiv.style.color = color;
        }

        function updateTileColor(counter) {
            const tile = document.getElementById('blinking-tile');

            // Map counter (0-255) to hue (0-360)
            const hue = (counter / 255) * 360;

            // Create HSL color
            tile.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;

            // Add some pulsing effect
            const intensity = 0.7 + 0.3 * Math.sin(counter * 0.1);
            tile.style.opacity = intensity;
        }

        // Start test when page loads
        window.addEventListener('load', initTest);

        // Handle WebGPU availability
        if (!navigator.gpu) {
            updateStatus("WebGPU not available - falling back to WebGL", "orange");
        }
    </script>
</body>

</html>