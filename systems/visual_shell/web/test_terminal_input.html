<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry OS - Phase 50.1: Terminal Keyboard Input</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #0a0a1a;
            color: #00ccff;
            font-family: 'Segoe UI', 'Fira Code', monospace;
            padding: 20px;
            margin: 0;
        }
        h1 { font-size: 1.4rem; margin-bottom: 5px; }
        h2 { font-size: 1rem; color: #00ff88; margin: 20px 0 10px; }
        .subtitle { font-size: 0.8rem; color: #666; margin-bottom: 20px; }

        .layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        .sidebar {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-y: auto;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }
        .status.connected { background: #1a3a2a; color: #00ff88; }
        .status.disconnected { background: #3a2a1a; color: #ffaa00; }
        .status.error { background: #3a1a1a; color: #ff6666; }

        .terminal-display {
            background: #0a0a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            height: 100%;
            overflow-y: auto;
            cursor: text;
        }

        .terminal-display:focus {
            outline: 2px solid #00ccff;
            outline-offset: -2px;
        }

        .terminal-line {
            margin: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .terminal-prompt { color: #00ff88; }
        .terminal-input { color: #00ccff; }
        .terminal-output { color: #aaa; }
        .terminal-error { color: #ff6666; }

        .key-indicator {
            display: inline-block;
            background: #1a1a3e;
            padding: 2px 8px;
            border-radius: 3px;
            margin: 2px;
            font-size: 12px;
            border: 1px solid #333;
        }

        .key-indicator.active {
            background: #00ccff;
            color: #000;
        }

        button {
            background: linear-gradient(180deg, #1a3a4a 0%, #0a2a3a 100%);
            color: #00ccff;
            border: 1px solid #00ccff;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            width: 100%;
            margin: 5px 0;
        }
        button:hover { background: linear-gradient(180deg, #2a4a5a 0%, #1a3a4a 100%); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .help-text {
            font-size: 11px;
            color: #666;
            margin-top: 10px;
            line-height: 1.5;
        }

        #keystroke-log {
            background: #0a0a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-size: 11px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 2px;
        }
        .log-entry.send { background: #1a2a1a; }
        .log-entry.receive { background: #1a1a2a; }
    </style>
</head>
<body>
    <h1>⌨️ Phase 50.1: Terminal Keyboard Input</h1>
    <div class="subtitle">Real-time keyboard capture for on-map terminal</div>

    <div class="layout">
        <div class="sidebar">
            <div class="status" id="status">Checking connection...</div>

            <h2>Connection</h2>
            <button id="connectBtn" onclick="toggleConnection()">Connect</button>
            <button id="newTermBtn" onclick="createTerminal()" disabled>+ New Terminal</button>

            <h2>Terminal</h2>
            <div id="terminal-info">
                <div>Active: <span id="activeTerminal">None</span></div>
            </div>

            <h2>Keystroke Log</h2>
            <div id="keystroke-log"></div>

            <div class="help-text">
                <strong>How to use:</strong><br>
                1. Click Connect to link to Python backend<br>
                2. Click in the terminal area to focus<br>
                3. Type on keyboard - keystrokes are sent live<br>
                4. Press Enter to execute command<br>
                <br>
                <strong>Start the backend:</strong><br>
                <code>python3 map_terminal.py</code>
            </div>
        </div>

        <div class="terminal-display" id="terminal" tabindex="0">
            <div class="terminal-line">
                <span class="terminal-prompt">$</span>
                <span class="terminal-input" id="input-line">_</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { TerminalInputClient } from './terminal_input_client.js';

        let client = null;
        let currentInput = '';
        let outputLines = [];

        const statusEl = document.getElementById('status');
        const terminalEl = document.getElementById('terminal');
        const inputLineEl = document.getElementById('input-line');
        const keystrokeLogEl = document.getElementById('keystroke-log');
        const connectBtn = document.getElementById('connectBtn');
        const newTermBtn = document.getElementById('newTermBtn');
        const activeTerminalEl = document.getElementById('activeTerminal');

        function updateStatus(status) {
            statusEl.textContent = status === 'connected' ? '✓ Connected to backend'
                                 : status === 'disconnected' ? '○ Disconnected'
                                 : '✗ Connection error';
            statusEl.className = 'status ' + status;
            connectBtn.textContent = status === 'connected' ? 'Disconnect' : 'Connect';
            newTermBtn.disabled = status !== 'connected';
        }

        function logKeystroke(direction, message) {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + direction;
            entry.textContent = `${direction === 'send' ? '→' : '←'} ${message}`;
            keystrokeLogEl.appendChild(entry);
            keystrokeLogEl.scrollTop = keystrokeLogEl.scrollHeight;

            // Keep only last 50 entries
            while (keystrokeLogEl.children.length > 50) {
                keystrokeLogEl.removeChild(keystrokeLogEl.firstChild);
            }
        }

        function renderTerminal() {
            let html = '';

            // Output lines
            for (const line of outputLines) {
                html += `<div class="terminal-line ${line.type}">${escapeHtml(line.text)}</div>`;
            }

            // Current input line
            html += `<div class="terminal-line">
                <span class="terminal-prompt">$</span>
                <span class="terminal-input">${escapeHtml(currentInput)}<span class="cursor">_</span></span>
            </div>`;

            terminalEl.innerHTML = html;
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;');
        }

        function handleOutput(content, terminalId) {
            if (content) {
                outputLines.push({ type: 'terminal-output', text: content });
                if (outputLines.length > 100) {
                    outputLines = outputLines.slice(-100);
                }
                renderTerminal();
            }
            activeTerminalEl.textContent = `Terminal #${terminalId}`;
            logKeystroke('receive', `Output: ${content?.substring(0, 50)}...`);
        }

        window.toggleConnection = async function() {
            if (client && client.connected) {
                client.disconnect();
                return;
            }

            client = new TerminalInputClient({
                port: 8767,
                targetElement: terminalEl,
                onOutput: handleOutput,
                onStatusChange: updateStatus
            });

            try {
                await client.connect();
                logKeystroke('receive', 'Connected to terminal backend');

                // Override sendKey to log
                const origSendKey = client.sendKey.bind(client);
                client.sendKey = (key, mods) => {
                    logKeystroke('send', `Key: ${key}`);
                    origSendKey(key, mods);
                };

            } catch (e) {
                updateStatus('error');
                logKeystroke('receive', `Error: ${e.message}`);
            }
        };

        window.createTerminal = function() {
            if (client && client.connected) {
                client.createTerminal();
                logKeystroke('send', 'New terminal request');
            }
        };

        // Local keyboard handling for demo (when not connected)
        terminalEl.addEventListener('keydown', (e) => {
            // If connected, TerminalInputClient handles it
            if (client && client.connected) return;

            // Local demo mode
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'Enter') {
                outputLines.push({ type: 'terminal-output', text: `$ ${currentInput}` });
                outputLines.push({ type: 'terminal-output', text: '[Demo mode - connect to backend for real execution]' });
                currentInput = '';
                e.preventDefault();
            } else if (e.key === 'Backspace') {
                currentInput = currentInput.slice(0, -1);
                e.preventDefault();
            } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                currentInput += e.key;
                e.preventDefault();
            }

            renderTerminal();
        });

        // Focus terminal on click
        terminalEl.addEventListener('click', () => {
            terminalEl.focus();
        });

        // Initial render
        renderTerminal();
        updateStatus('disconnected');
    </script>
</body>
</html>
