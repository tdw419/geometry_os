<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural City - Geometry OS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a1a;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        #app { width: 100vw; height: 100vh; }
        #hud {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 20, 40, 0.8);
            padding: 15px;
            border: 1px solid #0ff;
            border-radius: 8px;
            color: #0ff;
            font-size: 12px;
            max-width: 300px;
            z-index: 100;
        }
        #hud h2 { color: #0ff; margin-bottom: 10px; font-size: 16px; }
        #hud .metric { margin: 5px 0; }
        #hud .value { color: #0f0; }
        #hud .label { color: #888; }
        #controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        button {
            background: #0ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-family: inherit;
            border-radius: 4px;
            font-weight: bold;
        }
        button:hover { background: #0aa; }
        button:active { background: #088; }
        #districts {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 20, 40, 0.8);
            padding: 15px;
            border: 1px solid #0ff;
            border-radius: 8px;
            color: #0ff;
            font-size: 12px;
            z-index: 100;
        }
        .district-item { margin: 5px 0; display: flex; align-items: center; gap: 8px; }
        .district-dot { width: 10px; height: 10px; border-radius: 50%; }
        .cognitive-dot { background: #00aaff; }
        .metabolic-dot { background: #ff8800; }
        .substrate-dot { background: #00ff88; }

        /* Glass Box Styles */
        .glass-box-overlay h2 { color: #0ff; margin: 0 0 10px 0; }
        .glass-box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #0ff; padding-bottom: 10px; }
        .close-btn { background: #f44; border: none; color: white; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
        .close-btn:hover { background: #d44; }
        .agent-id { color: #888; font-family: monospace; }
        .data-section { margin-bottom: 20px; padding: 10px; background: rgba(0, 50, 100, 0.3); border-radius: 5px; }
        .data-section h3 { color: #0ff; margin: 0 0 10px 0; font-size: 14px; }
        .live-indicator { color: #0f0; font-size: 10px; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .thought-item { font-size: 12px; margin: 5px 0; }
        .thought-item.type-inference { color: #0af; }
        .thought-item.type-action { color: #0f0; }
        .thought-item .time { color: #666; font-size: 10px; }
        .thought-item .arrow { color: #888; margin: 0 5px; }
        .metric { display: flex; align-items: center; gap: 10px; margin: 5px 0; }
        .metric label { width: 60px; color: #888; font-size: 11px; }
        .metric .bar { flex: 1; height: 10px; background: #333; border-radius: 5px; overflow: hidden; }
        .metric .bar div { height: 100%; background: linear-gradient(90deg, #0f0, #0ff); }
        .metric .value { color: #0f0; font-size: 11px; min-width: 60px; text-align: right; }
        .current-goal { margin-bottom: 10px; padding: 8px; background: rgba(0, 100, 200, 0.2); border-radius: 4px; }
        .current-goal strong { color: #0ff; }
        .trajectory ol { margin: 5px 0 0 20px; padding: 0; }
        .trajectory li { color: #888; font-size: 12px; margin: 3px 0; }
        .trajectory li.complete { color: #0f0; }
        .comm-item { font-size: 11px; margin: 5px 0; color: #888; }
        .comm-item .direction { color: #0ff; font-weight: bold; }
        .comm-item .target { color: #0af; }
        
        /* Substrate View Styling */
        .substrate-content { 
            margin-top: 10px; 
            border: 1px solid rgba(0, 255, 255, 0.3);
            background: #000;
            padding: 5px;
            border-radius: 4px;
        }
        .rts-preview {
            width: 100%;
            height: auto;
            max-height: 200px;
            object-fit: contain;
            image-rendering: pixelated; /* Essential for seeing code structure */
            display: block;
        }

        .control-bar { display: flex; gap: 5px; margin-top: 20px; flex-wrap: wrap; }
        .control-bar button { flex: 1; min-width: 80px; padding: 8px; font-size: 11px; background: #0ff; }
        .control-bar button:hover { background: #0aa; }
        .command-panel { display: flex; gap: 5px; margin-top: 10px; }
        .command-panel input { flex: 1; padding: 5px; background: #111; border: 1px solid #0ff; color: #0ff; border-radius: 4px; }
        .command-panel button { padding: 5px 10px; font-size: 11px; }
        .command-panel .btn-cancel { background: #666; }
        .command-panel .btn-cancel:hover { background: #444; }

        /* VCC Critical State Styling */
        .stability-alert {
            position: fixed;
            bottom: 60px;
            left: 10px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1001;
            display: none;
        }
        .stability-alert.visible {
            display: block;
            animation: alert-flash 1s ease-in-out infinite;
        }
        @keyframes alert-flash {
            0%, 100% { background: rgba(255, 0, 0, 0.9); }
            50% { background: rgba(255, 100, 0, 0.9); }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="hud">
        <h2>üèôÔ∏è Neural City</h2>
        <div class="metric"><span class="label">Buildings:</span> <span id="building-count" class="value">0</span></div>
        <div class="metric"><span class="label">Bridges:</span> <span id="bridge-count" class="value">0</span></div>
        <div class="metric"><span class="label">Spire IPC:</span> <span id="spire-ipc" class="value">0.50</span></div>
        <div class="metric"><span class="label">Throttle:</span> <span id="throttle-level" class="value">NONE</span></div>
        <div class="metric"><span class="label">Tectonic:</span> <span id="tectonic-status" class="value">Idle</span></div>
        <div class="metric"><span class="label">Status:</span> <span id="status" class="value">Initializing...</span></div>
    </div>
    <div id="districts">
        <h3>Districts</h3>
        <div class="district-item"><div class="district-dot cognitive-dot"></div> Cognitive</div>
        <div class="district-item"><div class="district-dot metabolic-dot"></div> Metabolic</div>
        <div class="district-item"><div class="district-dot substrate-dot"></div> Substrate</div>
    </div>
    <div id="controls">
        <button id="btn-spawn">Spawn Agent</button>
        <button id="btn-pulse">Pulse District</button>
        <button id="btn-saccade">Scan (Saccade)</button>
        <button id="btn-bridge">Create Bridge</button>
        <button id="btn-connect">Connect WS</button>
    </div>

    <!-- VCC Stability Alert HUD -->
    <div id="stability-alert" class="stability-alert">
        ‚ö†Ô∏è <span id="alert-agent">Agent</span>: PAS <span id="alert-pas">0.00</span>
        <button onclick="this.parentElement.classList.remove('visible')">Dismiss</button>
    </div>

    <script src="https://pixijs.download/v8.1.0/pixi.min.js"></script>
    <script src="js/TelemetryBus.js"></script>
    <script src="js/CityOrchestrator.js"></script>
    <script src="js/NeuralCityEngine.js"></script>
    <script src="js/MockAgentData.js"></script>
    <script src="js/GlassBoxOverlay.js"></script>
    <script src="js/AgentDataPanel.js"></script>
    <script src="js/AgentController.js"></script>
    <script>
        // Initialize PixiJS
        const app = new PIXI.Application();
        app.init({ background: 0x0a0a1a, resizeTo: window }).then(() => {
            document.getElementById('app').appendChild(app.canvas);

            // Create Neural City Engine
            const engine = new NeuralCityEngine({
                app: app,
                container: app.stage,
                wsUrl: 'ws://localhost:8768'
            });

            // Start engine
            engine.start().then(() => {
                document.getElementById('status').textContent = 'Running';

                // Demo: Spawn some initial buildings
                for (let i = 0; i < 5; i++) {
                    engine.telemetryBus.emit('agent_spawn', {
                        agent_id: `demo-agent-${i}`,
                        role: ['cognitive', 'metabolic', 'substrate'][i % 3],
                        metrics: { memory: 100 + i * 50, activity: Math.random() }
                    });
                }
            });

            // Update HUD
            setInterval(() => {
                const state = engine.getState();
                document.getElementById('building-count').textContent = state.buildings;
                document.getElementById('bridge-count').textContent = state.bridges;
                document.getElementById('spire-ipc').textContent = state.spire.ipc.toFixed(2);
                document.getElementById('throttle-level').textContent = state.spire.throttleLevel;
                document.getElementById('tectonic-status').textContent = 
                    state.spire.tectonicActive ? 'Active' : 'Idle';
            }, 1000);

            // Button handlers
            document.getElementById('btn-spawn').onclick = () => {
                const id = 'agent-' + Date.now();
                const roles = ['cognitive', 'metabolic', 'substrate'];
                engine.telemetryBus.emit('agent_spawn', {
                    agent_id: id,
                    role: roles[Math.floor(Math.random() * 3)],
                    metrics: { memory: 100 + Math.random() * 200, activity: Math.random() }
                });
            };

            document.getElementById('btn-pulse').onclick = () => {
                const districts = ['cognitive', 'metabolic', 'substrate'];
                engine.orchestrator.pulseDistrict(districts[Math.floor(Math.random() * 3)]);
            };

            document.getElementById('btn-saccade').onclick = () => {
                const id = engine.orchestrator.getRandomBuildingId();
                if (id) {
                    engine.triggerSaccade(id);
                }
            };

            // Auto-trigger random saccades for "living system" feel
            setInterval(() => {
                if (Math.random() < 0.3) { // 30% chance every 2s
                    const id = engine.orchestrator.getRandomBuildingId();
                    if (id) {
                        engine.triggerSaccade(id);
                    }
                }
            }, 2000);

            document.getElementById('btn-bridge').onclick = () => {
                const buildings = Array.from(engine.orchestrator.buildings.keys());
                if (buildings.length >= 2) {
                    const from = buildings[Math.floor(Math.random() * buildings.length)];
                    const to = buildings[Math.floor(Math.random() * buildings.length)];
                    if (from !== to) {
                        engine.telemetryBus.emit('agent_comm', {
                            from: from,
                            to: to,
                            event_type: ['llm_inference', 'system_command', 'evolution_event'][Math.floor(Math.random() * 3)]
                        });
                    }
                }
            };

            document.getElementById('btn-connect').onclick = async () => {
                const btn = document.getElementById('btn-connect');
                if (!engine.telemetryBus.isConnected()) {
                    btn.textContent = 'Connecting...';
                    try {
                        await engine.telemetryBus.connect();
                    } catch (e) {
                        console.warn('Connection failed:', e);
                    }
                }
                const connected = engine.telemetryBus.isConnected();
                btn.textContent = connected ? 'Connected' : 'Connect WS';
                document.getElementById('status').textContent = connected ? 'Connected' : 'Disconnected';
            };

            // Check for critical stability and show alert
            setInterval(() => {
                const critical = engine.orchestrator.getCriticalBuildings();
                const alertEl = document.getElementById('stability-alert');

                if (critical.length > 0) {
                    const agent = critical[0];
                    document.getElementById('alert-agent').textContent = agent.id;
                    document.getElementById('alert-pas').textContent = agent.stability.pas.toFixed(2);
                    alertEl.classList.add('visible');
                    console.warn(`‚ö†Ô∏è VCC CRITICAL: ${agent.id} PAS=${agent.stability.pas.toFixed(2)}`);
                } else {
                    alertEl.classList.remove('visible');
                }
            }, 2000);

            // Add periodic stability fluctuation for demo
            setInterval(() => {
                const buildings = Array.from(engine.orchestrator.buildings.values());
                if (buildings.length > 0) {
                    const random = buildings[Math.floor(Math.random() * buildings.length)];
                    const newPas = 0.3 + Math.random() * 0.7; // Random 0.3-1.0
                    engine.orchestrator.updateStability(random.id, newPas);
                    engine._updateBuildingRender(random);
                }
            }, 5000);
        }).catch(err => {
            console.error('PixiJS init failed:', err);
            document.getElementById('status').textContent = 'Error: ' + err.message;
        });
    </script>
</body>
</html>
