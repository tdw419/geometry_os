# Progress: ASCII WP Plugin

## Original Goal
Create a WordPress plugin for ASCII desktop control that provides:
- Live ASCII visualization of the desktop in admin dashboard
- Directive posting interface for dispatching tasks to the daemon
- Execution log viewer showing AI responses
- Settings page for daemon configuration (LLM endpoint, polling interval)

## Status
- Research: COMPLETE
- Requirements: COMPLETE
- Design: COMPLETE
- Tasks: COMPLETE
- Implementation: IN_PROGRESS (Phase 1)

## Completed Tasks
- [x] 1.1 Create plugin directory structure and main plugin file - feat(wp): create ASCII Desktop Control plugin scaffold
- [x] 1.2 Create ASCII_View shell exec wrapper class - feat(wp): add ASCII_View shell exec wrapper
- [x] 1.3 Create Directive_API class with CPT CRUD - feat(wp): add Directive_API with CPT CRUD
- [x] 1.4 Create Daemon_Status class with pgrep and caching - feat(wp): add Daemon_Status with pgrep and caching
- [x] 1.5 Register directive CPT in main plugin file - feat(wp): register directive custom post type
- [x] 1.7 Register settings via Settings API - feat(wp): register plugin settings via Settings API
- [x] 1.8 Implement AJAX handlers in main class - feat(wp): add AJAX handlers for ASCII view and directives

## Current Task
Awaiting next task (1.6 or 1.9)

## Learnings (Design Phase)
- admin-ajax.php pattern used (matches lmstudio-logs.php)
- CPT + post_meta for directive storage (no custom tables)
- Shell exec with DISPLAY=:0 for Python scripts
- 30s transient cache for daemon status
- Rate limiting via transient (1 req/sec for ASCII view)
- Duplicate prevention: block same title while pending
- Log retention: 30 days default, configurable
- No daemon auto-restart (manual control)

## Learnings (Task Planning Phase)
- 21 total tasks across 5 phases
- Phase 1 (POC): Core infrastructure - plugin scaffold, shell exec wrappers, CPT, AJAX handlers
- Phase 2 (Admin UI): Templates for control/settings/logs pages, JS polling, CSS dark theme
- Phase 3 (Polish): Rate limiting, admin bar link, activation hooks
- Dependency chain: ASCII_View -> AJAX handler -> JS polling -> UI render
- Python scripts located at .gemini/skills/ascii-desktop-control/scripts/ (hardcoded for POC)
- Verification strategy: PHP syntax checks, grep for key patterns, file existence checks
- Security verification: grep for check_ajax_referer and current_user_can calls
- File count target: 9 files total (1 main, 3 includes, 3 admin templates, 2 assets)

## Learnings (Implementation Phase)
- Python script output format: "--- ASCII MAP ---" header, ASCII content, "--- BINDINGS ---" header, JSON
- ASCII header line contains WINDOW ID, SIZE, MODE (x11/screenshot)
- Project root is 5 levels up from includes directory
- PHP shell_exec alternative: proc_open for timeout control
- Directive_API includes full CRUD: create, get, get_recent, get_logs, update_status, delete
- Status filtering via WP_Query meta_query
- Date range filtering via WP_Query date_query
- Search filtering via WP_Query 's' parameter
- get_status_counts() utility for dashboard widgets
- cleanup_old_logs() for retention policy enforcement
- Daemon_Status uses pgrep -f for process matching (matches directive_daemon.py)
- Transient caching with 30s TTL avoids excessive shell exec calls
- get_status() returns array: running (bool), last_check (mysql), pid (int|null)

## Learnings (Implementation Phase - Task 1.5)
- register_post_type() with public=>false, show_ui=>true for admin-only CPT
- Meta box hooked via add_meta_boxes_{post_type} action for specificity
- save_post_{post_type} hook for saving meta with nonce verification
- Status dropdown: pending/processing/completed/failed (matches Directive_API)
- Result textarea for storing AI response output

## Learnings (Verification Phase - Task 1.6)
- PHP syntax check ran via Docker Alpine container (php83-cli)
- All 4 PHP files passed syntax validation
- Files verified: ascii-desktop-control.php, class-ascii-view.php, class-daemon-status.php, class-directive-api.php
- Bracket balance verification: all braces, parentheses, brackets matched

## Learnings (Implementation Phase - Task 1.7)
- 7 settings registered via Settings API with sanitization callbacks
- Settings: ascii_polling_interval (1-60s), ascii_grid_width (40-200), ascii_grid_height (10-60)
- LLM settings: ascii_llm_endpoint (URL), ascii_llm_model (text)
- Operational settings: ascii_log_retention_days (1-365), ascii_daemon_enabled (bool)
- Sanitization uses range clamping with max/min for integers
- URL sanitization uses esc_url_raw with HTTP/HTTPS scheme validation
- Boolean sanitization uses !empty() check

## Learnings (Implementation Phase - Task 1.8)
- 5 AJAX handlers registered via wp_ajax_ action hooks
- Each handler uses check_ajax_referer() for nonce verification with 'ascii_control_nonce'
- Each handler uses current_user_can('manage_options') for capability check
- wp_send_json_success() / wp_send_json_error() for standardized JSON responses
- Parameters extracted via $_POST with sanitize_text_field() / sanitize_textarea_field()
- Daemon_Status also loaded in includes and exposed via get_daemon_status() method
- Force refresh parameter for daemon status via 'force' => 'true' POST parameter

## Next
Task 1.6 or 1.9: Quality checkpoint
