---
phase: 10-remote-catalog-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/visual_shell/web/DesktopObjectManager.js
  - systems/visual_shell/web/CatalogFilterBar.js
  - systems/visual_shell/web/demo_desktop_objects.html
autonomous: true

must_haves:
  truths:
    - "User sees all containers (local and remote) in unified catalog view"
    - "User can filter to show only local containers"
    - "User can filter to show only remote containers"
    - "User can filter to show all containers"
    - "Filter selection persists across catalog refresh"
  artifacts:
    - path: "systems/visual_shell/web/CatalogFilterBar.js"
      provides: "Filter UI component with source filter buttons"
      min_lines: 80
    - path: "systems/visual_shell/web/DesktopObjectManager.js"
      provides: "Filter state management and object visibility control"
      contains: "setSourceFilter"
  key_links:
    - from: "CatalogFilterBar.js"
      to: "DesktopObjectManager"
      via: "setSourceFilter callback"
      pattern: "onFilterChange"
    - from: "DesktopObjectManager"
      to: "RTSDesktopObject instances"
      via: "visible property toggle"
      pattern: "\\.visible\\s*="
---

<objective>
Implement hybrid catalog view with source filtering (RCAT-02).

Purpose: Users can filter the unified catalog view to show all containers, only local containers, or only remote containers.

Output: Filter bar UI and visibility filtering logic in DesktopObjectManager.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing components
@systems/visual_shell/web/DesktopObjectManager.js
@systems/visual_shell/web/demo_desktop_objects.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CatalogFilterBar component</name>
  <files>systems/visual_shell/web/CatalogFilterBar.js</files>
  <action>
Create a new CatalogFilterBar class that provides source filtering UI:

```javascript
// CatalogFilterBar.js - Filter bar for catalog source filtering
//
// Features:
// - Three filter buttons: All, Local, Remote
// - Visual indication of active filter
// - Callback when filter changes
// - ES6 export + window attachment pattern

class CatalogFilterBar {
    static FILTERS = {
        ALL: 'all',
        LOCAL: 'local',
        REMOTE: 'remote'
    };

    constructor(options = {}) {
        this.container = null;
        this.activeFilter = CatalogFilterBar.FILTERS.ALL;
        this.onFilterChange = options.onFilterChange || (() => {});
        this.counts = { all: 0, local: 0, remote: 0 };
        this._createUI();
    }

    // Create the filter bar DOM structure
    _createUI() {
        this.container = document.createElement('div');
        this.container.id = 'catalog-filter-bar';
        this.container.style.cssText = `
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            align-items: center;
        `;

        // Label
        const label = document.createElement('span');
        label.textContent = 'Filter:';
        label.style.cssText = 'color: #888; font-size: 12px; margin-right: 8px;';
        this.container.appendChild(label);

        // Create filter buttons
        for (const [name, value] of Object.entries(CatalogFilterBar.FILTERS)) {
            const btn = this._createButton(value, name);
            this.container.appendChild(btn);
            this[`btn${name}`] = btn;
        }

        // Set initial active state
        this._updateButtonStyles();
    }

    _createButton(filter, label) {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.dataset.filter = filter;
        btn.textContent = `${label} (0)`;
        btn.style.cssText = `
            background: #222;
            border: 1px solid #444;
            color: #888;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        `;
        btn.addEventListener('click', () => this.setFilter(filter));
        return btn;
    }

    setFilter(filter) {
        if (this.activeFilter === filter) return;
        this.activeFilter = filter;
        this._updateButtonStyles();
        this.onFilterChange(filter);
    }

    _updateButtonStyles() {
        for (const name of Object.keys(CatalogFilterBar.FILTERS)) {
            const btn = this[`btn${name}`];
            const isActive = this.activeFilter === CatalogFilterBar.FILTERS[name];
            btn.style.background = isActive ? '#00ffff' : '#222';
            btn.style.color = isActive ? '#000' : '#888';
            btn.style.borderColor = isActive ? '#00ffff' : '#444';
        }
    }

    updateCounts(local, remote) {
        this.counts.local = local;
        this.counts.remote = remote;
        this.counts.all = local + remote;

        this.btnAll.textContent = `All (${this.counts.all})`;
        this.btnLocal.textContent = `Local (${this.counts.local})`;
        this.btnRemote.textContent = `Remote (${this.counts.remote})`;
    }

    getContainer() {
        return this.container;
    }

    getActiveFilter() {
        return this.activeFilter;
    }
}

// ES6 module export
export { CatalogFilterBar };

// Also attach to window for legacy/global usage
if (typeof window !== 'undefined') {
    window.CatalogFilterBar = CatalogFilterBar;
}
```

The component should follow the established pattern from ServerSettingsPanel.js with vanilla DOM (no framework).
  </action>
  <verify>Verify CatalogFilterBar.js exists with class definition, FILTERS static property, setFilter method, and ES6 export</verify>
  <done>CatalogFilterBar.js created with All/Local/Remote filter buttons and count display</done>
</task>

<task type="auto">
  <name>Task 2: Add source filtering to DesktopObjectManager</name>
  <files>systems/visual_shell/web/DesktopObjectManager.js</files>
  <action>
Extend DesktopObjectManager with source filtering capabilities:

1. Add filter state tracking in constructor:
```javascript
// Source filter state
this._sourceFilter = 'all'; // 'all' | 'local' | 'remote'
```

2. Add setSourceFilter method:
```javascript
/**
 * Set the source filter and update object visibility
 * @param {string} filter - 'all' | 'local' | 'remote'
 */
setSourceFilter(filter) {
    this._sourceFilter = filter;
    this._applySourceFilter();
    this.emit('filter-changed', { filter });
}

/**
 * Get the current source filter
 * @returns {string}
 */
getSourceFilter() {
    return this._sourceFilter;
}

/**
 * Apply source filter to all objects
 * @private
 */
_applySourceFilter() {
    for (const [entryId, obj] of this.objects) {
        const isRemote = this._remoteEntryIds.has(entryId);

        switch (this._sourceFilter) {
            case 'local':
                obj.visible = !isRemote;
                break;
            case 'remote':
                obj.visible = isRemote;
                break;
            case 'all':
            default:
                obj.visible = true;
        }
    }
}

/**
 * Get counts for filter UI
 * @returns {{local: number, remote: number, all: number}}
 */
getFilterCounts() {
    const local = this.objects.size - this._remoteEntryIds.size;
    const remote = this._remoteEntryIds.size;
    return { local, remote, all: this.objects.size };
}
```

3. Apply filter after creating new objects by calling `_applySourceFilter()` at the end of `createObject()` method.

4. Apply filter after syncing remote objects by calling `_applySourceFilter()` at the end of `_syncRemoteObjects()` method.
  </action>
  <verify>grep -n "setSourceFilter\|_applySourceFilter\|getFilterCounts" systems/visual_shell/web/DesktopObjectManager.js</verify>
  <done>DesktopObjectManager has setSourceFilter, _applySourceFilter, and getFilterCounts methods; objects hide/show based on filter</done>
</task>

<task type="auto">
  <name>Task 3: Integrate filter bar into demo page</name>
  <files>systems/visual_shell/web/demo_desktop_objects.html</files>
  <action>
Add the CatalogFilterBar to demo_desktop_objects.html:

1. Add script import after other desktop object scripts (around line 321):
```html
<script src="CatalogFilterBar.js"></script>
```

2. Add filter bar container in status bar (after the API URL status item, around line 285):
```html
<div id="filter-container" style="margin-left: auto;"></div>
```

3. Initialize filter bar in initDesktopObjectManager function (after desktopObjectManager is created):
```javascript
// Initialize filter bar
const filterContainer = document.getElementById('filter-container');
filterBar = new CatalogFilterBar({
    onFilterChange: (filter) => {
        desktopObjectManager.setSourceFilter(filter);
    }
});
filterContainer.appendChild(filterBar.getContainer());

// Update counts when catalog loads
desktopObjectManager.on('catalog-loaded', () => {
    const counts = desktopObjectManager.getFilterCounts();
    filterBar.updateCounts(counts.local, counts.remote);
});

desktopObjectManager.on('remote-catalog-loaded', () => {
    const counts = desktopObjectManager.getFilterCounts();
    filterBar.updateCounts(counts.local, counts.remote);
});
```

4. Add `let filterBar = null;` to the state section at the top.

5. Update updateObjectCount function to also update filter counts:
```javascript
function updateObjectCount(count) {
    objectCountEl.textContent = count;
    if (filterBar && desktopObjectManager) {
        const counts = desktopObjectManager.getFilterCounts();
        filterBar.updateCounts(counts.local, counts.remote);
    }
}
```
  </action>
  <verify>grep -n "CatalogFilterBar\|filterBar\|filter-container" systems/visual_shell/web/demo_desktop_objects.html</verify>
  <done>Filter bar visible in status bar with All/Local/Remote buttons showing counts; clicking filters hides/shows objects</done>
</task>

</tasks>

<verification>
1. Open demo_desktop_objects.html in browser
2. Verify filter bar appears in status bar with All/Local/Remote buttons
3. Click "Local" - only local containers should be visible
4. Click "Remote" - only remote containers should be visible
5. Click "All" - all containers should be visible
6. Refresh catalog and verify filter persists
</verification>

<success_criteria>
- Filter bar shows in UI with three buttons (All, Local, Remote)
- Each button displays correct count of containers
- Clicking filter buttons hides/shows appropriate containers
- Filter state persists across catalog refresh operations
</success_criteria>

<output>
After completion, create `.planning/phases/10-remote-catalog-integration/10-01-SUMMARY.md`
</output>
