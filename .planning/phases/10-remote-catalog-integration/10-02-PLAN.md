---
phase: 10-remote-catalog-integration
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - systems/visual_shell/web/DesktopObjectManager.js
  - systems/visual_shell/web/CatalogSearchBar.js
  - systems/visual_shell/web/demo_desktop_objects.html
autonomous: true

must_haves:
  truths:
    - "User can type a search query to filter containers by name"
    - "Search works across both local and remote containers"
    - "Search results update as user types"
    - "Search can be combined with source filter"
    - "Clearing search shows all containers matching current source filter"
  artifacts:
    - path: "systems/visual_shell/web/CatalogSearchBar.js"
      provides: "Search input UI with clear button"
      min_lines: 60
    - path: "systems/visual_shell/web/DesktopObjectManager.js"
      provides: "Search filtering logic combined with source filter"
      contains: "setSearchQuery"
  key_links:
    - from: "CatalogSearchBar.js"
      to: "DesktopObjectManager"
      via: "setSearchQuery callback"
      pattern: "onSearchChange"
    - from: "DesktopObjectManager"
      to: "object.entry.entryData.name"
      via: "case-insensitive string matching"
      pattern: "toLowerCase\\(\\).includes"
---

<objective>
Add unified search across local and remote catalogs (RCAT-03).

Purpose: Users can search across all catalog sources with a single search query to quickly find containers by name.

Output: Search bar UI and search filtering logic combined with source filter.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context
@.planning/phases/10-remote-catalog-integration/10-01-PLAN.md

# Existing components
@systems/visual_shell/web/DesktopObjectManager.js
@systems/visual_shell/web/RemoteCatalogClient.js
@systems/visual_shell/web/demo_desktop_objects.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CatalogSearchBar component</name>
  <files>systems/visual_shell/web/CatalogSearchBar.js</files>
  <action>
Create a new CatalogSearchBar class for search input UI:

```javascript
// CatalogSearchBar.js - Search input for catalog filtering
//
// Features:
// - Text input with placeholder
// - Clear button (X) when text present
// - Debounced search callback (300ms delay)
// - ES6 export + window attachment pattern

class CatalogSearchBar {
    static DEBOUNCE_MS = 300;

    constructor(options = {}) {
        this.container = null;
        this.input = null;
        this.clearBtn = null;
        this.query = '';
        this.onSearchChange = options.onSearchChange || (() => {});
        this.debounceTimer = null;
        this._createUI();
    }

    _createUI() {
        this.container = document.createElement('div');
        this.container.id = 'catalog-search-bar';
        this.container.style.cssText = `
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #222;
            border: 1px solid #444;
            border-radius: 4px;
        `;

        // Search icon
        const icon = document.createElement('span');
        icon.innerHTML = '&#128269;'; // Magnifying glass
        icon.style.cssText = 'color: #666; font-size: 14px;';
        this.container.appendChild(icon);

        // Input field
        this.input = document.createElement('input');
        this.input.type = 'text';
        this.input.placeholder = 'Search containers...';
        this.input.style.cssText = `
            background: transparent;
            border: none;
            color: #fff;
            font-size: 12px;
            outline: none;
            width: 150px;
            font-family: 'Courier New', monospace;
        `;
        this.input.addEventListener('input', (e) => this._onInput(e));
        this.input.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.clear();
            }
        });
        this.container.appendChild(this.input);

        // Clear button
        this.clearBtn = document.createElement('button');
        this.clearBtn.innerHTML = '&times;';
        this.clearBtn.title = 'Clear search (Esc)';
        this.clearBtn.style.cssText = `
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 0 4px;
            display: none;
        `;
        this.clearBtn.addEventListener('click', () => this.clear());
        this.container.appendChild(this.clearBtn);
    }

    _onInput(e) {
        this.query = e.target.value.trim();
        this._updateClearButton();

        // Debounce the callback
        clearTimeout(this.debounceTimer);
        this.debounceTimer = setTimeout(() => {
            this.onSearchChange(this.query);
        }, CatalogSearchBar.DEBOUNCE_MS);
    }

    _updateClearButton() {
        this.clearBtn.style.display = this.query ? 'block' : 'none';
    }

    clear() {
        this.query = '';
        this.input.value = '';
        this._updateClearButton();
        this.onSearchChange('');
    }

    getContainer() {
        return this.container;
    }

    getQuery() {
        return this.query;
    }

    focus() {
        this.input.focus();
    }
}

// ES6 module export
export { CatalogSearchBar };

// Also attach to window for legacy/global usage
if (typeof window !== 'undefined') {
    window.CatalogSearchBar = CatalogSearchBar;
}
```

The component follows the established pattern with 300ms debounce to avoid excessive filtering while typing.
  </action>
  <verify>Verify CatalogSearchBar.js exists with class definition, debounce logic, clear button, and ES6 export</verify>
  <done>CatalogSearchBar.js created with search input, clear button, and debounced callback</done>
</task>

<task type="auto">
  <name>Task 2: Add search filtering to DesktopObjectManager</name>
  <files>systems/visual_shell/web/DesktopObjectManager.js</files>
  <action>
Extend DesktopObjectManager with search query filtering that combines with source filter:

1. Add search state tracking in constructor (near _sourceFilter):
```javascript
// Search filter state
this._searchQuery = '';
```

2. Add setSearchQuery method and update _applySourceFilter:
```javascript
/**
 * Set the search query and update object visibility
 * @param {string} query - Search query (empty string shows all)
 */
setSearchQuery(query) {
    this._searchQuery = query.toLowerCase().trim();
    this._applySourceFilter();
    this.emit('search-changed', { query });
}

/**
 * Get the current search query
 * @returns {string}
 */
getSearchQuery() {
    return this._searchQuery;
}

/**
 * Check if an object matches the current search query
 * @param {RTSDesktopObject} obj - The object to check
 * @returns {boolean}
 * @private
 */
_matchesSearch(obj) {
    if (!this._searchQuery) return true;

    // Get name from entry data
    const entry = obj.entryData || obj.entry;
    const name = (entry?.name || entry?.id || '').toLowerCase();
    return name.includes(this._searchQuery);
}
```

3. Update _applySourceFilter to also check search query:
```javascript
_applySourceFilter() {
    for (const [entryId, obj] of this.objects) {
        const isRemote = this._remoteEntryIds.has(entryId);

        // Check source filter
        let passesSourceFilter = true;
        switch (this._sourceFilter) {
            case 'local':
                passesSourceFilter = !isRemote;
                break;
            case 'remote':
                passesSourceFilter = isRemote;
                break;
            case 'all':
            default:
                passesSourceFilter = true;
        }

        // Check search filter
        const passesSearch = this._matchesSearch(obj);

        // Object is visible only if it passes both filters
        obj.visible = passesSourceFilter && passesSearch;
    }
}
```

4. Ensure _applySourceFilter is called after object creation (already done in plan 10-01).
  </action>
  <verify>grep -n "setSearchQuery\|_searchQuery\|_matchesSearch" systems/visual_shell/web/DesktopObjectManager.js</verify>
  <done>DesktopObjectManager has setSearchQuery, _matchesSearch methods; visibility combines source and search filters</done>
</task>

<task type="auto">
  <name>Task 3: Integrate search bar into demo page</name>
  <files>systems/visual_shell/web/demo_desktop_objects.html</files>
  <action>
Add the CatalogSearchBar to demo_desktop_objects.html:

1. Add script import after CatalogFilterBar.js (around line 322):
```html
<script src="CatalogSearchBar.js"></script>
```

2. Add search bar container in status bar (before filter-container):
```html
<div id="search-container" style="margin-right: 16px;"></div>
```

3. Add `let searchBar = null;` to the state section.

4. Initialize search bar in initDesktopObjectManager (after filter bar setup):
```javascript
// Initialize search bar
const searchContainer = document.getElementById('search-container');
searchBar = new CatalogSearchBar({
    onSearchChange: (query) => {
        desktopObjectManager.setSearchQuery(query);
    }
});
searchContainer.appendChild(searchBar.getContainer());
```

5. Add keyboard shortcut hint to grid hint text (update the #grid-hint element):
```html
<div id="grid-hint">Pan: Drag | Zoom: Scroll | Select: Click | Boot: Double-click | Search: Type to filter</div>
```

6. Add Ctrl+F keyboard shortcut to focus search (add to setupPanZoom function or after):
```javascript
// Keyboard shortcut for search focus
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        if (searchBar) {
            searchBar.focus();
        }
    }
});
```
  </action>
  <verify>grep -n "CatalogSearchBar\|searchBar\|search-container" systems/visual_shell/web/demo_desktop_objects.html</verify>
  <done>Search bar visible in status bar; typing filters containers by name; Ctrl+F focuses search; Escape clears search</done>
</task>

</tasks>

<verification>
1. Open demo_desktop_objects.html in browser
2. Verify search bar appears in status bar
3. Type a search query - only matching containers should be visible
4. Combine with source filter - search should work within filtered results
5. Press Escape - search should clear
6. Press Ctrl+F - search input should focus
7. Clear search - all containers matching source filter should appear
</verification>

<success_criteria>
- Search bar shows in UI with placeholder text
- Typing filters containers by name (case-insensitive)
- Search combines with source filter (e.g., "Local" filter + search shows only matching local containers)
- Ctrl+F focuses search input
- Escape clears search
- 300ms debounce prevents excessive filtering while typing
</success_criteria>

<output>
After completion, create `.planning/phases/10-remote-catalog-integration/10-02-SUMMARY.md`
</output>
