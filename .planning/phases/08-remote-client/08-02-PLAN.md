---
phase: 08-remote-client
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - systems/visual_shell/web/RTSDesktopObject.js
  - systems/visual_shell/web/ServerSettingsPanel.js
  - systems/visual_shell/web/DesktopObjectManager.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see a colored badge indicating which server a remote container comes from"
    - "User can hover over the badge to see the server name"
    - "User can open a settings panel to add/remove remote catalog servers"
    - "User sees skeleton loaders while remote catalogs are fetching"
    - "User sees error indicators for unreachable servers in settings"
  artifacts:
    - path: "systems/visual_shell/web/RTSDesktopObject.js"
      provides: "Server source badge indicator on desktop objects"
      contains: "_createServerSourceBadge"
    - path: "systems/visual_shell/web/ServerSettingsPanel.js"
      provides: "Settings UI for managing remote servers"
      exports: ["ServerSettingsPanel"]
      min_lines: 150
    - path: "systems/visual_shell/web/DesktopObjectManager.js"
      provides: "Integration with RemoteCatalogClient for loading remote entries"
      contains: "loadRemoteCatalogs"
  key_links:
    - from: "RTSDesktopObject"
      to: "entry.sourceServerId"
      via: "badge color lookup in ServerRegistry"
      pattern: "sourceServerId.*color"
    - from: "ServerSettingsPanel"
      to: "ServerRegistry"
      via: "addServer/updateServer/removeServer calls"
      pattern: "registry\\.(add|update|remove)Server"
    - from: "DesktopObjectManager"
      to: "RemoteCatalogClient"
      via: "fetchAllCatalogs for remote entries"
      pattern: "remoteClient\\.fetchAllCatalogs"
---

<objective>
Add server source indicators to desktop objects and create settings panel for managing remote catalog servers.

Purpose: Users can identify which server a container comes from and manage their remote server list.
Output: Server source badges on desktop objects, settings panel for server management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependencies from previous plan
@.planning/phases/08-remote-client/08-01-SUMMARY.md

# Existing patterns to follow
@systems/visual_shell/web/RTSDesktopObject.js - Status indicators, tooltips, cache badges
@systems/visual_shell/web/DesktopObjectManager.js - Catalog loading pattern

# Phase context
@.planning/phases/08-remote-client/08-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add server source badge to RTSDesktopObject</name>
  <files>systems/visual_shell/web/RTSDesktopObject.js</files>
  <action>
Extend RTSDesktopObject to show a colored badge indicating the source server for remote containers.

**Add to RTSDesktopObject class:**

1. **New static property for badge positioning:**
```javascript
static SERVER_BADGE = {
    SIZE: 8,           // Small colored dot
    OFFSET_X: 4,       // From left edge
    OFFSET_Y: 4        // From top edge
};
```

2. **New method `_createServerSourceBadge()`** (call from constructor after `_createCacheStatusIndicator`):
- Create PIXI.Graphics for the badge
- Position at top-left corner (OFFSET_X, OFFSET_Y)
- Draw 8px circle with server's color (or default gray if local/no server)
- Initially hidden for local containers

3. **New method `_createServerSourceTooltip()`**:
- Create PIXI.Text for server name tooltip
- Position near badge (left-aligned, below badge)
- Hidden by default, shown on hover

4. **Update constructor to accept server metadata:**
- Check entry.sourceServerId and entry.sourceServerName
- If present, show badge with entry.sourceServerColor (or lookup from registry)
- If absent, hide badge (local container)

5. **Update `_onPointerOver()` to show server tooltip:**
- Show server source tooltip if badge is visible

6. **Update `_onPointerOut()` to hide server tooltip:**
- Hide server source tooltip

7. **New method `setServerSource(serverId, serverName, color)`:**
- Update badge color and tooltip text
- Show/hide badge based on serverId presence

**Badge design:**
- Small 8px colored circle in top-left corner
- Hover shows server name (e.g., "Company Catalog")
- Local containers have no badge
  </action>
  <verify>
- Remote containers show colored badge in top-left
- Hover on badge shows server name tooltip
- Local containers have no badge visible
- Badge color matches server's configured color
  </verify>
  <done>
RTSDesktopObject displays colored source server badge with hover tooltip for remote containers.
</done>
</task>

<task type="auto">
  <name>Task 2: Create ServerSettingsPanel for server management UI</name>
  <files>systems/visual_shell/web/ServerSettingsPanel.js</files>
  <action>
Create ServerSettingsPanel class that provides a UI for managing remote catalog servers.

**Create new file `systems/visual_shell/web/ServerSettingsPanel.js`:**

**Constructor:**
```javascript
constructor(container, options = {})
```
- Accept HTML container element to render into
- Create internal ServerRegistry instance
- Store onServerChange callback option

**Structure (vanilla DOM, no framework):**
```
<div class="server-settings-panel">
  <div class="panel-header">
    <h3>Remote Catalog Servers</h3>
    <button class="add-server-btn">+ Add Server</button>
  </div>
  <div class="server-list">
    <!-- Server entries rendered here -->
  </div>
  <div class="add-server-form" style="display:none">
    <input type="url" placeholder="Server URL" class="server-url-input">
    <input type="text" placeholder="Display Name" class="server-name-input">
    <input type="color" value="#00aaff" class="server-color-input">
    <button class="save-btn">Add</button>
    <button class="cancel-btn">Cancel</button>
  </div>
</div>
```

**Server entry template:**
```
<div class="server-entry" data-server-id="...">
  <div class="server-color-dot" style="background: #00aaff"></div>
  <div class="server-info">
    <div class="server-name">Company Catalog</div>
    <div class="server-url">https://catalog.example.com</div>
  </div>
  <div class="server-status">
    <span class="status-ok" style="display:none">OK</span>
    <span class="status-error" style="display:none">Error</span>
    <span class="status-loading">Loading...</span>
  </div>
  <div class="server-actions">
    <button class="toggle-btn">Disable</button>
    <button class="remove-btn">Remove</button>
  </div>
</div>
```

**Methods:**
- `render()` - Render full panel from registry state
- `renderServerList()` - Render just the server list
- `showAddForm()` / `hideAddForm()` - Toggle add form visibility
- `handleAddServer()` - Validate and add new server via registry
- `handleToggleServer(id)` - Toggle enabled state
- `handleRemoveServer(id)` - Remove server after confirmation
- `setServerStatus(id, status, error)` - Update status indicator for a server
- `destroy()` - Clean up DOM and event listeners

**CSS classes (inline styles or append style element):**
- Panel has dark background matching app theme
- Status indicators: green dot for OK, red for error, gray loading spinner
- Form inputs have dark theme styling

**Follow ES6 export + window attachment pattern.**
  </action>
  <verify>
- ServerSettingsPanel renders list of configured servers
- Add server form validates URL and adds to registry
- Toggle button enables/disables servers
- Remove button removes server from registry
- Status indicators show ok/error/loading states
  </verify>
  <done>
ServerSettingsPanel provides UI for adding/removing/toggling remote catalog servers with status indicators.
</done>
</task>

<task type="auto">
  <name>Task 3: Integrate RemoteCatalogClient with DesktopObjectManager</name>
  <files>systems/visual_shell/web/DesktopObjectManager.js</files>
  <action>
Extend DesktopObjectManager to load remote catalogs alongside local catalog and display skeleton loaders.

**Add to DesktopObjectManager class:**

1. **Import RemoteCatalogClient and ServerRegistry at top of file:**
```javascript
import { RemoteCatalogClient } from './RemoteCatalogClient.js';
import { ServerRegistry } from './ServerRegistry.js';
```

2. **Extend constructor:**
- Create `this.remoteClient = new RemoteCatalogClient()`
- Create `this.serverRegistry = new ServerRegistry()`

3. **New method `async loadRemoteCatalogs()`:**
- Use stale-while-revalidate pattern:
  ```javascript
  async loadRemoteCatalogs() {
    // Show stale cached data immediately if available
    const cached = this.remoteClient.getAggregatedCatalog();
    if (cached.entries.length > 0) {
      this._createRemoteObjects(cached.entries);
    }

    // Fetch fresh data
    const result = await this.remoteClient.fetchAllCatalogs();

    // Update UI with fresh data
    this._syncRemoteObjects(result.entries);

    // Update server statuses based on errors
    result.errors.forEach(err => {
      this.serverRegistry.setServerStatus(err.serverId, 'error', err.error);
    });

    return result;
  }
  ```
- `_createRemoteObjects(entries)` - Create objects for remote entries
- `_syncRemoteObjects(entries)` - Update/create/remove to match current entries

4. **New method `_createSkeletonLoader(entry)` - optional:**
- Create placeholder PIXI.Container with animated skeleton effect
- Gray pulsing rectangle while loading
- Replace with real object when data arrives

5. **Update `loadCatalog()` to also load remote catalogs:**
- After loading local catalog, call `loadRemoteCatalogs()`
- Local and remote objects appear on same canvas

6. **Ensure remote entries get server metadata:**
- When creating object from remote entry, pass sourceServerId, sourceServerName, sourceServerColor
  </action>
  <verify>
- loadCatalog() loads both local and remote catalogs
- Remote containers appear on canvas with source badges
- Stale cached data appears immediately while fresh loads
- Server status updates in registry on fetch errors
- Local and remote containers coexist on same canvas
  </verify>
  <done>
DesktopObjectManager loads remote catalogs with stale-while-revalidate, creating objects with server source metadata.
</done>
</task>

</tasks>

<verification>
- Remote containers show colored server source badge
- Hover on badge shows server name
- ServerSettingsPanel allows adding/removing servers
- Settings panel shows server status (ok/error/loading)
- DesktopObjectManager integrates remote catalog loading
- Stale data appears immediately while fresh loads
- Local and remote containers mixed on same canvas
</verification>

<success_criteria>
1. Remote containers have visible colored badge indicating source server
2. Badge hover shows server display name
3. ServerSettingsPanel add/remove/edit server configurations
4. Settings panel displays server reachability status
5. Remote catalog loads without blocking UI (SWR pattern)
6. Local and remote containers display together on canvas
</success_criteria>

<output>
After completion, create `.planning/phases/08-remote-client/08-02-SUMMARY.md`
</output>
