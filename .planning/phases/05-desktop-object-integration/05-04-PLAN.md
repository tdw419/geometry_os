---
phase: 05-desktop-object-integration
plan: 04
type: execute
wave: 3
depends_on:
  - 05-01
  - 05-02
  - 05-03
files_modified:
  - systems/visual_shell/web/demo_desktop_objects.html
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can see desktop objects on infinite canvas"
    - "User can interact with objects (drag, select, boot)"
    - "Demo page loads all required components"
  artifacts:
    - path: "systems/visual_shell/web/demo_desktop_objects.html"
      provides: "Integration demo showing desktop objects on canvas"
      contains: ["DesktopObjectManager", "CatalogBridge", "PIXI.Application"]
  key_links:
    - from: "demo_desktop_objects.html"
      to: "CatalogBridge.js"
      via: "script import"
      pattern: "CatalogBridge"
    - from: "demo_desktop_objects.html"
      to: "DesktopObjectManager.js"
      via: "script import + loadCatalog()"
      pattern: "DesktopObjectManager"
    - from: "demo_desktop_objects.html"
      to: "catalog_server.py"
      via: "fetch /api/v1/catalog"
      pattern: "localhost:8080"
---

<objective>
Create an integration demo page that loads all desktop object components and displays them on the PixiJS infinite canvas. This provides a testable surface for verifying the API wiring fixes from 05-03.

Purpose: Enable manual and automated testing of desktop object integration without needing the full visual shell application.
Output: demo_desktop_objects.html - standalone demo page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Components to integrate
@systems/visual_shell/web/CatalogBridge.js
@systems/visual_shell/web/RTSDesktopObject.js
@systems/visual_shell/web/DesktopObjectManager.js

# Reference patterns for demo pages
@systems/visual_shell/web/demo_geometric_terminal.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create demo_desktop_objects.html with PIXI canvas and component loading</name>
  <files>systems/visual_shell/web/demo_desktop_objects.html</files>
  <action>
Create a standalone HTML demo page that:
1. Loads PIXI.js v7 from CDN
2. Imports the three component modules
3. Creates an infinite canvas with viewport controls
4. Initializes DesktopObjectManager and loads the catalog
5. Shows connection status and object count

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop Objects Demo - Geometry OS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }

        #status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.connected {
            background: #00ff00;
        }

        .status-dot.error {
            background: #ff0000;
        }

        .status-dot.loading {
            background: #ffcc00;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #controls {
            position: fixed;
            bottom: 16px;
            left: 16px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 4px;
        }

        #controls button {
            padding: 6px 12px;
            margin-right: 8px;
            background: #1a1a1a;
            color: #00ffff;
            border: 1px solid #00ffff;
            cursor: pointer;
            font-family: inherit;
        }

        #controls button:hover {
            background: #00ffff;
            color: #000;
        }

        #log {
            position: fixed;
            bottom: 16px;
            right: 16px;
            width: 300px;
            height: 200px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            overflow-y: auto;
            font-size: 11px;
        }

        #log .entry {
            margin-bottom: 4px;
            border-bottom: 1px solid #222;
            padding-bottom: 4px;
        }

        #log .time {
            color: #666;
        }
    </style>
</head>
<body>
    <div id="status-bar">
        <div class="status-item">
            <div class="status-dot" id="connection-status"></div>
            <span id="connection-text">Not connected</span>
        </div>
        <div class="status-item">
            <span>Objects: <strong id="object-count">0</strong></span>
        </div>
        <div class="status-item">
            <span>Selected: <strong id="selected-object">None</strong></span>
        </div>
    </div>

    <div id="canvas-container"></div>

    <div id="controls">
        <button id="btn-refresh">Refresh Catalog</button>
        <button id="btn-center">Center View</button>
        <button id="btn-clear-log">Clear Log</button>
    </div>

    <div id="log"></div>

    <!-- PIXI.js v7 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>

    <!-- Component modules -->
    <script type="module">
        import { CatalogBridge } from './CatalogBridge.js';
        import { RTSDesktopObject } from './RTSDesktopObject.js';
        import { DesktopObjectManager } from './DesktopObjectManager.js';

        // Make available globally for debugging
        window.CatalogBridge = CatalogBridge;
        window.RTSDesktopObject = RTSDesktopObject;
        window.DesktopObjectManager = DesktopObjectManager;

        // Logging utility
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.innerHTML = `<span class="time">[${time}]</span> ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[Demo] ${message}`);
        }

        // Status update utility
        function updateConnectionStatus(status) {
            const dot = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');

            dot.className = 'status-dot ' + status;

            switch (status) {
                case 'connected':
                    text.textContent = 'Connected to catalog server';
                    break;
                case 'error':
                    text.textContent = 'Connection failed';
                    break;
                case 'loading':
                    text.textContent = 'Connecting...';
                    break;
                default:
                    text.textContent = 'Not connected';
            }
        }

        function updateObjectCount(count) {
            document.getElementById('object-count').textContent = count;
        }

        function updateSelectedObject(name) {
            document.getElementById('selected-object').textContent = name || 'None';
        }

        // Initialize PIXI Application
        log('Initializing PIXI application...');

        const app = new PIXI.Application({
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: 0x0a0a0a,
            resolution: window.devicePixelRatio || 1,
            autoDensity: true,
            antialias: true
        });

        document.getElementById('canvas-container').appendChild(app.view);

        // Create world container for infinite canvas
        const worldContainer = new PIXI.Container();
        worldContainer.label = 'world';
        app.stage.addChild(worldContainer);

        // Add subtle grid background
        const gridGraphics = new PIXI.Graphics();
        gridGraphics.label = 'grid';
        worldContainer.addChild(gridGraphics);

        function drawGrid() {
            gridGraphics.clear();
            gridGraphics.lineStyle(1, 0x222222, 0.5);

            const gridSize = 160;
            const viewWidth = app.screen.width;
            const viewHeight = app.screen.height;

            // Draw vertical lines
            for (let x = -worldContainer.x % gridSize; x < viewWidth; x += gridSize) {
                gridGraphics.moveTo(x, 0);
                gridGraphics.lineTo(x, viewHeight);
            }

            // Draw horizontal lines
            for (let y = -worldContainer.y % gridSize; y < viewHeight; y += gridSize) {
                gridGraphics.moveTo(0, y);
                gridGraphics.lineTo(viewWidth, y);
            }
        }

        // Simple viewport pan (drag canvas to move)
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };

        app.view.addEventListener('pointerdown', (e) => {
            // Only pan if clicking on empty space (not on objects)
            if (e.target === app.view) {
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY };
            }
        });

        app.view.addEventListener('pointermove', (e) => {
            if (isDragging) {
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;
                worldContainer.x += dx;
                worldContainer.y += dy;
                dragStart = { x: e.clientX, y: e.clientY };
                drawGrid();
            }
        });

        app.view.addEventListener('pointerup', () => {
            isDragging = false;
        });

        app.view.addEventListener('pointerleave', () => {
            isDragging = false;
        });

        // Zoom with mouse wheel
        app.view.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            worldContainer.scale.x *= zoomFactor;
            worldContainer.scale.y *= zoomFactor;

            // Clamp zoom
            worldContainer.scale.x = Math.max(0.25, Math.min(3, worldContainer.scale.x));
            worldContainer.scale.y = Math.max(0.25, Math.min(3, worldContainer.scale.y));
        });

        // Initialize CatalogBridge
        const catalogServerUrl = 'http://localhost:8080';
        log(`Connecting to catalog server at ${catalogServerUrl}...`);
        updateConnectionStatus('loading');

        const bridge = new CatalogBridge(catalogServerUrl, {
            timeout: 10000
        });

        // Initialize DesktopObjectManager
        const manager = new DesktopObjectManager(worldContainer, bridge, {
            autoLoad: false,  // We'll load manually after setup
            onObjectCreated: (obj) => {
                log(`Created object: ${obj.entryId}`);
            },
            onObjectDestroyed: (obj) => {
                log(`Destroyed object: ${obj.entryId}`);
            }
        });

        // Listen to manager events
        manager.on('catalog-loaded', (data) => {
            updateObjectCount(data.count);
            log(`Loaded ${data.count} objects from catalog`);
        });

        manager.on('object-selected', (data) => {
            updateSelectedObject(data.object.entryData?.name || data.entryId);
            log(`Selected: ${data.entryId}`);
        });

        manager.on('object-moved', (data) => {
            log(`Moved ${data.entryId} to grid(${data.gridX}, ${data.gridY})`);
        });

        manager.on('object-booted', (data) => {
            log(`Booted ${data.entryId}`, 'success');
        });

        // Load catalog
        async function loadCatalog() {
            updateConnectionStatus('loading');

            try {
                // First check health
                const healthy = await bridge.healthCheck();
                if (!healthy) {
                    throw new Error('Catalog server not responding');
                }

                // Load catalog
                const count = await manager.loadCatalog();
                updateConnectionStatus('connected');
                updateObjectCount(count);

                // Center view on first object if available
                if (count > 0) {
                    centerView();
                }

            } catch (error) {
                updateConnectionStatus('error');
                log(`Failed to load catalog: ${error.message}`, 'error');
            }
        }

        function centerView() {
            // Center the world container
            worldContainer.x = window.innerWidth / 2;
            worldContainer.y = window.innerHeight / 2;
            worldContainer.scale.set(1);
            drawGrid();
        }

        // Button handlers
        document.getElementById('btn-refresh').addEventListener('click', async () => {
            log('Refreshing catalog...');
            await loadCatalog();
        });

        document.getElementById('btn-center').addEventListener('click', () => {
            centerView();
            log('View centered');
        });

        document.getElementById('btn-clear-log').addEventListener('click', () => {
            document.getElementById('log').innerHTML = '';
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            app.renderer.resize(window.innerWidth, window.innerHeight);
            drawGrid();
        });

        // Initial load
        drawGrid();
        loadCatalog();

        // Expose for debugging
        window.app = app;
        window.worldContainer = worldContainer;
        window.manager = manager;
        window.bridge = bridge;

        log('Demo initialized. Drag canvas to pan, scroll to zoom.');
        log('Double-click objects to boot, drag objects to reposition.');
    </script>
</body>
</html>
```

Key features:
1. PIXI v7 from CDN (matches project requirement)
2. Imports all three modules (CatalogBridge, RTSDesktopObject, DesktopObjectManager)
3. Infinite canvas with pan (drag) and zoom (scroll)
4. Grid background for spatial reference
5. Status bar showing connection status and object count
6. Event logging panel for debugging
7. Buttons for refresh, center view, clear log
8. Exposes globals for browser console debugging
</action>
  <verify>node -e "const fs = require('fs'); const html = fs.readFileSync('systems/visual_shell/web/demo_desktop_objects.html', 'utf8'); console.log(html.includes('DesktopObjectManager') && html.includes('CatalogBridge') && html.includes('PIXI.Application') ? 'OK' : 'FAIL')"</verify>
  <done>demo_desktop_objects.html loads components and displays desktop objects on canvas</done>
</task>

</tasks>

<verification>
- [ ] HTML file exists at systems/visual_shell/web/demo_desktop_objects.html
- [ ] Loads PIXI.js v7 from CDN
- [ ] Imports CatalogBridge, RTSDesktopObject, DesktopObjectManager modules
- [ ] Creates PIXI.Application with world container
- [ ] Initializes DesktopObjectManager with autoLoad
- [ ] Has pan (drag canvas) and zoom (scroll) controls
- [ ] Shows connection status and object count
- [ ] Has event logging for debugging
</verification>

<success_criteria>
- Demo page loads without JavaScript errors
- Shows connection status to catalog server (localhost:8080)
- Displays desktop objects on canvas when catalog server is running
- Objects are draggable and show hover state
- Double-click triggers boot (if catalog server responds)
- Status bar updates with object count and selection
- Event log shows object interactions
</success_criteria>

<output>
After completion, create `.planning/phases/05-desktop-object-integration/05-04-SUMMARY.md`
</output>
