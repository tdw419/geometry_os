---
phase: 16-integration
plan: 03
type: execute
wave: 2
depends_on: ["16-01", "16-02"]
files_modified:
  - systems/pixel_compiler/tests/test_pxe_visual_integration.py
autonomous: true

must_haves:
  truths:
    - "Integration tests verify PXE badge shows correctly"
    - "Tests verify toggle updates badge immediately"
    - "Tests verify catalog merges PXE data"
    - "Tests verify boot progress works with PXE containers"
  artifacts:
    - path: "systems/pixel_compiler/tests/test_pxe_visual_integration.py"
      provides: "Integration tests for PXE visual shell integration"
      min_lines: 100
  key_links:
    - from: "test"
      to: "DesktopObjectManager"
      via: "mock catalog and PXE server"
      pattern: "_loadPXEData"
---

<objective>
Create integration tests verifying PXE visual shell integration works correctly.

Purpose: Ensure PXE badge, toggle, and data loading work end-to-end
Output: Comprehensive test suite for PXE integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Components being tested
@systems/visual_shell/web/DesktopObjectManager.js
@systems/visual_shell/web/ServerSettingsPanel.js
@systems/visual_shell/web/RTSDesktopObject.js
@systems/visual_shell/web/CatalogBridge.js

# Test patterns to follow
@systems/pixel_compiler/tests/test_http_server.py
@systems/pixel_compiler/tests/test_boot_menu.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test file structure</name>
  <files>systems/pixel_compiler/tests/test_pxe_visual_integration.py</files>
  <action>
    Create test file following the pattern from test_http_server.py

    Structure:
    ```python
    """
    Tests for PXE visual shell integration.

    Verifies:
    - PXE badge shows on desktop objects
    - Toggle updates badge immediately
    - CatalogBridge calls /pxe endpoint
    - Boot progress works with PXE containers
    """
    import unittest
    from unittest.mock import MagicMock, AsyncMock, patch
    import asyncio
    import sys
    import os

    # Add test directories to path
    sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', '..', 'visual_shell', 'web'))

    class PXEVisualIntegrationTestBase(unittest.TestCase):
        \"\"\"Base class with async test support.\"\"\"

        def setUp(self):
            \"\"\"Set up test fixtures.\"\"\"
            # Mock catalog bridge
            self.mock_bridge = MagicMock()
            self.mock_bridge.getPXEContainers = AsyncMock()
            self.mock_bridge.setPXEAvailability = AsyncMock()
            # Mock PIXI containers (using simple mocks)
            self.mock_world_container = MagicMock()

        def tearDown(self):
            \"\"\"Clean up after tests.\"\"\"
            pass

        def run_async(self, coro):
            \"\"\"Run async coroutine in test.\"\"\"
            return asyncio.run(coro)

    if __name__ == '__main__':
        unittest.main()
    ```
  </action>
  <verify>
    test -f systems/pixel_compiler/tests/test_pxe_visual_integration.py
  </verify>
  <done>
    Test file created with base class structure
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CatalogBridge PXE tests</name>
  <files>systems/pixel_compiler/tests/test_pxe_visual_integration.py</files>
  <action>
    Add tests for CatalogBridge PXE methods:

    1. `test_get_pxe_containers_success`:
       - Mock fetch to return PXE containers list
       - Call getPXEContainers()
       - Verify correct endpoint called
       - Verify return value structure

    2. `test_get_pxe_containers_empty`:
       - Mock fetch to return empty list
       - Verify returns empty array

    3. `test_get_pxe_containers_error`:
       - Mock fetch to raise error
       - Verify returns empty array gracefully

    4. `test_set_pxe_availability_enable`:
       - Mock fetch to return success
       - Call setPXEAvailability(entryId, True)
       - Verify POST to /pxe/{id}/toggle with { enabled: true }

    5. `test_set_pxe_availability_disable`:
       - Mock fetch to return success
       - Call setPXEAvailability(entryId, False)
       - Verify POST with { enabled: false }

    Follow pattern from test_http_server.py for mocking fetch.
  </action>
  <verify>
    grep -n "test_get_pxe_containers\|test_set_pxe_availability" systems/pixel_compiler/tests/test_pxe_visual_integration.py
  </verify>
  <done>
    5 tests for CatalogBridge PXE methods
  </done>
</task>

<task type="auto">
  <name>Task 3: Add DesktopObjectManager PXE tests</name>
  <files>systems/pixel_compiler/tests/test_pxe_visual_integration.py</files>
  <action>
    Add tests for DesktopObjectManager PXE integration:

    1. `test_load_pxe_data_merges_with_catalog`:
       - Set up mock catalog entries
       - Set up mock PXE data (some enabled, some disabled)
       - Call _loadPXEData
 or verify merge logic
       - Verify pxe_enabled field added to entries

    2. `test_pxe_data_updates_badge`:
       - Create mock desktop object
       - Call setPXEEnabled(true)
       - Verify badge update method called

    3. `test_pxe_toggle_updates_objects`:
       - Set up event listener for pxe-toggled
       - Emit toggle event
       - Verify setPXEEnabled called on object

    Note: These tests mock PIXI components since we visual shell requires browser environment.
    Focus on data flow rather than visual rendering.
  </action>
  <verify>
    grep -n "test_load_pxe_data\|test_pxe_toggle" systems/pixel_compiler/tests/test_pxe_visual_integration.py
  </verify>
  <done>
    3 tests for DesktopObjectManager PXE integration
  </done>
</task>

<task type="auto">
  <name>Task 4: Add RTSDesktopObject PXE badge tests</name>
  <files>systems/pixel_compiler/tests/test_pxe_visual_integration.py</files>
  <action>
    Add tests for RTSDesktopObject PXE badge:

    1. `test_pxe_badge_configuration`:
       - Verify PXE_BADGE static config exists
       - Verify SIZE, OFFSET_X, OFFSET_Y, COLOR_ENABLED, COLOR_DISABLED

    2. `test_create_pxe_badge_visible`:
       - Create object with entry.pxe_enabled = True
       - Verify badge is visible

    3. `test_create_pxe_badge_hidden`:
       - Create object with entry.pxe_enabled = False
       - Verify badge is hidden

    4. `test_set_pxe_enabled_true`:
       - Create object with pxe_enabled = false
       - Call setPXEEnabled(true)
       - Verify _pxeEnabled = true
       - Verify badge redraw with enabled color

    5. `test_set_pxe_enabled_false`:
       - Create object with pxe_enabled = true
       - Call setPXEEnabled(false)
       - Verify badge hidden or disabled color

    Note: Mock PIXI.Graphics for badge drawing verification.
  </action>
  <verify>
    grep -n "test_pxe_badge\|test_set_pxe_enabled" systems/pixel_compiler/tests/test_pxe_visual_integration.py
  </verify>
  <done>
    5 tests for RTSDesktopObject PXE badge
  </done>
</task>

</tasks>

<verification>
- Test file exists
- 13+ tests total (5 CatalogBridge, 3 DesktopObjectManager, 5 RTSDesktopObject)
- All tests pass
</verification>

<success_criteria>
- All 13 tests pass
- Tests cover PXE badge visibility
- Tests cover toggle functionality
- Tests cover data loading
</success_criteria>

<output>
After completion, create `.planning/phases/16-integration/16-03-SUMMARY.md`
</output>
