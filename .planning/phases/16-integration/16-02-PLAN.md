---
phase: 16-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/visual_shell/web/ServerSettingsPanel.js
  - systems/visual_shell/web/DesktopObjectManager.js
autonomous: true

must_haves:
  truths:
    - "User can toggle PXE availability per container from settings panel"
    - "Toggling PXE immediately updates the container's PXE badge"
    - "PXE toggle persists across page refresh"
  artifacts:
    - path: "systems/visual_shell/web/ServerSettingsPanel.js"
      provides: "PXE toggle UI per container"
      contains: "pxe-toggle"
    - path: "systems/visual_shell/web/DesktopObjectManager.js"
      provides: "PXE data fetching and badge updates"
      exports: ["loadPXEData", "togglePXE"]
  key_links:
    - from: "ServerSettingsPanel.js"
      to: "CatalogBridge.setPXEAvailability"
      via: "toggle button click handler"
    - from: "DesktopObjectManager.js"
      to: "RTSDesktopObject.setPXEEnabled"
      via: "after successful toggle"
---

<objective>
Add PXE toggle to settings panel allowing users to enable/disable network boot per container.

Purpose: Users need control over which containers appear in the PXE boot menu on networked machines.
Output: PXE toggle switch in settings panel, synced with PXE HTTP server.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# v1.2 Components
@systems/visual_shell/web/ServerSettingsPanel.js
@systems/visual_shell/web/DesktopObjectManager.js

# v1.3 PXE Backend
@systems/pixel_compiler/pxe/http_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PXE data loading to DesktopObjectManager</name>
  <files>systems/visual_shell/web/DesktopObjectManager.js</files>
  <action>
    Extend DesktopObjectManager to fetch PXE data and merge with catalog entries.

    1. Add instance state in constructor (~line 64):
       ```javascript
       this._pxeData = new Map(); // entryId -> { pxe_enabled, boot_order, ... }
       ```

    2. Add `loadPXEData()` async method after `loadRemoteCatalogs()` (~line 170):
       - Call `this.bridge.getPXEContainers()` to fetch PXE data
       - Store in `this._pxeData` map
       - Merge pxe_enabled into existing desktop objects
       - Call `obj.setPXEEnabled(true/false)` for each matching object
       - Emit 'pxe-data-loaded' event with count

    3. Call `loadPXEData()` in `loadCatalog()` after remote catalogs load (~line 128):
       ```javascript
       this.loadPXEData().catch(err => {
           console.warn('[DesktopObjectManager] PXE data load failed:', err);
       });
       ```

    4. Add `togglePXE(entryId, enabled)` async method:
       - Call `this.bridge.setPXEAvailability(entryId, enabled)`
       - On success, update `this._pxeData` and call `obj.setPXEEnabled(enabled)`
       - Emit 'pxe-toggled' event with { entryId, enabled }
       - Return success/failure status

    5. Add `getPXEData(entryId)` getter:
       - Return PXE info for entry or null if not found
  </action>
  <verify>
    grep -n "loadPXEData\|togglePXE\|_pxeData" systems/visual_shell/web/DesktopObjectManager.js
  </verify>
  <done>
    DesktopObjectManager fetches PXE data and provides togglePXE() method
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PXE container section to ServerSettingsPanel</name>
  <files>systems/visual_shell/web/ServerSettingsPanel.js</files>
  <action>
    Add a new section to ServerSettingsPanel for managing PXE-enabled containers.

    1. Add CSS styles in `_injectStyles()` (~line 408) for PXE section:
       ```css
       .server-settings-panel .pxe-section { ... }
       .server-settings-panel .pxe-entry { ... }
       .server-settings-panel .pxe-toggle { ... }
       ```

    2. Add constructor option for catalogBridge (~line 27):
       ```javascript
       this.catalogBridge = options.catalogBridge || null;
       this.desktopManager = options.desktopManager || null;
       ```

    3. Add `_createPXESection()` method after `_createCacheSection()` (~line 803):
       - Create container section showing all catalog containers
       - Each container has name, size, and toggle switch
       - Toggle switch calls `desktopManager.togglePXE(entryId, enabled)`
       - Show PXE status (enabled/disabled) for each container

    4. Call `_createPXESection()` in `render()` if catalogBridge exists (~line 488):
       ```javascript
       if (this.catalogBridge && this.desktopManager) {
           const pxeSection = this._createPXESection();
           panel.appendChild(pxeSection);
           this.pxeSectionEl = pxeSection;
       }
       ```

    5. Add `refreshPXESection()` method to update UI after toggles.

    Follow the existing cache section pattern for styling consistency.
  </action>
  <verify>
    grep -n "_createPXESection\|pxe-section\|togglePXE" systems/visual_shell/web/ServerSettingsPanel.js
  </verify>
  <done>
    Settings panel has PXE section with toggle switches per container
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire toggle to badge updates</name>
  <files>systems/visual_shell/web/ServerSettingsPanel.js</files>
  <action>
    Ensure PXE toggle immediately updates the desktop object badge.

    In the toggle switch click handler within `_createPXESection()`:

    1. Call `this.desktopManager.togglePXE(entryId, !currentEnabled)`
    2. On success, update toggle switch visual state
    3. DesktopObjectManager.togglePXE() already calls obj.setPXEEnabled()
    4. setPXEEnabled() updates the badge visual immediately

    Add event listener for 'pxe-toggled' event from DesktopObjectManager:
    - Refresh the PXE section UI to reflect new state
    - Show success toast/notification (optional)

    The flow should be:
    User clicks toggle -> togglePXE() -> API call -> badge updates -> UI refreshes
  </action>
  <verify>
    grep -n "pxe-toggled\|togglePXE" systems/visual_shell/web/ServerSettingsPanel.js
  </verify>
  <done>
    Toggling PXE immediately updates badge and persists to server
  </done>
</task>

</tasks>

<verification>
- DesktopObjectManager has loadPXEData() method
- DesktopObjectManager has togglePXE() method
- ServerSettingsPanel has _createPXESection() method
- PXE section shows containers with toggle switches
- Toggle updates badge and persists to server
</verification>

<success_criteria>
- User can toggle PXE availability from settings panel
- Toggle immediately updates the PXE badge on desktop object
- PXE state persists across page refresh (fetched from server)
</success_criteria>

<output>
After completion, create `.planning/phases/16-integration/16-02-SUMMARY.md`
</output>
