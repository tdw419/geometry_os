---
phase: 09-remote-boot
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - systems/visual_shell/web/RTSDesktopObject.js
  - systems/visual_shell/web/DesktopObjectManager.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees a download progress overlay on the desktop object"
    - "User sees percentage, speed, and time remaining during download"
    - "User sees verification status after download completes"
    - "User can click to cancel a download in progress"
    - "Downloaded container automatically boots when complete"
  artifacts:
    - path: "systems/visual_shell/web/RTSDesktopObject.js"
      provides: "Download progress overlay with verification status"
      adds_methods: ["setDownloadProgress", "showVerificationStatus", "setDownloading"]
    - path: "systems/visual_shell/web/DesktopObjectManager.js"
      provides: "Integration with RemoteBootFetcher for remote containers"
      adds_methods: ["_bootRemoteContainer", "_handleDownloadProgress"]
  key_links:
    - from: "DesktopObjectManager"
      to: "RemoteBootFetcher"
      via: "fetch() with progress callbacks"
      pattern: "RemoteBootFetcher.*fetch"
    - from: "RTSDesktopObject"
      to: "download overlay"
      via: "setDownloadProgress method"
      pattern: "setDownloadProgress"
---

<objective>
Extend RTSDesktopObject with downloading state and progress overlay, and integrate RemoteBootFetcher into DesktopObjectManager for remote container boot flow.

Purpose: Provide visual feedback during remote container download with progress bar, speed, time remaining, and verification status. Enable automatic boot after successful download.

Output: Extended RTSDesktopObject with download overlay, DesktopObjectManager integration with RemoteBootFetcher.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-remote-boot/09-CONTEXT.md

# Prior plan context
@.planning/phases/09-remote-boot/09-01-PLAN.md

# Existing patterns to follow
@systems/visual_shell/web/RTSDesktopObject.js
@systems/visual_shell/web/DesktopObjectManager.js
@systems/visual_shell/web/RemoteBootFetcher.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add download progress overlay to RTSDesktopObject</name>
  <files>systems/visual_shell/web/RTSDesktopObject.js</files>
  <action>
Extend RTSDesktopObject with download state and progress overlay:

1. **Add download status to STATUS_COLORS:**
```javascript
static STATUS_COLORS = {
  // ... existing colors ...
  downloading: 0x00aaff,  // Cyan for downloading
};
```

2. **Add download stages (similar to BOOT_STAGES):**
```javascript
static DOWNLOAD_STAGES = {
  CONNECTING: { label: 'Connecting...', percent: 0 },
  DOWNLOADING: { label: 'Downloading...', percent: 1 },
  VERIFYING: { label: 'Verifying...', percent: 95 },
  COMPLETE: { label: 'Complete', percent: 100 }
};
```

3. **Add download overlay components:**
   - Reuse existing progressContainer for download progress
   - Add downloadSpeedLabel (PIXI.Text) showing speed like "1.2 MB/s"
   - Add downloadTimeLabel (PIXI.Text) showing "2:30 remaining"
   - Position below progress bar, smaller font (8px)

4. **Add setDownloadProgress method:**
```javascript
setDownloadProgress(progress) {
  // progress: { loaded, total, percent, speed, timeRemaining }
  // - Show progress bar at percent
  // - Show speed as "X.X MB/s" or "XXX KB/s"
  // - Show timeRemaining as "M:SS remaining"
  // - Update progressLabel with percentage
}
```

5. **Add setDownloading method:**
```javascript
setDownloading(isDownloading) {
  // - Set status to 'downloading'
  // - Show progressContainer
  // - Enable click-to-cancel behavior
  this._isDownloading = isDownloading;
}
```

6. **Add showVerificationStatus method:**
```javascript
showVerificationStatus(verified, hash) {
  // verified: boolean
  // - Show checkmark or X icon briefly
  // - Update cacheStatusIndicator
  // - Emit 'verification-complete' event
}
```

7. **Add cancel download behavior:**
   - When _isDownloading is true, single click emits 'cancel-download' instead of 'selected'
   - Visual hint: cursor changes to 'not-allowed' during download

8. **Integrate with existing setStatus:**
   - When status='downloading', show download progress overlay
   - When status changes from 'downloading', hide download-specific labels

Do NOT create a separate overlay container - reuse progressContainer.
Do NOT block interaction during download - allow cancel.
  </action>
  <verify>
    - setDownloadProgress() method exists and updates progress bar
    - Speed and time remaining labels display during download
    - setDownloading() toggles download state
    - showVerificationStatus() shows checkmark/X for verification
    - Click during download emits 'cancel-download' event
  </verify>
  <done>
    - RTSDesktopObject shows download progress with percent, speed, time remaining
    - Download state is visually distinct from booting state
    - Click-to-cancel works during download
    - Verification status shows briefly before boot starts
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate RemoteBootFetcher with DesktopObjectManager</name>
  <files>systems/visual_shell/web/DesktopObjectManager.js</files>
  <action>
Extend DesktopObjectManager to handle remote container boot with download progress:

1. **Import RemoteBootFetcher:**
```javascript
import { RemoteBootFetcher } from './RemoteBootFetcher.js';
```

2. **Track active downloads:**
```javascript
this._activeDownloads = new Map(); // entryId -> RemoteBootFetcher instance
```

3. **Modify boot handling for remote containers:**
   - In _handleBootRequest (or equivalent), check if entry is remote (has sourceServerId)
   - If remote and not cached, start download with progress
   - If remote and cached, use cache-first path (covered in 09-03)

4. **Add _bootRemoteContainer method:**
```javascript
async _bootRemoteContainer(entryId, entry) {
  // 1. Check if already cached (quick check)
  // 2. If cached, proceed to boot (Phase 09-03)
  // 3. If not cached, start download with RemoteBootFetcher
  // 4. Wire up progress callbacks to desktop object
  // 5. On download complete, store in cache and boot
}
```

5. **Add progress callback handler:**
```javascript
_handleDownloadProgress(entryId, progress) {
  const obj = this.objects.get(entryId);
  if (obj) {
    obj.setDownloadProgress(progress);
  }
}
```

6. **Add download completion handler:**
```javascript
_handleDownloadComplete(entryId, result) {
  // result: { data, hash, verified, expectedHash }
  const obj = this.objects.get(entryId);
  if (obj) {
    obj.showVerificationStatus(result.verified, result.hash);
    // After brief delay, start boot
    setTimeout(() => this._startBoot(entryId, result.data), 1000);
  }
}
```

7. **Add cancel download handler:**
```javascript
cancelDownload(entryId) {
  const fetcher = this._activeDownloads.get(entryId);
  if (fetcher) {
    fetcher.cancel();
    this._activeDownloads.delete(entryId);
    const obj = this.objects.get(entryId);
    if (obj) {
      obj.setStatus('idle');
      obj.hideProgress();
    }
  }
}
```

8. **Wire up 'cancel-download' event from RTSDesktopObject:**
   - Listen for 'cancel-download' event on desktop objects
   - Call cancelDownload(entryId)

9. **Handle download errors:**
   - Show error overlay on desktop object
   - Use existing error guidance patterns

Do NOT auto-retry on failure - Phase 11 handles retries.
Do NOT block the UI during download - download is async.
  </action>
  <verify>
    - Remote containers trigger download before boot
    - Progress updates appear on desktop object
    - Download cancellation works via click
    - On completion, verification shows briefly then boot starts
    - Errors display on desktop object with guidance
  </verify>
  <done>
    - Remote container boot flow: click -> download with progress -> verify -> boot
    - DesktopObjectManager uses RemoteBootFetcher for remote containers
    - Progress callbacks update RTSDesktopObject in real-time
    - Cancellation works mid-download
  </done>
</task>

</tasks>

<verification>
1. RTSDesktopObject has downloading state with progress overlay
2. Download progress shows percent, speed, time remaining
3. Click-to-cancel works during download
4. Verification status displays after download
5. DesktopObjectManager integrates RemoteBootFetcher
6. Remote containers download then boot automatically
</verification>

<success_criteria>
- User sees real-time download progress on remote container click
- Progress includes percentage, speed (KB/s or MB/s), and time remaining
- Hash verification shows checkmark (success) or X (failure) after download
- Downloaded container boots automatically after verification
- User can cancel download with a click
</success_criteria>

<output>
After completion, create `.planning/phases/09-remote-boot/09-02-SUMMARY.md`
</output>
