---
phase: 09-remote-boot
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/visual_shell/web/RemoteBootFetcher.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can initiate download of a remote container"
    - "User sees real-time download progress with percentage"
    - "User sees download speed and estimated time remaining"
    - "User can cancel an in-progress download"
    - "Download automatically verifies hash on completion"
  artifacts:
    - path: "systems/visual_shell/web/RemoteBootFetcher.js"
      provides: "Streaming download with progress callbacks"
      exports: ["RemoteBootFetcher"]
      min_lines: 200
  key_links:
    - from: "RemoteBootFetcher"
      to: "fetch API"
      via: "ReadableStream reader"
      pattern: "getReader\\(\\)"
    - from: "RemoteBootFetcher"
      to: "CatalogCacheManager"
      via: "hash verification after download"
      pattern: "cache\\.verifyHash"
---

<objective>
Create RemoteBootFetcher class that handles streaming downloads of remote containers with real-time progress tracking.

Purpose: Enable users to download containers from remote servers with visual feedback on download progress, speed, and time remaining. This is the foundation for remote boot functionality.

Output: RemoteBootFetcher.js with streaming download, progress callbacks, cancellation support, and hash verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-remote-boot/09-CONTEXT.md

# Existing patterns to follow
@systems/visual_shell/web/CatalogCacheManager.js
@systems/visual_shell/web/RemoteCatalogClient.js
@systems/visual_shell/web/CatalogBridge.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RemoteBootFetcher with streaming download</name>
  <files>systems/visual_shell/web/RemoteBootFetcher.js</files>
  <action>
Create a new RemoteBootFetcher class with the following capabilities:

1. **Streaming download using ReadableStream:**
   - Use fetch() with ReadableStream reader for chunked download
   - Collect chunks into a single ArrayBuffer for storage
   - Track total bytes downloaded and content-length for progress

2. **Progress tracking:**
   - onProgress callback with object: { loaded, total, percent, speed, timeRemaining }
   - Speed calculation: bytes per second based on elapsed time
   - Time remaining: (total - loaded) / speed
   - Smooth speed averaging over last 3 seconds (prevent jitter)

3. **Cancellation support:**
   - AbortController for cancelling fetch mid-stream
   - cancel() method that aborts and cleans up
   - onCancel callback for UI notification

4. **Hash verification integration:**
   - Import CatalogCacheManager for hash computation
   - onComplete callback with { data, hash, verified, expectedHash }
   - Verify hash if expectedHash provided in options

5. **Error handling:**
   - Network errors, timeout errors, abort errors
   - onError callback with { error, stage, bytesLoaded }
   - Stage values: 'connecting', 'downloading', 'verifying'

6. **Class structure:**
```javascript
class RemoteBootFetcher {
  static DEFAULT_TIMEOUT = 60000; // 60 seconds for large containers

  constructor(options = {}) {
    this.timeout = options.timeout || RemoteBootFetcher.DEFAULT_TIMEOUT;
    this.abortController = null;
    this._startTime = null;
    this._bytesLoaded = 0;
    this._speedSamples = []; // For speed smoothing
  }

  async fetch(url, options = {}) {
    // options: { expectedHash, onProgress, onComplete, onError, onCancel }
  }

  cancel() { /* Abort download */ }
}
```

Follow the ES6 export + window attachment pattern used in other modules:
```javascript
export { RemoteBootFetcher };
if (typeof window !== 'undefined') {
  window.RemoteBootFetcher = RemoteBootFetcher;
}
```

Do NOT use XMLHttpRequest - use native fetch with ReadableStream.
Do NOT download to blob first then convert - stream directly to ArrayBuffer chunks.
  </action>
  <verify>
    - File exists at systems/visual_shell/web/RemoteBootFetcher.js
    - JSHint or visual inspection shows no syntax errors
    - Class has fetch(), cancel() methods
    - Uses ReadableStream reader pattern (getReader())
    - Has ES6 export and window attachment
  </verify>
  <done>
    - RemoteBootFetcher.js created with streaming download support
    - Progress callbacks include percent, speed, timeRemaining
    - Cancellation via AbortController works
    - Hash verification integrated with CatalogCacheManager
  </done>
</task>

<task type="auto">
  <name>Task 2: Add error handling and edge cases</name>
  <files>systems/visual_shell/web/RemoteBootFetcher.js</files>
  <action>
Enhance RemoteBootFetcher with robust error handling:

1. **Timeout handling:**
   - Overall download timeout (default 60s, configurable)
   - Use AbortController.signal with setTimeout
   - Clear timeout on successful completion

2. **Network error categories:**
   - DNS failure (no connection to host)
   - Connection refused (server down)
   - HTTP 4xx errors (404 Not Found, 403 Forbidden)
   - HTTP 5xx errors (server errors)
   - Network timeout
   - User cancellation (abort)

3. **Error callback format:**
```javascript
onError({
  error: Error,
  type: 'network' | 'timeout' | 'http' | 'cancelled' | 'verification',
  stage: 'connecting' | 'downloading' | 'verifying',
  httpStatus: number | null,
  bytesLoaded: number,
  message: string // Human-readable error message
})
```

4. **Edge cases:**
   - Content-Length header missing (progress shows bytes only, no percent)
   - Zero-byte response (error)
   - Server sends more bytes than Content-Length (warning, continue)
   - Hash mismatch (verification error, data still provided)

5. **Retry information:**
   - Include retryable: boolean in error object
   - Network/timeout/5xx = retryable
   - 4xx/cancelled/verification = not retryable

Do NOT auto-retry - retry logic is in a later phase (Phase 11).
  </action>
  <verify>
    - Error callback receives structured error object
    - Timeout triggers abort with correct error type
    - HTTP errors include status code
    - Verification failures have type='verification'
    - retryable boolean correctly set for each error type
  </verify>
  <done>
    - All error paths handled with structured error objects
    - Error types distinguish between network, timeout, HTTP, cancelled, verification
    - retryable flag enables future retry logic
    - Edge cases handled gracefully
  </done>
</task>

</tasks>

<verification>
1. RemoteBootFetcher.js exists with streaming download implementation
2. Progress callbacks fire with percent, speed, timeRemaining
3. Cancellation works via AbortController
4. Hash verification uses CatalogCacheManager
5. Error handling covers all network failure modes
6. ES6 export pattern matches existing modules
</verification>

<success_criteria>
- RemoteBootFetcher class can download a remote container with streaming
- Real-time progress includes percentage, speed (KB/s), time remaining
- Download can be cancelled mid-stream
- Hash verification runs automatically after download
- All error cases return structured error objects
</success_criteria>

<output>
After completion, create `.planning/phases/09-remote-boot/09-01-SUMMARY.md`
</output>
