---
phase: 18-privileged-architecture
plan: 05
type: execute
wave: 5
depends_on: [18-04]
files_modified:
  - systems/visual_shell/web/RiscvExecutionPanel.js
  - systems/visual_shell/web/demo_privileged.html
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can see SBI console output in the execution panel"
    - "User can see privileged mode indicator in the UI"
    - "User can verify M-mode/S-mode transitions visually"
  artifacts:
    - path: "systems/visual_shell/web/RiscvExecutionPanel.js"
      provides: "UI with SBI console output"
      contains: "sbiConsole"
      contains: "handleSBI"
    - path: "systems/visual_shell/web/demo_privileged.html"
      provides: "Demo page for privileged execution"
      contains: "RiscvExecutionPanel"
  key_links:
    - from: "RiscvExecutionPanel"
      to: "SbiBridge"
      via: "poll and handleCall"
      pattern: "sbiBridge"
---

<objective>
Integrate SBI bridge with visual shell execution panel

Purpose: Users need to see kernel console output and system calls in the UI. This completes the user-facing verification for privileged mode support.
Output: Execution panel with SBI console output, privilege mode indicator
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-privileged-architecture/18-RESEARCH.md
@.planning/phases/18-privileged-architecture/18-04-SUMMARY.md

# Reference existing components
@systems/visual_shell/web/RiscvExecutionPanel.js
@systems/visual_shell/web/SbiBridge.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SBI console output to execution panel</name>
  <files>systems/visual_shell/web/RiscvExecutionPanel.js</files>
  <action>
Extend RiscvExecutionPanel to include SBI console output:

1. Add a console output div to the panel HTML (in _createPanelHTML method):
```javascript
// Add after the memory inspector section
<div class="sbi-console">
    <h4>SBI Console</h4>
    <div id="sbi-output" class="console-output"></div>
</div>
```

2. Add SBI polling to the execution loop (in execute method):
```javascript
// After GPU dispatch, poll for SBI calls
if (this.sbiBridge) {
    const sbiResult = await this.sbiBridge.poll();
    if (sbiResult) {
        this._handleSBIOutput(sbiResult);
    }
}
```

3. Add handler method:
```javascript
_handleSBIOutput(result) {
    const outputDiv = document.getElementById('sbi-output');
    if (result.type === 'console') {
        outputDiv.textContent += result.char;
        outputDiv.scrollTop = outputDiv.scrollHeight;
    } else if (result.type === 'reset') {
        outputDiv.textContent += `\n[System Reset: type=${result.resetType}, reason=${result.resetReason}]`;
    }
}
```

4. Initialize SbiBridge in constructor:
```javascript
import { SbiBridge } from './SbiBridge.js';

constructor(container, device, queue) {
    // ... existing code ...
    this.sbiBridge = new SbiBridge(device, this.memoryBuffer);
}
```

5. Add CSS for console output:
```css
.console-output {
    background: #0a0a0a;
    border: 1px solid #333;
    padding: 8px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
}
```
  </action>
  <verify>grep -c "sbiBridge" systems/visual_shell/web/RiscvExecutionPanel.js</verify>
  <done>SbiBridge integrated, console output div exists, polling happens during execution</done>
</task>

<task type="auto">
  <name>Task 2: Add privilege mode indicator</name>
  <files>systems/visual_shell/web/RiscvExecutionPanel.js</files>
  <action>
Add a privilege mode indicator to the register display:

1. Add to the register display section in _createPanelHTML:
```javascript
<div class="privilege-indicator">
    <span>Mode: </span>
    <span id="priv-mode" class="mode-badge mode-m">M</span>
</div>
```

2. Add update method called after state readback:
```javascript
_updatePrivilegeMode(state) {
    const mode = state[37];  // CSR_MODE index
    const modeSpan = document.getElementById('priv-mode');
    if (mode === 3) {
        modeSpan.textContent = 'M';
        modeSpan.className = 'mode-badge mode-m';
    } else if (mode === 1) {
        modeSpan.textContent = 'S';
        modeSpan.className = 'mode-badge mode-s';
    } else {
        modeSpan.textContent = 'U';
        modeSpan.className = 'mode-badge mode-u';
    }
}
```

3. Add CSS:
```css
.privilege-indicator {
    margin: 8px 0;
}
.mode-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: bold;
}
.mode-m { background: #ff6600; color: white; }
.mode-s { background: #0066ff; color: white; }
.mode-u { background: #666; color: white; }
```

4. Call _updatePrivilegeMode in the state update callback.
  </action>
  <verify>grep -c "priv-mode" systems/visual_shell/web/RiscvExecutionPanel.js</verify>
  <done>Privilege mode badge displays M/S/U based on CSR_MODE value</done>
</task>

<task type="auto">
  <name>Task 3: Create demo page with privileged example</name>
  <files>systems/visual_shell/web/demo_privileged.html</files>
  <action>
Create a new demo page for privileged execution following demo_riscv_execution.html pattern.

Include example programs that demonstrate:
1. M-mode CSR access:
```javascript
const exampleMMode = `# M-mode CSR Example
# Write to mscratch
0x3400d073  # csrw mscratch, x1 (where x1=0x1234)
# Read back with csrrs
0x1400d173  # csrrs x2, mscratch, x0 (read only)
# Check mstatus
0x3000a173  # csrrs x2, mstatus, x0
`;
```

2. Mode transition (M to S):
```javascript
const exampleModeTransition = `# Mode Transition Example
# Set up for transition to S-mode
0x34001073  # csrw mscratch, x0
# Set mstatus.MPP=1 (S-mode) and MPV=0
# ... mret will transition
`;
```

3. SBI console output:
```javascript
const exampleSBI = `# SBI Console Output
# Load 'H' into a0
0x04800513  # li a0, 'H'
# Set a7 = 0x01 (console putchar)
0x00100893  # li a7, 1
# ECALL
0x00000073  # ecall
`;
```

The page should show:
- WebGPU status
- Execution panel with all new features
- Example program selector
- Clear instructions for what to observe
  </action>
  <verify>grep -c "demo_privileged" systems/visual_shell/web/demo_privileged.html</verify>
  <done>Demo page exists with 3 example programs showing privileged features</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete privileged execution UI:
- SBI console output display
- Privilege mode indicator (M/S/U badge)
- Demo page with example programs
- Integration with SbiBridge for polling
  </what-built>
  <how-to-verify>
1. Open demo_privileged.html in a WebGPU-capable browser (Chrome 113+)
2. Verify the page loads without errors
3. Load the "SBI Console Output" example program
4. Click "Execute" and verify:
   - The privilege mode badge shows "M" (M-mode)
   - The SBI Console section shows "H" character output
   - No JavaScript errors in browser console
5. Load the "M-mode CSR" example and verify:
   - Register x2 shows the mscratch value after CSRRS
   - Mode badge updates correctly
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. RiscvExecutionPanel.js has no syntax errors
2. SbiBridge is correctly imported and initialized
3. Privilege mode indicator updates based on CSR_MODE
4. Demo page loads and displays execution panel
</verification>

<success_criteria>
- SBI console output visible in execution panel
- Privilege mode badge shows M/S/U correctly
- Demo page demonstrates all privileged features
- User can verify M-mode execution visually
</success_criteria>

<output>
After completion, create `.planning/phases/18-privileged-architecture/18-05-SUMMARY.md`
</output>
