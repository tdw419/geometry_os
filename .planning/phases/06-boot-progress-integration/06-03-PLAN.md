---
phase: 06-boot-progress-integration
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
  - 06-02
files_modified:
  - systems/visual_shell/web/RTSDesktopObject.js
  - systems/visual_shell/web/DesktopObjectManager.js
autonomous: true

must_haves:
  truths:
    - "Error messages display inline on object when boot fails"
    - "Error shows failed stage, elapsed time, and boot config"
    - "Actionable guidance provided for common failure modes"
    - "Hover tooltip shows detailed error information"
  artifacts:
    - path: "systems/visual_shell/web/RTSDesktopObject.js"
      provides: "Error display overlay with actionable guidance"
      contains: ["showError", "_errorOverlay", "ERROR_GUIDANCE"]
    - path: "systems/visual_shell/web/DesktopObjectManager.js"
      provides: "Error capture and display coordination"
      contains: ["handleBootError", "ERROR_GUIDANCE"]
  key_links:
    - from: "RTSDesktopObject.showError()"
      to: "PIXI.Container"
      via: "error overlay on thumbnail"
      pattern: "errorOverlay|errorContainer"
    - from: "DesktopObjectManager._handleStatusUpdate()"
      to: "RTSDesktopObject.showError()"
      via: "error status triggers display"
      pattern: "showError.*status"
---

<objective>
Add comprehensive error handling with actionable guidance. When boot fails, users see the failed stage, elapsed time, boot configuration used, and specific suggestions for fixing the problem.

Purpose: Satisfy BOOT-03 requirement - users see clear error messages when boot fails with actionable guidance.
Output: Updated RTSDesktopObject.js with error overlay, updated DesktopObjectManager.js with error guidance mapping
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-boot-progress-integration/06-CONTEXT.md

# Existing implementations to extend
@systems/visual_shell/web/RTSDesktopObject.js
@systems/visual_shell/web/DesktopObjectManager.js

# Design decisions from context
- Error capture: Failed stage, elapsed time, boot config
- NOT captured: QEMU stderr/stdout (too verbose for UI)
- Presentation: Inline on object + expandable details
- Timeout: 30 seconds maximum before marking as error
- Error format: Stage failed, elapsed time, config used, actionable guidance
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error guidance constants</name>
  <files>systems/visual_shell/web/RTSDesktopObject.js</files>
  <action>
Add error guidance mapping to provide actionable suggestions for common failure modes.

Add after the PROGRESS static property (around line 48):

```javascript
/**
 * Error guidance messages for common failure modes
 * Maps error patterns to actionable suggestions
 * @static
 */
static ERROR_GUIDANCE = {
    timeout: {
        pattern: /timeout|timed out|30 seconds/i,
        guidance: 'Boot took too long. Try increasing memory or use a lighter kernel.',
        action: 'Increase memory allocation or check kernel compatibility.'
    },
    memory: {
        pattern: /memory|oom|out of memory|cannot allocate/i,
        guidance: 'Insufficient memory for boot. Increase memory allocation.',
        action: 'Increase memory to at least 2G for most distributions.'
    },
    kernel: {
        pattern: /kernel|vmlinuz|bzImage|boot failed/i,
        guidance: 'Kernel failed to load. Check kernel compatibility.',
        action: 'Verify the kernel is compatible with this architecture.'
    },
    fuse: {
        pattern: /fuse|mount|failed to mount/i,
        guidance: 'FUSE mount failed. Check if FUSE is installed.',
        action: 'Ensure fuse3 or fuse is installed: sudo apt install fuse3'
    },
    qemu: {
        pattern: /qemu|kvm|accelerator|hv_error/i,
        guidance: 'QEMU or KVM error. Check virtualization support.',
        action: 'Enable virtualization in BIOS or install qemu-system-x86'
    },
    permission: {
        pattern: /permission|denied|access|eacces/i,
        guidance: 'Permission denied. Check file permissions.',
        action: 'Ensure the .rts.png file is readable and executable.'
    },
    default: {
        pattern: /.*/,
        guidance: 'Boot failed. Check logs for details.',
        action: 'Try different boot options or check system compatibility.'
    }
};
```
</action>
  <verify>node -e "const fs = require('fs'); const code = fs.readFileSync('systems/visual_shell/web/RTSDesktopObject.js', 'utf8'); console.log(code.includes('ERROR_GUIDANCE') && code.includes('guidance') ? 'OK' : 'FAIL')"</verify>
  <done>Error guidance constants added</done>
</task>

<task type="auto">
  <name>Task 2: Add error overlay visual components</name>
  <files>systems/visual_shell/web/RTSDesktopObject.js</files>
  <action>
Add error overlay that displays on the thumbnail when boot fails.

Add after _createProgressBar() method (around line 280):

```javascript
/**
 * Create the error overlay container
 * @private
 */
_createErrorOverlay() {
    const { THUMBNAIL_SIZE, OBJECT_WIDTH, PADDING } = RTSDesktopObject.DIMENSIONS;

    // Error overlay container (hidden by default)
    this.errorContainer = new PIXI.Container();
    this.errorContainer.visible = false;
    this.errorContainer.x = (OBJECT_WIDTH - THUMBNAIL_SIZE) / 2;
    this.errorContainer.y = PADDING + 4;
    this.addChild(this.errorContainer);

    // Semi-transparent red background
    this.errorBackground = new PIXI.Graphics();
    this.errorBackground.rect(0, 0, THUMBNAIL_SIZE, THUMBNAIL_SIZE);
    this.errorBackground.fill({ color: 0x330000, alpha: 0.85 });
    this.errorContainer.addChild(this.errorBackground);

    // Error icon (warning triangle)
    this.errorIcon = new PIXI.Text({
        text: '!',
        style: {
            fontFamily: 'Arial, sans-serif',
            fontSize: 48,
            fill: 0xff4444,
            fontWeight: 'bold',
            align: 'center'
        }
    });
    this.errorIcon.x = THUMBNAIL_SIZE / 2;
    this.errorIcon.y = 20;
    this.errorIcon.anchor.set(0.5, 0);
    this.errorContainer.addChild(this.errorIcon);

    // Error title
    this.errorTitle = new PIXI.Text({
        text: 'Boot Failed',
        style: {
            fontFamily: 'Courier New, monospace',
            fontSize: 11,
            fill: 0xff6666,
            fontWeight: 'bold',
            align: 'center',
            wordWrap: true,
            wordWrapWidth: THUMBNAIL_SIZE - 8
        }
    });
    this.errorTitle.x = THUMBNAIL_SIZE / 2;
    this.errorTitle.y = 75;
    this.errorTitle.anchor.set(0.5, 0);
    this.errorContainer.addChild(this.errorTitle);

    // Error message (truncated)
    this.errorMessage = new PIXI.Text({
        text: '',
        style: {
            fontFamily: 'Courier New, monospace',
            fontSize: 9,
            fill: 0xcccccc,
            align: 'center',
            wordWrap: true,
            wordWrapWidth: THUMBNAIL_SIZE - 8
        }
    });
    this.errorMessage.x = THUMBNAIL_SIZE / 2;
    this.errorMessage.y = 92;
    this.errorMessage.anchor.set(0.5, 0);
    this.errorContainer.addChild(this.errorMessage);

    // Guidance text
    this.errorGuidance = new PIXI.Text({
        text: '',
        style: {
            fontFamily: 'Courier New, monospace',
            fontSize: 8,
            fill: 0x88ccff,
            align: 'center',
            wordWrap: true,
            wordWrapWidth: THUMBNAIL_SIZE - 12
        }
    });
    this.errorGuidance.x = THUMBNAIL_SIZE / 2;
    this.errorGuidance.y = 115;
    this.errorGuidance.anchor.set(0.5, 0);
    this.errorContainer.addChild(this.errorGuidance);

    // Store error details for tooltip
    this._errorDetails = null;
}
```

Call _createErrorOverlay() in constructor after _createProgressBar():
```javascript
this._createErrorOverlay();  // Add after this._createProgressBar();
```
</action>
  <verify>node -e "const fs = require('fs'); const code = fs.readFileSync('systems/visual_shell/web/RTSDesktopObject.js', 'utf8'); console.log(code.includes('_createErrorOverlay') && code.includes('errorContainer') ? 'OK' : 'FAIL')"</verify>
  <done>Error overlay visual components created</done>
</task>

<task type="auto">
  <name>Task 3: Add showError() method with guidance</name>
  <files>systems/visual_shell/web/RTSDesktopObject.js</files>
  <action>
Add the public showError() method to display error with guidance.

Add after failBootProgress() method (around line 590):

```javascript
/**
 * Show error overlay with detailed message and guidance
 * @param {Object} errorInfo - Error information
 * @param {string} errorInfo.message - Error message from server
 * @param {string} errorInfo.stage - Boot stage where error occurred
 * @param {number} errorInfo.elapsedTime - Time elapsed before failure
 * @param {Object} errorInfo.config - Boot configuration used
 */
showError(errorInfo) {
    const { message, stage, elapsedTime, config } = errorInfo;

    // Store details for tooltip
    this._errorDetails = {
        message,
        stage: stage || 'Unknown',
        elapsedTime: elapsedTime || 0,
        config: config || {},
        timestamp: Date.now()
    };

    // Find matching guidance
    const guidance = this._getErrorGuidance(message);

    // Update error display
    this.errorTitle.text = 'Boot Failed';
    this.errorMessage.text = this._truncateText(message || 'Unknown error', 80);

    // Show guidance if available
    if (guidance) {
        this.errorGuidance.text = guidance.action;
    } else {
        this.errorGuidance.text = RTSDesktopObject.ERROR_GUIDANCE.default.action;
    }

    // Show overlay
    this.errorContainer.visible = true;
    this.progressContainer.visible = false;

    // Set error status
    this.setStatus('error');
}

/**
 * Get guidance for an error message
 * @private
 * @param {string} message - Error message
 * @returns {Object|null} Guidance object or null
 */
_getErrorGuidance(message) {
    if (!message) return null;

    const { ERROR_GUIDANCE } = RTSDesktopObject;

    for (const [key, info] of Object.entries(ERROR_GUIDANCE)) {
        if (key === 'default') continue;
        if (info.pattern.test(message)) {
            return info;
        }
    }

    return ERROR_GUIDANCE.default;
}

/**
 * Truncate text to fit in display
 * @private
 * @param {string} text - Text to truncate
 * @param {number} maxLength - Maximum length
 * @returns {string} Truncated text
 */
_truncateText(text, maxLength) {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength - 3) + '...';
}

/**
 * Hide the error overlay
 */
hideError() {
    this.errorContainer.visible = false;
    this._errorDetails = null;
}

/**
 * Get error details for tooltip
 * @returns {Object|null} Error details
 */
getErrorDetails() {
    return this._errorDetails;
}
```
</action>
  <verify>node -e "const fs = require('fs'); const code = fs.readFileSync('systems/visual_shell/web/RTSDesktopObject.js', 'utf8'); console.log(code.includes('showError') && code.includes('_getErrorGuidance') ? 'OK' : 'FAIL')"</verify>
  <done>showError() method with guidance added</done>
</task>

<task type="auto">
  <name>Task 4: Update failBootProgress to use showError</name>
  <files>systems/visual_shell/web/RTSDesktopObject.js</files>
  <action>
Update failBootProgress() to use the new showError() method.

Replace the existing failBootProgress() method with:

```javascript
/**
 * Fail boot progress with error
 * @param {string} errorMessage - Error message to display
 * @param {Object} options - Additional error context
 * @param {string} options.stage - Boot stage where error occurred
 * @param {number} options.elapsedTime - Time elapsed before failure
 * @param {Object} options.config - Boot configuration used
 */
failBootProgress(errorMessage, options = {}) {
    if (this._progressAnimationId) {
        cancelAnimationFrame(this._progressAnimationId);
        this._progressAnimationId = null;
    }

    // Calculate elapsed time if not provided
    const elapsedTime = options.elapsedTime ||
        (this._bootStartTime ? (Date.now() - this._bootStartTime) / 1000 : 0);

    // Get current stage
    const stage = options.stage ||
        (this._progressStage ? this._progressStage.label : 'Unknown');

    // Show comprehensive error
    this.showError({
        message: errorMessage,
        stage,
        elapsedTime,
        config: options.config || {}
    });

    this._bootStartTime = null;
}
```
</action>
  <verify>node -e "const fs = require('fs'); const code = fs.readFileSync('systems/visual_shell/web/RTSDesktopObject.js', 'utf8'); console.log(code.includes('failBootProgress') && code.includes('showError') ? 'OK' : 'FAIL')"</verify>
  <done>failBootProgress() updated to use showError()</done>
</task>

<task type="auto">
  <name>Task 5: Add hover tooltip for error details</name>
  <files>systems/visual_shell/web/RTSDesktopObject.js</files>
  <action>
Update the hover handlers to emit error details for tooltip display.

Update _onPointerOver() to include error info (around line 282):

```javascript
/**
 * Handle pointer over (hover start)
 * @private
 */
_onPointerOver() {
    if (!this._highlighted) {
        this.border.alpha = 1;
        this.border.clear();
        this.border.rect(-1, -1, 142, 182);
        this.border.stroke({ color: 0x00ffff, width: 2, alpha: 0.8 });
    }

    // Emit hover with status and error details
    this.emit('hover', {
        target: this,
        status: this._status,
        errorDetails: this._errorDetails,
        statusInfo: this._statusInfo
    });
}
```

Add a method to format error details for display:

```javascript
/**
 * Format error details for tooltip display
 * @returns {string|null} Formatted error text
 */
formatErrorForTooltip() {
    if (!this._errorDetails) return null;

    const { message, stage, elapsedTime, config } = this._errorDetails;
    const guidance = this._getErrorGuidance(message);

    let text = `Boot failed at: ${stage}\n`;
    text += `After: ${elapsedTime.toFixed(1)} seconds\n`;
    if (config.memory || config.cpus) {
        text += `Config: Memory=${config.memory || 'default'}, CPUs=${config.cpus || 'default'}\n`;
    }
    text += `\n${guidance.guidance}`;
    text += `\n\nSuggestion: ${guidance.action}`;

    return text;
}
```
</action>
  <verify>node -e "const fs = require('fs'); const code = fs.readFileSync('systems/visual_shell/web/RTSDesktopObject.js', 'utf8'); console.log(code.includes('formatErrorForTooltip') && code.includes('errorDetails') ? 'OK' : 'FAIL')"</verify>
  <done>Hover tooltip for error details added</done>
</task>

<task type="auto">
  <name>Task 6: Add error handling to DesktopObjectManager</name>
  <files>systems/visual_shell/web/DesktopObjectManager.js</files>
  <action>
Update DesktopObjectManager to capture and pass error context.

Update _handleStatusUpdate() to include error context (around line 420):

```javascript
/**
 * Handle status update from polling
 * @private
 * @param {string} entryId - Entry ID that was polled
 * @param {Object} status - Status object from server
 */
_handleStatusUpdate(entryId, status) {
    const obj = this.objects.get(entryId);
    if (!obj) {
        this.stopStatusPolling(entryId);
        return;
    }

    // Update object status
    const previousStatus = obj.getStatus();
    obj.setStatus(status.status);

    // Handle status transitions
    if (status.status === 'running' && previousStatus === 'booting') {
        // Boot completed successfully
        console.log(`[DesktopObjectManager] ${entryId} boot completed`);
        this.emit('boot-completed', { entryId, status, object: obj });
        this.stopStatusPolling(entryId);
    } else if (status.status === 'error') {
        // Boot failed - capture context
        console.log(`[DesktopObjectManager] ${entryId} boot failed:`, status.error_message);

        // Get boot config from last boot attempt
        const bootConfig = obj._lastBootConfig || {};

        obj.failBootProgress(status.error_message, {
            stage: this._estimateFailedStage(status),
            elapsedTime: status.uptime_seconds || 0,
            config: bootConfig
        });

        this.emit('boot-failed', {
            entryId,
            status,
            object: obj,
            error: status.error_message
        });
        this.stopStatusPolling(entryId);
    } else if (status.status === 'stopped') {
        // Process stopped
        this.stopStatusPolling(entryId);
    }

    // Store additional status info on object
    obj._statusInfo = status;

    this.emit('status-updated', { entryId, status, object: obj });
}

/**
 * Estimate which boot stage failed based on timing
 * @private
 * @param {Object} status - Status object with timing info
 * @returns {string} Stage label
 */
_estimateFailedStage(status) {
    const elapsed = status.uptime_seconds || 0;

    if (elapsed < 5) {
        return 'Starting QEMU...';
    } else if (elapsed < 15) {
        return 'Loading kernel...';
    } else if (elapsed < 25) {
        return 'Initializing...';
    } else {
        return 'Ready';
    }
}
```

Update bootObject() to store boot config for error context:

Add before the try block in bootObject():
```javascript
// Store boot config for error context
obj._lastBootConfig = {
    memory: options.memory || '2G',
    cpus: options.cpus || 2,
    cmdline: options.cmdline
};
```
</action>
  <verify>node -e "const fs = require('fs'); const code = fs.readFileSync('systems/visual_shell/web/DesktopObjectManager.js', 'utf8'); console.log(code.includes('_estimateFailedStage') && code.includes('_lastBootConfig') ? 'OK' : 'FAIL')"</verify>
  <done>Error handling added to DesktopObjectManager</done>
</task>

</tasks>

<verification>
- [ ] ERROR_GUIDANCE constant defines patterns and actions
- [ ] _createErrorOverlay() creates error display container
- [ ] showError() displays error with guidance
- [ ] _getErrorGuidance() matches error patterns
- [ ] failBootProgress() uses showError()
- [ ] formatErrorForTooltip() formats details for display
- [ ] Hover emits error details
- [ ] DesktopObjectManager captures boot config
- [ ] _handleStatusUpdate() passes error context
- [ ] _estimateFailedStage() estimates failure stage
</verification>

<success_criteria>
- Error overlay displays on thumbnail when boot fails
- Error shows failed stage and elapsed time
- Actionable guidance provided based on error type
- Hover tooltip shows detailed error information
- Common failure modes have specific suggestions
- Error display is clear and not overwhelming
</success_criteria>

<output>
After completion, create `.planning/phases/06-boot-progress-integration/06-03-SUMMARY.md`
</output>
