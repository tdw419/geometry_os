---
phase: 15-boot-menu
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/pixel_compiler/pxe/http_server.py
  - systems/pixel_compiler/pxe/pxe_cli.py
autonomous: true
must_haves:
  truths:
    - "Administrator can set default boot entry"
    - "Administrator can configure auto-boot timeout"
    - "Menu auto-selects default after timeout expires"
  artifacts:
    - path: "systems/pixel_compiler/pxe/http_server.py"
      provides: "Menu configuration with default and timeout"
      contains: "default_entry, menu_timeout"
    - path: "systems/pixel_compiler/pxe/pxe_cli.py"
      provides: "CLI options for menu configuration"
      exports: ["--default-entry", "--menu-timeout"]
  key_links:
    - from: "HTTPServerConfig"
      to: "menu.ipxe generation"
      via: "configuration attributes"
      pattern: "self\\.config\\.(default_entry|menu_timeout)"
    - from: "CLI args"
      to: "HTTPServerConfig"
      via: "argument parsing"
      pattern: "--default-entry|--menu-timeout"
---

<objective>
Add menu configuration options for default boot entry and auto-boot timeout.

Purpose: Allow administrators to configure which container boots by default and how long to wait for user input.
Output: Extended HTTPServerConfig with menu options, updated menu script with timeout and default selection, CLI arguments for configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@systems/pixel_compiler/pxe/http_server.py
@systems/pixel_compiler/pxe/pxe_cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add menu configuration to HTTPServerConfig</name>
  <files>systems/pixel_compiler/pxe/http_server.py</files>
  <action>
Extend HTTPServerConfig dataclass with menu configuration options.

Add the following fields to HTTPServerConfig:
- `default_entry: str = "local"` - Default boot entry ID (entry_id of container, or "local" for local disk)
- `menu_timeout: int = 10` - Auto-boot timeout in seconds (0 = no timeout, wait forever)

These will be used by the menu script to auto-select after timeout.

Update the dataclass definition around line 56-66:
```python
@dataclass
class HTTPServerConfig:
    """Configuration for HTTP server."""
    interface: str = "0.0.0.0"
    listen_port: int = 8080
    root_dir: str = "/tftpboot"
    max_file_size: int = 0
    enable_range_requests: bool = True
    watch_paths: Optional[List[str]] = None
    use_vision: bool = False
    # Menu configuration
    default_entry: str = "local"  # Default boot entry ID or "local"
    menu_timeout: int = 10        # Auto-boot timeout in seconds (0 = no timeout)
```
</action>
  <verify>HTTPServerConfig class has default_entry and menu_timeout attributes</verify>
  <done>HTTPServerConfig includes menu configuration fields</done>
</task>

<task type="auto">
  <name>Task 2: Update menu script with timeout and default</name>
  <files>systems/pixel_compiler/pxe/http_server.py</files>
  <action>
Update the `_handle_menu_script` method to use menu configuration for default selection and timeout.

The menu script should now:
1. Set default selection using `choose --default {{default_entry}} --timeout {{timeout}}`
2. Pass timeout value from config (0 means no timeout, omit --timeout flag)
3. Handle the "local" entry specially - it should be the fallback

Updated iPXE script structure:
```ipxe
#!ipxe
# PixelRTS Container Selection Menu

isset ${menu-default} || set menu-default {{default_entry}}

menu PixelRTS Boot Menu
item --key 0 local Boot from local disk
{{ for each container }}
item --key {{key}} {{entry_id}} {{name}} ({{size}}MB{{#if distro}}, {{distro}}{{/if}})

{{ if timeout > 0 }}
choose --default ${menu-default} --timeout {{timeout}} selected || goto local
{{ else }}
choose --default ${menu-default} selected || goto local
{{ /if }}

echo Booting ${selected}...
goto ${selected}

:local
echo Booting from local disk...
sanboot --no-describe 0x80

{{ for each container }}
:{{entry_id}}
chain http://${next-server}:${http-port}/containers/{{entry_id}} || goto failed
{{ /for }}

:failed
echo Boot failed, returning to menu...
sleep 3
goto start
```

Implementation notes:
- Use `self.config.default_entry` for the default selection
- Use `self.config.menu_timeout` for timeout (if > 0, add --timeout flag)
- The `:boot` label is replaced with per-container labels
- Local boot uses `sanboot --no-describe 0x80` to boot from first hard disk
</action>
  <verify>`curl http://localhost:8080/pxe/menu.ipxe` returns script with `choose --default` and optionally `--timeout`</verify>
  <done>Menu script uses configuration for default entry and timeout</done>
</task>

<task type="auto">
  <name>Task 3: Add CLI arguments for menu configuration</name>
  <files>systems/pixel_compiler/pxe/pxe_cli.py</files>
  <action>
Add CLI arguments for menu configuration to the http start command.

Update the http start subcommand in pxe_cli.py to include menu configuration options:

```python
http_start_parser.add_argument(
    '--default-entry',
    default='local',
    help='Default boot entry ID (default: local)'
)
http_start_parser.add_argument(
    '--menu-timeout',
    type=int,
    default=10,
    help='Menu timeout in seconds, 0 for no timeout (default: 10)'
)
```

Update the handler function to pass these options to HTTPServerConfig:
```python
config = HTTPServerConfig(
    root_dir=args.root_dir,
    listen_port=args.port,
    # ... other options ...
    default_entry=args.default_entry,
    menu_timeout=args.menu_timeout
)
```
</action>
  <verify>`pixelrts pxe http start --help` shows --default-entry and --menu-timeout options</verify>
  <done>CLI has --default-entry and --menu-timeout arguments for http start command</done>
</task>

</tasks>

<verification>
1. Start HTTP server with --default-entry and --menu-timeout options
2. Fetch /pxe/menu.ipxe
3. Verify choose command includes --default flag
4. Verify choose command includes --timeout flag when timeout > 0
5. Verify choose command has no --timeout when timeout = 0
</verification>

<success_criteria>
- HTTPServerConfig has default_entry and menu_timeout fields
- Menu script uses --default flag with configured default entry
- Menu script uses --timeout flag when menu_timeout > 0
- Menu script has local boot fallback with sanboot
- CLI http start command has --default-entry and --menu-timeout options
</success_criteria>

<output>
After completion, create `.planning/phases/15-boot-menu/15-02-SUMMARY.md`
</output>
