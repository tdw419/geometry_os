---
phase: 15-boot-menu
plan: 03
type: execute
wave: 2
depends_on: [15-01, 15-02]
files_modified:
  - systems/pixel_compiler/pxe/http_server.py
  - systems/pixel_compiler/pxe/pxe_cli.py
autonomous: true
must_haves:
  truths:
    - "Administrator can customize container display name in menu"
    - "Administrator can add custom description to menu entries"
    - "Menu displays custom names instead of filenames"
  artifacts:
    - path: "systems/pixel_compiler/pxe/http_server.py"
      provides: "PXEContainerInfo with customization fields"
      contains: "pxe_name, pxe_description"
    - path: "systems/pixel_compiler/pxe/pxe_cli.py"
      provides: "CLI commands for menu customization"
      exports: ["pxe menu list", "pxe menu set"]
  key_links:
    - from: "PXEContainerInfo"
      to: "menu.ipxe generation"
      via: "pxe_name, pxe_description fields"
      pattern: "info\\.(pxe_name|pxe_description)"
---

<objective>
Add menu entry customization support - custom names, descriptions, and boot order for PXE containers.

Purpose: Allow administrators to customize how containers appear in the boot menu.
Output: Extended PXEContainerInfo with customization fields, API endpoints for updating menu entries, CLI commands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@systems/pixel_compiler/pxe/http_server.py
@systems/pixel_compiler/pxe/pxe_cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend PXEContainerInfo with customization fields</name>
  <files>systems/pixel_compiler/pxe/http_server.py</files>
  <action>
Extend the PXEContainerInfo dataclass to support menu customization.

Add the following fields to PXEContainerInfo (around line 35-42):
```python
@dataclass
class PXEContainerInfo:
    """Extended info for PXE-available containers."""
    entry_id: str
    entry: 'CatalogEntry'
    pxe_enabled: bool = True
    pxe_boot_order: int = 0
    # Menu customization
    pxe_name: Optional[str] = None        # Custom display name (None = use entry.name)
    pxe_description: Optional[str] = None # Custom description (None = use distro/arch)
```

Update the menu script generation in `_handle_menu_script` to use these:
- Use `info.pxe_name or info.entry.name` for display name
- Use `info.pxe_description` if set, otherwise generate from metadata

Also update `_refresh_catalog` to preserve these fields when refreshing:
```python
# Preserve PXE settings including customization
old_pxe = self._pxe_containers.copy()
# ... when creating new entries ...
self._pxe_containers[entry.id] = PXEContainerInfo(
    entry_id=entry.id,
    entry=entry,
    pxe_enabled=True,
    pxe_boot_order=len(self._pxe_containers)
    # pxe_name and pxe_description default to None
)
```
</action>
  <verify>PXEContainerInfo has pxe_name and pxe_description fields</verify>
  <done>PXEContainerInfo supports custom display name and description</done>
</task>

<task type="auto">
  <name>Task 2: Add menu entry update API endpoint</name>
  <files>systems/pixel_compiler/pxe/http_server.py</files>
  <action>
Add API endpoint to update menu entry customization.

Add `_handle_pxe_menu_update(self, request: web.Request) -> web.Response` method:
- Route: POST `/pxe/{entry_id}/menu`
- Accept JSON body with optional fields: `name`, `description`, `boot_order`
- Update the PXEContainerInfo with provided values
- Return updated entry info

Implementation:
```python
async def _handle_pxe_menu_update(self, request: web.Request) -> web.Response:
    """Handle POST /pxe/{entry_id}/menu to update menu customization."""
    entry_id = request.match_info.get('entry_id', '')

    if entry_id not in self._pxe_containers:
        raise web.HTTPNotFound(text=f"Container not found: {entry_id}")

    try:
        data = await request.json()
    except Exception:
        raise web.HTTPBadRequest(text="Invalid JSON body")

    info = self._pxe_containers[entry_id]

    # Update fields if provided
    if 'name' in data:
        info.pxe_name = data['name']
    if 'description' in data:
        info.pxe_description = data['description']
    if 'boot_order' in data:
        info.pxe_boot_order = int(data['boot_order'])

    logger.info(f"[HTTP] Updated menu entry for {entry_id}")

    return web.json_response({
        'success': True,
        'entry_id': entry_id,
        'name': info.pxe_name or info.entry.name,
        'description': info.pxe_description,
        'boot_order': info.pxe_boot_order
    })
```

Register the route in `start()` method:
```python
self._app.router.add_post('/pxe/{entry_id}/menu', self._handle_pxe_menu_update)
```

Also update `_handle_pxe_list` to include customization fields in response.
</action>
  <verify>`curl -X POST -d '{"name":"Custom Name"}' http://localhost:8080/pxe/{id}/menu` returns success</verify>
  <done>POST /pxe/{entry_id}/menu endpoint updates menu customization</done>
</task>

<task type="auto">
  <name>Task 3: Add CLI commands for menu management</name>
  <files>systems/pixel_compiler/pxe/pxe_cli.py</files>
  <action>
Add `pxe menu` subcommand group with list and set commands.

Add to pxe_cli.py:

1. Menu subcommand group:
```python
menu_parser = pxe_subparsers.add_parser(
    'menu',
    help='Boot menu management',
    description='Manage PXE boot menu entries'
)
menu_subparsers = menu_parser.add_subparsers(dest='menu_command')
```

2. `pxe menu list` command:
```python
menu_list_parser = menu_subparsers.add_parser(
    'list',
    help='List menu entries',
    description='Show all PXE menu entries with their customization'
)
menu_list_parser.add_argument('--url', '-u', default='http://localhost:8080',
                              help='HTTP server URL')
menu_list_parser.add_argument('--json', action='store_true',
                              help='Output as JSON')
```

3. `pxe menu set` command:
```python
menu_set_parser = menu_subparsers.add_parser(
    'set',
    help='Update menu entry',
    description='Customize a menu entry display'
)
menu_set_parser.add_argument('entry_id', help='Container entry ID')
menu_set_parser.add_argument('--url', '-u', default='http://localhost:8080',
                             help='HTTP server URL')
menu_set_parser.add_argument('--name', '-n', help='Custom display name')
menu_set_parser.add_argument('--description', '-d', help='Custom description')
menu_set_parser.add_argument('--boot-order', '-o', type=int,
                             help='Boot order (lower = higher priority)')
```

4. Handler functions:
```python
def cmd_menu_list(args: argparse.Namespace) -> int:
    """List all menu entries."""
    import requests

    try:
        response = requests.get(f"{args.url}/pxe")
        response.raise_for_status()
        data = response.json()

        if args.json:
            print(json.dumps(data, indent=2))
        else:
            for container in data.get('pxe_containers', []):
                print(f"{container['id']}: {container['name']} (order: {container['boot_order']})")
        return 0
    except Exception as e:
        logger.error(f"Failed to list menu: {e}")
        return 1


def cmd_menu_set(args: argparse.Namespace) -> int:
    """Update menu entry customization."""
    import requests

    update_data = {}
    if args.name is not None:
        update_data['name'] = args.name
    if args.description is not None:
        update_data['description'] = args.description
    if args.boot_order is not None:
        update_data['boot_order'] = args.boot_order

    if not update_data:
        logger.error("No updates specified")
        return 1

    try:
        response = requests.post(
            f"{args.url}/pxe/{args.entry_id}/menu",
            json=update_data
        )
        response.raise_for_status()
        data = response.json()
        logger.info(f"Updated menu entry: {data['entry_id']}")
        return 0
    except Exception as e:
        logger.error(f"Failed to update menu entry: {e}")
        return 1
```

5. Update main() to route menu commands:
```python
elif args.pxe_command == 'menu':
    if args.menu_command == 'list':
        return cmd_menu_list(args)
    elif args.menu_command == 'set':
        return cmd_menu_set(args)
    else:
        logger.error(f"Unknown menu command: {args.menu_command}")
        return 1
```
</action>
  <verify>`pixelrts pxe menu list --url http://localhost:8080` lists menu entries</verify>
  <done>CLI has `pxe menu list` and `pxe menu set` commands for menu management</done>
</task>

</tasks>

<verification>
1. Start HTTP server with catalog
2. Run `pixelrts pxe menu list --url http://localhost:8080`
3. Run `pixelrts pxe menu set {entry_id} --name "Custom Name" --url http://localhost:8080`
4. Fetch /pxe/menu.ipxe and verify custom name appears
5. Fetch /pxe and verify customization is in response
</verification>

<success_criteria>
- PXEContainerInfo has pxe_name and pxe_description fields
- POST /pxe/{entry_id}/menu endpoint updates customization
- CLI has `pxe menu list` and `pxe menu set` commands
- Menu script uses custom names when set
</success_criteria>

<output>
After completion, create `.planning/phases/15-boot-menu/15-03-SUMMARY.md`
</output>
