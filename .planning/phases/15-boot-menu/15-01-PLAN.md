---
phase: 15-boot-menu
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/pixel_compiler/pxe/http_server.py
autonomous: true
must_haves:
  truths:
    - "iPXE client receives a boot script when requesting /pxe/boot.ipxe"
    - "Boot script directs client to fetch menu from /pxe/menu.ipxe"
    - "User sees interactive menu with container names and metadata (size, distro) when booting via PXE"
  artifacts:
    - path: "systems/pixel_compiler/pxe/http_server.py"
      provides: "iPXE boot script and menu script endpoints"
      exports: ["_handle_boot_script", "_handle_menu_script"]
  key_links:
    - from: "iPXE client"
      to: "/pxe/boot.ipxe"
      via: "HTTP GET after DHCP/TFTP boot"
      pattern: "chain http://.*boot\\.ipxe"
    - from: "boot.ipxe"
      to: "/pxe/menu.ipxe"
      via: "iPXE chain command"
      pattern: "chain.*menu\\.ipxe"
---

<objective>
Create iPXE boot script endpoints in HTTP server that serve the main boot script and dynamically generated menu script.

Purpose: Enable PXE clients to boot into an interactive menu for container selection.
Output: HTTP endpoints serving boot.ipxe and menu.ipxe scripts.

Note: MENU-03 (container thumbnails/metadata) is satisfied for iPXE text-based menus by displaying metadata (size, distro) alongside container names. Image thumbnails are not supported in iPXE's text-based menu system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@systems/pixel_compiler/pxe/http_server.py
@systems/pixel_compiler/pxe/pxe_cli.py
@systems/pixel_compiler/catalog/catalog_scanner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add iPXE boot script endpoint</name>
  <files>systems/pixel_compiler/pxe/http_server.py</files>
  <action>
Add `/pxe/boot.ipxe` endpoint to HTTPServer class that returns a minimal iPXE boot script.

The boot script should:
1. Use iPXE `chain` command to fetch the dynamic menu script from the same server
2. Include the server's base URL (constructed from request host or configured server_ip)
3. Be served with Content-Type: text/plain (iPXE scripts are plain text)

Implementation:
- Add `_handle_boot_script(self, request: web.Request) -> web.Response` method
- The script template should be:
  ```ipxe
  #!ipxe
  # PixelRTS PXE Boot Menu
  chain http://${next-server}:${http-port}/pxe/menu.ipxe
  ```
- For simplicity, use the request's host header to determine server address
- Register route: `self._app.router.add_get('/pxe/boot.ipxe', self._handle_boot_script)`

Do NOT implement the menu.ipxe endpoint in this task - that's Task 2.
</action>
  <verify>`curl http://localhost:8080/pxe/boot.ipxe` returns valid iPXE script containing `chain http://`</verify>
  <done>GET /pxe/boot.ipxe returns iPXE boot script with chain command to menu.ipxe</done>
</task>

<task type="auto">
  <name>Task 2: Add iPXE menu script endpoint</name>
  <files>systems/pixel_compiler/pxe/http_server.py</files>
  <action>
Add `/pxe/menu.ipxe` endpoint that dynamically generates an iPXE menu script from PXE-enabled containers.

The menu script should:
1. Use iPXE `menu` command to create interactive menu
2. Add `item` commands for each PXE-enabled container from `self._pxe_containers`
3. Use `choose` command to wait for user selection
4. Chain to the selected container URL using the entry_id

Implementation:
- Add `_handle_menu_script(self, request: web.Request) -> web.Response` method
- Get PXE-enabled containers via `self.get_pxe_containers()`
- Generate iPXE script with:
  ```ipxe
  #!ipxe
  # PixelRTS Container Selection Menu

  menu PixelRTS Boot Menu
  item --key 0 local Boot from local disk

  {{ for each container }}
  item --key {{key}} {{entry_id}} {{name}} ({{size_mb}}MB, {{distro}})

  :failed
  echo Boot failed, returning to menu...
  sleep 3
  goto start

  :boot
  chain http://${next-server}:${http-port}/containers/${selected}
  ```
- Extract base URL from request host
- Calculate size_mb from entry.size
- Use boot_order to determine the --key (1, 2, 3...)
- Return as text/plain with status 200
- Register route: `self._app.router.add_get('/pxe/menu.ipxe', self._handle_menu_script)`

Handle edge cases:
- No PXE containers: show "No containers available" message with local boot option
- Missing metadata: display "Unknown" for distro/architecture

Note: This satisfies MENU-03 for iPXE text menus - displaying size and distro metadata alongside container names. Image thumbnails are not supported in iPXE's text-based menu system.
</action>
  <verify>`curl http://localhost:8080/pxe/menu.ipxe` returns valid iPXE script with `menu`, `item`, and `choose` commands</verify>
  <done>GET /pxe/menu.ipxe returns dynamic iPXE menu script listing all PXE-enabled containers with metadata</done>
</task>

</tasks>

<verification>
1. Start HTTP server with catalog integration
2. Fetch /pxe/boot.ipxe - should contain chain command
3. Fetch /pxe/menu.ipxe - should list containers as menu items with metadata (size, distro)
4. Verify iPXE script syntax is valid (manual review or iPXE syntax checker)
</verification>

<success_criteria>
- /pxe/boot.ipxe endpoint returns valid iPXE boot script
- /pxe/menu.ipxe endpoint returns valid iPXE menu script
- Menu script includes all PXE-enabled containers with metadata (size, distro)
- Menu script includes local boot option
</success_criteria>

<output>
After completion, create `.planning/phases/15-boot-menu/15-01-SUMMARY.md`
</output>
