---
phase: 15-boot-menu
plan: 04
type: execute
wave: 3
depends_on: [15-01, 15-02, 15-03]
files_modified:
  - systems/pixel_compiler/tests/test_boot_menu.py
autonomous: true
must_haves:
  truths:
    - "All boot menu endpoints have test coverage"
    - "Menu script generation is verified for various configurations"
    - "Menu customization API is tested"
  artifacts:
    - path: "systems/pixel_compiler/tests/test_boot_menu.py"
      provides: "Comprehensive boot menu tests"
      exports: ["TestBootScriptGeneration", "TestMenuScriptGeneration", "TestMenuCustomization"]
  key_links:
    - from: "test_boot_menu.py"
      to: "http_server.py"
      via: "aiohttp TestClient"
      pattern: "TestClient\\(web\\.Application\\)"
---

<objective>
Create comprehensive test suite for boot menu functionality including boot script, menu script generation, and customization API.

Purpose: Ensure boot menu functionality is robust and well-tested before integration.
Output: Test file with 50+ tests covering all menu endpoints and configurations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@systems/pixel_compiler/pxe/http_server.py
@systems/pixel_compiler/tests/test_http_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create boot menu test file structure</name>
  <files>systems/pixel_compiler/tests/test_boot_menu.py</files>
  <action>
Create comprehensive test file for boot menu functionality following the pattern established in test_http_server.py.

Test categories to include:

1. **BootScriptTests** - Tests for /pxe/boot.ipxe endpoint
   - test_boot_script_returns_ipxe_content_type
   - test_boot_script_contains_chain_command
   - test_boot_script_uses_request_host
   - test_boot_script_basic_structure

2. **MenuScriptTests** - Tests for /pxe/menu.ipxe endpoint
   - test_menu_script_returns_ipxe_content_type
   - test_menu_script_has_menu_command
   - test_menu_script_has_choose_command
   - test_menu_script_lists_containers
   - test_menu_script_includes_local_boot
   - test_menu_script_empty_containers
   - test_menu_script_with_metadata
   - test_menu_script_container_size_formatting

3. **MenuConfigurationTests** - Tests for configuration options
   - test_menu_uses_default_entry
   - test_menu_uses_timeout
   - test_menu_zero_timeout_no_flag
   - test_menu_custom_default_entry
   - test_menu_sanboot_for_local

4. **MenuCustomizationAPITests** - Tests for /pxe/{id}/menu endpoint
   - test_update_menu_name
   - test_update_menu_description
   - test_update_boot_order
   - test_update_multiple_fields
   - test_update_nonexistent_entry
   - test_update_invalid_json

5. **MenuScriptIntegrationTests** - Full integration tests
   - test_custom_name_appears_in_menu
   - test_custom_description_appears_in_menu
   - test_boot_order_affects_menu_order
   - test_disabled_container_not_in_menu
   - test_toggle_refreshes_menu

Follow the test structure from test_http_server.py:
- Use unittest.TestCase with aiohttp TestClient
- Create temp directories with .rts.png files
- Mock CatalogEntry objects where needed
- Use dynamic port allocation starting from 28100
</action>
  <verify>`pytest systems/pixel_compiler/tests/test_boot_menu.py -v` runs all tests</verify>
  <done>Test file created with comprehensive test coverage structure</done>
</task>

<task type="auto">
  <name>Task 2: Implement boot script and menu script tests</name>
  <files>systems/pixel_compiler/tests/test_boot_menu.py</files>
  <action>
Implement tests for boot script and menu script generation.

Boot script tests should verify:
- Content-Type is text/plain
- Script starts with `#!ipxe`
- Contains `chain http://` command
- Uses correct host from request

Menu script tests should verify:
- Content-Type is text/plain
- Contains `menu` command with title
- Contains `item` commands for each container
- Contains `item --key 0 local` for local boot
- Contains `choose` command
- Contains `sanboot` for local boot
- Contains `chain` commands for containers
- Size is formatted correctly (MB for large files, KB for small)
- Handles empty container list gracefully

Example test implementation:
```python
class BootScriptTests(unittest.TestCase):
    def test_boot_script_returns_text_plain(self):
        """Boot script should have text/plain content type."""
        async def test():
            config = HTTPServerConfig(root_dir=self.temp_dir)
            server = HTTPServer(config)
            await server.start()

            try:
                async with aiohttp.ClientSession() as session:
                    async with session.get(
                        f"http://localhost:{config.listen_port}/pxe/boot.ipxe"
                    ) as resp:
                        self.assertEqual(resp.status, 200)
                        self.assertIn('text/plain', resp.headers.get('Content-Type', ''))
            finally:
                await server.stop()

        asyncio.run(test())

    def test_boot_script_contains_chain(self):
        """Boot script should contain chain command."""
        # Similar pattern...
```
</action>
  <verify>`pytest systems/pixel_compiler/tests/test_boot_menu.py::BootScriptTests -v` passes</verify>
  <done>Boot script and menu script tests implemented and passing</done>
</task>

<task type="auto">
  <name>Task 3: Implement menu configuration and customization tests</name>
  <files>systems/pixel_compiler/tests/test_boot_menu.py</files>
  <action>
Implement tests for menu configuration and customization API.

Menu configuration tests should verify:
- default_entry appears in choose --default
- menu_timeout appears in choose --timeout when > 0
- No --timeout when menu_timeout = 0
- Local boot uses sanboot command
- Default entry "local" is supported

Menu customization API tests should verify:
- POST /pxe/{id}/menu with name updates pxe_name
- POST /pxe/{id}/menu with description updates pxe_description
- POST /pxe/{id}/menu with boot_order updates order
- Custom name appears in generated menu script
- 404 for nonexistent entry
- 400 for invalid JSON
- Updated values appear in /pxe list response

Integration tests should verify:
- Custom name replaces filename in menu
- Boot order affects menu item sequence
- Disabling container removes it from menu
- Re-enabling adds it back

Example:
```python
class MenuCustomizationAPITests(unittest.TestCase):
    def test_update_menu_name(self):
        """POST /pxe/{id}/menu with name should update pxe_name."""
        async def test():
            config = HTTPServerConfig(root_dir=self.temp_dir, watch_paths=[self.temp_dir])
            server = HTTPServer(config)
            await server.start()

            try:
                entry_id = list(server._pxe_containers.keys())[0]

                async with aiohttp.ClientSession() as session:
                    async with session.post(
                        f"http://localhost:{config.listen_port}/pxe/{entry_id}/menu",
                        json={"name": "My Custom OS"}
                    ) as resp:
                        self.assertEqual(resp.status, 200)
                        data = await resp.json()
                        self.assertEqual(data['name'], "My Custom OS")
            finally:
                await server.stop()

        asyncio.run(test())
```
</action>
  <verify>`pytest systems/pixel_compiler/tests/test_boot_menu.py -v` passes all tests</verify>
  <done>All menu tests implemented and passing</done>
</task>

</tasks>

<verification>
1. Run `pytest systems/pixel_compiler/tests/test_boot_menu.py -v`
2. Verify all tests pass
3. Verify test count is 40+
4. Verify coverage includes all menu endpoints
</verification>

<success_criteria>
- Test file has 40+ tests
- All tests pass
- Coverage includes boot script, menu script, configuration, and customization
- Tests follow existing test patterns (unittest + aiohttp TestClient)
</success_criteria>

<output>
After completion, create `.planning/phases/15-boot-menu/15-04-SUMMARY.md`
</output>
