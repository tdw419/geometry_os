---
phase: 03-visual-installer-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - systems/pixel_compiler/install/install_engine.py
  - systems/pixel_compiler/install/__init__.py
autonomous: true

must_haves:
  truths:
    - "Container integrity is verified BEFORE writing to disk"
    - "Installation shows progress percentage and current operation"
    - "Cancellation with Ctrl+C cleans up partial writes"
  artifacts:
    - path: "systems/pixel_compiler/install/install_engine.py"
      provides: "Main installer orchestrating verification, write, and cleanup"
      exports: ["InstallEngine", "InstallResult"]
      min_lines: 150
  key_links:
    - from: "install_engine.py"
      to: "PixelRTSDecoder.verify_hash"
      via: "verification before write"
      pattern: "verify_hash|data_hash"
    - from: "install_engine.py"
      to: "DiskWriter"
      via: "chunked write with progress"
      pattern: "DiskWriter.*write"
    - from: "install_engine.py"
      to: "InstallProgress"
      via: "visual feedback"
      pattern: "InstallProgress"
---

<objective>
Create the InstallEngine class that orchestrates the full installation flow: verify container, write data with progress, handle cancellation, and ensure atomic writes.

Purpose: This is the core installer that glues together DiskWriter, InstallProgress, and PixelRTSDecoder into a cohesive installation pipeline.
Output: install_engine.py with InstallEngine and InstallResult classes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/03-visual-installer-engine/03-RESEARCH.md

# Reference patterns from Phase 2
@systems/pixel_compiler/boot/boot_bridge.py
@systems/pixel_compiler/boot/mount_helper.py

# Reference PixelRTSDecoder for verification
@systems/pixel_compiler/pixelrts_v2_core.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InstallEngine class</name>
  <files>systems/pixel_compiler/install/install_engine.py, systems/pixel_compiler/install/__init__.py</files>
  <action>
Create the install_engine.py module with:

1. `InstallResult` dataclass:
   - `success: bool`
   - `target_path: Path`
   - `bytes_written: int`
   - `error_message: Optional[str]`
   - `cancelled: bool`
   - `duration_seconds: float`
   - `verified: bool` (whether hash verification passed)

2. `InstallError` exception class:
   - Similar to MountError from mount_helper.py
   - Has message, path, and original_error attributes

3. `InstallEngine` class:
   Constructor:
   - `rts_png_path: str` - Path to .rts.png container
   - `target_path: str` - Destination path (file or disk image)
   - `verbose: bool = False`
   - `verify: bool = True` - Whether to verify hash before writing

   Key methods:
   - `install() -> InstallResult` - Main installation method:
     1. Start progress with VERIFYING stage
     2. Load metadata from .rts.png (try .meta.json sidecar, or decode from PNG)
     3. If verify=True, call PixelRTSDecoder.verify_hash() - FAIL if hash mismatch
     4. Check target disk space with shutil.disk_usage() - FAIL if insufficient
     5. Progress to PREPARING stage
     6. Decode data from .rts.png using PixelRTSDecoder
     7. Progress to WRITING stage
     8. Use DiskWriter to write decoded data to target with progress callbacks
     9. Progress to SYNCING stage
     10. Call os.fsync() on target file
     11. Progress to COMPLETED stage
     12. Return InstallResult

   - `cancel() -> None` - Request cancellation:
     - Set _cancelled flag
     - Forward to DiskWriter.cancel() if writing

   - `_cleanup() -> None` - Clean up on error/cancel:
     - Delete temp files
     - Called from __exit__ and signal handlers

   - Context manager support (`__enter__`, `__exit__`)

   - Signal handlers (follow MountHelper pattern from lines 174-186):
     - Register SIGINT/SIGTERM handlers that call cancel() and _cleanup()
     - Use atexit for crash recovery

   Internal state:
   - `_progress: InstallProgress`
   - `_writer: Optional[DiskWriter]`
   - `_decoder: Optional[PixelRTSDecoder]`
   - `_cancelled: bool`
   - `_original_sigint_handler`
   - `_original_sigterm_handler`

Follow the BootBridge pattern from boot_bridge.py for:
- Error handling with try/except and progress.error()
- Cleanup in __exit__ and exception handlers
- Logging with logging module

Update __init__.py to export: `from .install_engine import InstallEngine, InstallResult, InstallError`
</action>
  <verify>python3 -c "from systems.pixel_compiler.install import InstallEngine, InstallResult, InstallError; print('OK')"</verify>
  <done>InstallEngine orchestrates verification, chunked write with progress, cancellation, and cleanup</done>
</task>

</tasks>

<verification>
- [ ] InstallEngine.install() verifies hash BEFORE writing when verify=True
- [ ] InstallEngine.install() fails with clear error if hash mismatch
- [ ] InstallEngine.install() shows progress through all stages
- [ ] Ctrl+C triggers cancellation and cleanup
- [ ] Context manager ensures cleanup on any exception
</verification>

<success_criteria>
- Container integrity verified via PixelRTSDecoder.verify_hash() before any disk write
- Progress displayed with percentage and current operation at each stage
- Cancellation cleans up partial writes (temp files deleted)
- Installation produces valid disk image from decoded container data
</success_criteria>

<output>
After completion, create `.planning/phases/03-visual-installer-engine/03-02-SUMMARY.md`
</output>
