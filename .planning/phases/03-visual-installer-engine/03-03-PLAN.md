---
phase: 03-visual-installer-engine
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - systems/pixel_compiler/pixelrts_cli.py
  - systems/pixel_compiler/tests/test_install_engine.py
autonomous: true

must_haves:
  truths:
    - "User can run pixelrts install file.png target with single command"
    - "Unit tests cover verification, write, cancellation, and cleanup"
  artifacts:
    - path: "systems/pixel_compiler/pixelrts_cli.py"
      provides: "CLI install subcommand"
      contains: "def cmd_install"
    - path: "systems/pixel_compiler/tests/test_install_engine.py"
      provides: "Unit tests for install module"
      min_lines: 200
  key_links:
    - from: "pixelrts_cli.py"
      to: "InstallEngine"
      via: "cmd_install handler"
      pattern: "InstallEngine"
---

<objective>
Add the `pixelrts install` CLI subcommand and comprehensive unit tests for the Visual Installer Engine.

Purpose: Expose the InstallEngine functionality through the CLI so users can run `pixelrts install file.png target` and verify the implementation with tests.
Output: Updated pixelrts_cli.py with install subcommand, test_install_engine.py with unit tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference existing CLI patterns and tests
@systems/pixel_compiler/pixelrts_cli.py
@systems/pixel_compiler/tests/test_boot_bridge.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add install CLI subcommand</name>
  <files>systems/pixel_compiler/pixelrts_cli.py</files>
  <action>
Add the `install` subcommand to pixelrts_cli.py following the existing patterns from `cmd_boot`:

1. Create `cmd_install(args)` function:
   - Validate input file exists and is .rts.png
   - Validate target path (check parent directory exists)
   - Create InstallEngine with rts_png_path, target_path, verbose
   - Use as context manager
   - Call engine.install() and handle result
   - On success: print success message with bytes written and duration
   - On failure: print error message to stderr, return 1
   - On cancellation: print cancellation message, return 130

2. Add install subparser in main():
   - Positional args: input (the .rts.png file), target (destination path)
   - Options:
     - `--no-verify` - Skip hash verification
     - `--quiet, -q` - Suppress progress output
     - `-v, --verbose` - Enable verbose output

3. Add 'install': cmd_install to handlers dict

4. Update the epilog examples to include install:
   ```
   pixelrts install alpine.rts.png /dev/sda
   pixelrts install os.rts.png disk.img --no-verify
   ```

Follow the exact pattern from cmd_boot (lines 718-831) for signal handling and output formatting.
</action>
  <verify>python3 -c "from systems.pixel_compiler.pixelrts_cli import cmd_install; print('OK')"</verify>
  <done>pixelrts install subcommand works with input and target positional arguments</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for InstallEngine</name>
  <files>systems/pixel_compiler/tests/test_install_engine.py</files>
  <action>
Create comprehensive unit tests following the test_boot_bridge.py pattern:

1. TestInstallProgress class:
   - test_install_stage_enum_has_all_stages
   - test_start_sets_current_stage
   - test_update_progress_with_message
   - test_complete_shows_duration
   - test_error_shows_error_message

2. TestDiskWriter class:
   - test_write_creates_file_at_target
   - test_write_calls_progress_callback
   - test_write_respects_chunk_size
   - test_cancel_stops_write_and_deletes_temp
   - test_temp_file_renamed_on_success
   - test_temp_file_deleted_on_error
   - test_write_result_success_fields
   - test_write_result_cancelled_fields

3. TestInstallEngine class:
   - test_install_validates_input_exists
   - test_install_fails_on_missing_input
   - test_install_verifies_hash_before_write
   - test_install_fails_on_hash_mismatch
   - test_install_writes_decoded_data_to_target
   - test_install_shows_progress_through_all_stages
   - test_cancel_cleans_up_partial_write
   - test_context_manager_cleanup_on_exception
   - test_insufficient_disk_space_fails_gracefully

Use pytest fixtures:
- tmp_path for temporary directories
- mock_rts_png fixture that creates a minimal valid .rts.png with metadata
- Use unittest.mock for mocking DiskWriter and PixelRTSDecoder where needed

Run tests with: pytest systems/pixel_compiler/tests/test_install_engine.py -v
</action>
  <verify>pytest systems/pixel_compiler/tests/test_install_engine.py -v --tb=short 2>&1 | tail -20</verify>
  <done>All tests pass, covering verification, write, cancellation, and cleanup scenarios</done>
</task>

</tasks>

<verification>
- [ ] `pixelrts install --help` shows usage with input and target args
- [ ] `pixelrts install missing.png target.img` fails with file not found error
- [ ] pytest test_install_engine.py passes all tests
- [ ] Tests cover: verification pass/fail, write success, cancellation, cleanup
</verification>

<success_criteria>
- CLI command `pixelrts install <file.png> <target>` works with single invocation
- Unit tests cover all critical paths: verify-before-write, chunked write, cancellation cleanup
- All tests pass with pytest
</success_criteria>

<output>
After completion, create `.planning/phases/03-visual-installer-engine/03-03-SUMMARY.md`
</output>
