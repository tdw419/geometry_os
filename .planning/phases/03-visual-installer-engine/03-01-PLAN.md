---
phase: 03-visual-installer-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/pixel_compiler/install/__init__.py
  - systems/pixel_compiler/install/install_progress.py
  - systems/pixel_compiler/install/disk_writer.py
autonomous: true

must_haves:
  truths:
    - "InstallProgress displays progress with install-specific stages"
    - "DiskWriter copies data in chunks with progress callbacks"
    - "DiskWriter supports cancellation during write operations"
  artifacts:
    - path: "systems/pixel_compiler/install/install_progress.py"
      provides: "Install-specific progress stages extending BootProgress"
      exports: ["InstallProgress", "InstallStage"]
      min_lines: 60
    - path: "systems/pixel_compiler/install/disk_writer.py"
      provides: "Chunked disk writing with progress callbacks"
      exports: ["DiskWriter", "WriteResult"]
      min_lines: 100
    - path: "systems/pixel_compiler/install/__init__.py"
      provides: "Package exports for install module"
      contains: "from .install_progress import"
  key_links:
    - from: "install_progress.py"
      to: "boot_progress.py"
      via: "inheritance"
      pattern: "class InstallProgress.*BootProgress"
    - from: "disk_writer.py"
      to: "shutil.copyfileobj"
      via: "chunked copy with callback"
      pattern: "copyfileobj|read.*chunk_size"
---

<objective>
Create foundation components for the Visual Installer Engine: InstallProgress for visual feedback and DiskWriter for chunked writes with cancellation support.

Purpose: These are the building blocks that InstallEngine will use. They follow established patterns from Phase 2 (BootProgress context manager, signal handlers).
Output: install_progress.py, disk_writer.py, __init__.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/03-visual-installer-engine/03-RESEARCH.md

# Reference existing Phase 2 patterns
@systems/pixel_compiler/boot/boot_progress.py
@systems/pixel_compiler/boot/mount_helper.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InstallProgress class</name>
  <files>systems/pixel_compiler/install/install_progress.py, systems/pixel_compiler/install/__init__.py</files>
  <action>
Create the install_progress.py module with:
1. `InstallStage` enum with stages: VERIFYING, PREPARING, WRITING, SYNCING, COMPLETED, FAILED
2. `InstallProgress` class that extends BootProgress patterns (NOT inheritance - use composition or just follow same patterns)
   - Constructor takes `verbose: bool = True`
   - `start(stage: InstallStage)` method
   - `update(progress: float, message: str)` method
   - `complete(message: str)` method
   - `error(message: str)` method
   - TTY-aware output (same as BootProgress)
   - Rich library support with plain text fallback

3. In __init__.py, add exports:
   - `from .install_progress import InstallProgress, InstallStage`

DO NOT inherit from BootProgress (it's tied to ProgressStage enum). Instead, copy the pattern but use InstallStage.
</action>
  <verify>python3 -c "from systems.pixel_compiler.install import InstallProgress, InstallStage; print('OK')"</verify>
  <done>InstallProgress and InstallStage can be imported and follow same TTY-aware patterns as BootProgress</done>
</task>

<task type="auto">
  <name>Task 2: Create DiskWriter class</name>
  <files>systems/pixel_compiler/install/disk_writer.py, systems/pixel_compiler/install/__init__.py</files>
  <action>
Create the disk_writer.py module with:

1. `WriteResult` dataclass:
   - `success: bool`
   - `bytes_written: int`
   - `target_path: Path`
   - `error_message: Optional[str]`
   - `cancelled: bool`

2. `DiskWriter` class:
   - Constructor takes `chunk_size: int = 1024*1024` (1MB default)
   - `write(src_reader, dst_path: Path, total_size: int, progress_callback: Callable[[float, str], None]) -> WriteResult`
     - Read from src_reader (file-like object) in chunks
     - Write to a TEMPORARY file first (dst_path + '.tmp')
     - Call progress_callback after each chunk with (progress_ratio, message)
     - On completion, do atomic rename from temp to final path
     - Return WriteResult
   - `cancel()` method to set cancellation flag
   - Check cancellation flag during write loop - if set, delete temp file and return cancelled result
   - Context manager support (`__enter__`, `__exit__`)

Key implementation details:
- Use `tempfile` or just append `.tmp` to target path for temp file
- Use `os.replace()` for atomic rename (works on both files and directories)
- Progress = bytes_written / total_size
- Handle file not found, permission errors gracefully

Update __init__.py to export: `from .disk_writer import DiskWriter, WriteResult`
</action>
  <verify>python3 -c "from systems.pixel_compiler.install import DiskWriter, WriteResult; print('OK')"</verify>
  <done>DiskWriter supports chunked writes with progress callbacks and cancellation</done>
</task>

</tasks>

<verification>
- [ ] InstallProgress importable with InstallStage enum
- [ ] DiskWriter importable with WriteResult dataclass
- [ ] DiskWriter.write() accepts file-like source, path destination, total_size, and progress callback
- [ ] Cancellation during write deletes temp file and returns cancelled=True
</verification>

<success_criteria>
- InstallProgress displays install-specific stages (VERIFYING, PREPARING, WRITING, SYNCING, COMPLETED, FAILED)
- DiskWriter copies data in 1MB chunks by default with progress callbacks
- DiskWriter cancellation cleans up temporary files
- Atomic rename ensures complete writes or nothing
</success_criteria>

<output>
After completion, create `.planning/phases/03-visual-installer-engine/03-01-SUMMARY.md`
</output>
