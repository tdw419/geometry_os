---
phase: 02-fuse-bridge
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - systems/pixel_compiler/boot/boot_progress.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Progress is displayed for operations taking longer than 1 second"
    - "Progress display adapts to TTY vs non-TTY environments"
  artifacts:
    - path: "systems/pixel_compiler/boot/boot_progress.py"
      provides: "Visual progress for boot operations"
      exports: ["BootProgress", "ProgressStage"]
      min_lines: 100
  key_links:
    - from: "systems/pixel_compiler/boot/boot_progress.py"
      to: "sys.stderr"
      via: "TTY detection and output"
      pattern: "sys.stderr.isatty"
---

<objective>
Create visual progress display for boot operations.

Purpose: UX-01 compliance - display progress for operations that take longer than 1 second. Provide user feedback during FUSE mount, kernel loading, and QEMU startup.

Output: BootProgress class with TTY-aware progress display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-fuse-bridge/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BootProgress class</name>
  <files>systems/pixel_compiler/boot/boot_progress.py</files>
  <action>
Create BootProgress class for visual boot feedback.

**UX-01: Boot progress displayed visually during operations >1 second**

1. Create `ProgressStage` enum:
   ```python
   from enum import Enum, auto

   class ProgressStage(Enum):
       PARSING_METADATA = auto()
       MOUNTING_FUSE = auto()
       DISCOVERING_BOOT_FILES = auto()
       LOADING_KERNEL = auto()
       LOADING_INITRD = auto()
       STARTING_QEMU = auto()
       BOOT_COMPLETE = auto()
       BOOT_FAILED = auto()
   ```

2. Create `BootProgress` class:
   ```python
   import sys
   import time
   from typing import Optional

   class BootProgress:
       """
       Visual boot progress display.

       Displays progress bar on TTY, plain messages on non-TTY.
       """

       STAGES = {
           ProgressStage.PARSING_METADATA: ("Parsing PNG metadata", 0.5),
           ProgressStage.MOUNTING_FUSE: ("Mounting FUSE filesystem", 1.0),
           ProgressStage.DISCOVERING_BOOT_FILES: ("Discovering boot files", 0.3),
           ProgressStage.LOADING_KERNEL: ("Loading kernel", 2.0),
           ProgressStage.LOADING_INITRD: ("Loading initrd", 3.0),
           ProgressStage.STARTING_QEMU: ("Starting QEMU", 1.0),
       }

       def __init__(self, verbose: bool = True):
           self.verbose = verbose
           self.is_tty = sys.stderr.isatty()
           self.current_stage: Optional[ProgressStage] = None
           self.start_time: Optional[float] = None

       def start(self, stage: ProgressStage) -> None:
           """Start a progress stage."""
           ...

       def update(self, progress: float, message: Optional[str] = None) -> None:
           """Update progress within current stage (0.0 to 1.0)."""
           ...

       def complete(self, message: Optional[str] = None) -> None:
           """Complete current stage."""
           ...

       def error(self, message: str) -> None:
           """Display error message."""
           ...

       def _show_progress_bar(self, message: str, progress: float) -> None:
           """Show progress bar on TTY."""
           if not self.is_tty:
               return
           bar_width = 30
           filled = int(bar_width * progress)
           bar = "=" * filled + "-" * (bar_width - filled)
           sys.stderr.write(f"\r  [{bar}] {message}")
           sys.stderr.flush()

       def _show_message(self, message: str) -> None:
           """Show plain message (TTY and non-TTY)."""
           if self.is_tty:
               sys.stderr.write(f"\r{' ' * 60}\r")  # Clear progress bar
           print(f"  {message}")
   ```

3. Key implementation details:
   - Check `sys.stderr.isatty()` before showing progress bar
   - On non-TTY, just print stage completion messages
   - Track time per stage to auto-show progress for long operations
   - Use `rich` library if available, fallback to plain text (as done in Phase 1)

4. From RESEARCH.md Pitfall 4:
   - Always check `is_tty` before using carriage return/cursor manipulation
   - In CI/logs, just print plain messages

5. The verbose flag controls whether any output is shown at all.
  </action>
  <verify>
```bash
cd /home/jericho/zion/projects/geometry_os/geometry_os
python3 -c "
from systems.pixel_compiler.boot.boot_progress import BootProgress, ProgressStage
print('BootProgress class exists')
print('ProgressStage enum exists')
bp = BootProgress()
print('BootProgress instantiates')
bp.start(ProgressStage.PARSING_METADATA)
bp.complete('Metadata parsed')
print('Progress display works')
"
```
  </verify>
  <done>
BootProgress provides TTY-aware visual feedback for boot operations.
</done>
</task>

</tasks>

<verification>
1. BootProgress class exists with start/update/complete/error methods
2. ProgressStage enum defines all boot stages
3. TTY detection works (progress bar vs plain text)
4. Non-TTY output is clean (no carriage return artifacts)
5. Verbose flag controls output visibility
</verification>

<success_criteria>
- Progress displayed for operations >1 second
- Clean output in both TTY and non-TTY environments
- Integrates with BootBridge (will be wired in Plan 04)
</success_criteria>

<output>
After completion, create `.planning/phases/02-fuse-bridge/02-03-SUMMARY.md`
</output>
