---
phase: 02-fuse-bridge
plan: 04
type: execute
wave: 4
depends_on: ["02-02", "02-03"]
files_modified:
  - systems/pixel_compiler/boot/boot_bridge.py
  - systems/pixel_compiler/boot/__init__.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "BootBridge shows progress during boot operations"
    - "BootBridge integrates progress display into boot flow"
  artifacts:
    - path: "systems/pixel_compiler/boot/boot_bridge.py"
      provides: "BootBridge with progress support"
      contains: "BootProgress"
  key_links:
    - from: "systems/pixel_compiler/boot/boot_bridge.py"
      to: "systems/pixel_compiler/boot/boot_progress.py"
      via: "BootProgress class"
      pattern: "from .boot_progress import BootProgress"
---

<objective>
Integrate BootProgress into BootBridge for visual feedback.

Purpose: Wire the progress display into the boot pipeline so users see feedback during FUSE mount, kernel loading, and QEMU startup.

Output: BootBridge with progress parameter and visual feedback throughout boot flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-fuse-bridge/02-RESEARCH.md

@systems/pixel_compiler/boot/boot_bridge.py
@systems/pixel_compiler/boot/boot_progress.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progress support to BootBridge</name>
  <files>systems/pixel_compiler/boot/boot_bridge.py</files>
  <action>
Modify BootBridge to integrate BootProgress throughout the boot flow.

1. Update BootBridge.__init__ to accept verbose parameter:
   ```python
   def __init__(
       self,
       rts_png_path: str,
       memory: str = "2G",
       cpus: int = 2,
       vnc_display: int = 0,
       verbose: bool = True
   ):
       ...
       self.verbose = verbose
       self._progress = BootProgress(verbose=verbose)
   ```

2. Update boot() method to show progress at each stage:
   ```python
   def boot(self, cmdline: Optional[str] = None, ...) -> BootResult:
       try:
           # Stage 1: Parse metadata
           self._progress.start(ProgressStage.PARSING_METADATA)
           # ... metadata parsing
           self._progress.complete("Metadata parsed")

           # Stage 2: Mount FUSE
           self._progress.start(ProgressStage.MOUNTING_FUSE)
           self._mount_helper = MountHelper(str(self.rts_path))
           mountpoint = self._mount_helper.mount()
           self._progress.complete(f"FUSE mounted at {mountpoint}")

           # Stage 3: Discover boot files
           self._progress.start(ProgressStage.DISCOVERING_BOOT_FILES)
           kernel, initrd = self._mount_helper.discover_boot_files()
           self._progress.complete(f"Found kernel={kernel}, initrd={initrd}")

           # Stage 4: Load kernel (if found)
           if kernel:
               self._progress.start(ProgressStage.LOADING_KERNEL)
               # ... kernel is loaded via FUSE during QEMU boot
               self._progress.complete("Kernel ready")

           # Stage 5: Load initrd (if found)
           if initrd:
               self._progress.start(ProgressStage.LOADING_INITRD)
               # ... initrd is loaded via FUSE during QEMU boot
               self._progress.complete("Initrd ready")

           # Stage 6: Start QEMU
           self._progress.start(ProgressStage.STARTING_QEMU)
           self._qemu = QemuBoot(...)
           process = self._qemu.boot(kernel=kernel_path, initrd=initrd_path, ...)
           self._progress.complete(f"QEMU started (PID {process.pid})")

           # Stage 7: Complete
           self._progress.start(ProgressStage.BOOT_COMPLETE)
           self._progress.complete("Boot complete!")

           return BootResult(success=True, process=process, ...)

       except Exception as e:
           self._progress.error(str(e))
           return BootResult(success=False, error_message=str(e), ...)
   ```

3. Import BootProgress and ProgressStage at the top of the file:
   ```python
   from .boot_progress import BootProgress, ProgressStage
   ```

4. Ensure progress is shown even for fast operations (non-blocking), but skip progress bar for sub-second operations.
</action>
  <verify>
```bash
cd /home/jericho/zion/projects/geometry_os/geometry_os
python3 -c "
from systems.pixel_compiler.boot.boot_bridge import BootBridge
bb = BootBridge('/nonexistent.png', verbose=True)
print('BootBridge accepts verbose parameter')
print('Progress integration ready')
"
```
  </verify>
  <done>
BootBridge shows visual progress during boot operations.
</done>
</task>

<task type="auto">
  <name>Task 2: Update boot package exports</name>
  <files>systems/pixel_compiler/boot/__init__.py</files>
  <action>
Update __init__.py to export BootProgress and ProgressStage:

```python
from .mount_helper import MountHelper, MountError
from .boot_bridge import BootBridge, BootResult
from .boot_progress import BootProgress, ProgressStage

__all__ = [
    "MountHelper", "MountError",
    "BootBridge", "BootResult",
    "BootProgress", "ProgressStage"
]
```
  </action>
  <verify>
```bash
python3 -c "from systems.pixel_compiler.boot import BootProgress, ProgressStage; print('OK')"
```
  </verify>
  <done>
Boot package exports all components including progress.
</done>
</task>

</tasks>

<verification>
1. BootBridge accepts verbose parameter
2. BootProgress is integrated into boot flow
3. Each boot stage shows appropriate progress
4. Errors are displayed with error() method
5. Non-verbose mode suppresses output
</verification>

<success_criteria>
- Visual progress shown during boot
- Progress adapts to TTY/non-TTY
- Clean integration with existing BootBridge
</success_criteria>

<output>
After completion, create `.planning/phases/02-fuse-bridge/02-04-SUMMARY.md`
</output>
