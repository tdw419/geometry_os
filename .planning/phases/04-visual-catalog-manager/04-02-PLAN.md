---
phase: 04-visual-catalog-manager
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/pixel_compiler/catalog/spatial_layout.py
  - systems/pixel_compiler/catalog/__init__.py
autonomous: true

must_haves:
  truths:
    - "SpatialLayoutManager persists catalog layout to ~/.rts/catalog_layout.json"
    - "User's spatial arrangement persists across page refresh"
    - "Drag-and-drop swap operations update layout file"
    - "Grid dimensions are calculated from entry positions"
  artifacts:
    - path: "systems/pixel_compiler/catalog/spatial_layout.py"
      provides: "Spatial position management and persistence"
      exports: ["SpatialLayoutManager", "SpatialPosition"]
      min_lines: 80
    - path: "systems/pixel_compiler/catalog/__init__.py"
      provides: "Package exports"
      contains: "from .spatial_layout import"
  key_links:
    - from: "spatial_layout.py"
      to: "~/.rts/catalog_layout.json"
      via: "JSON persistence"
      pattern: "json\\.dump|json\\.load"
    - from: "move_entry"
      to: "positions dict"
      via: "position swap on collision"
      pattern: "positions\\[.*\\]\\s*="
---

<objective>
Create SpatialLayoutManager for managing and persisting catalog entry positions with drag-and-drop support.

Purpose: Enable users to reorganize their catalog spatially with persistence across sessions. Layout is stored in ~/.rts/catalog_layout.json.
Output: spatial_layout.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/04-visual-catalog-manager/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpatialLayoutManager with position persistence</name>
  <files>systems/pixel_compiler/catalog/spatial_layout.py, systems/pixel_compiler/catalog/__init__.py</files>
  <action>
Create the spatial_layout.py module with:

1. `SpatialPosition` dataclass:
   - `x: int` - grid column (0-based)
   - `y: int` - grid row (0-based)
   - Add `__eq__` for comparison (two positions equal if x and y match)

2. `SpatialLayoutManager` class:
   - Constructor takes `layout_file: str = "~/.rts/catalog_layout.json"`
   - `_load_layout() -> Dict[str, SpatialPosition]` - load from JSON file, return empty dict if not exists
   - `_save_layout()` - persist positions to JSON file
   - `get_position(entry_id: str) -> Optional[SpatialPosition]` - get position for entry
   - `set_position(entry_id: str, position: SpatialPosition)` - set position for new entry
   - `move_entry(entry_id: str, new_position: SpatialPosition) -> bool`:
     - Move entry to new position
     - If position occupied by another entry, SWAP positions (not push)
     - Save layout after move
     - Return True if successful, False if entry_id not found
   - `get_all_positions() -> Dict[str, SpatialPosition]` - return all positions
   - `get_grid_dimensions() -> Tuple[int, int]`:
     - Calculate required grid size based on positions
     - Default to (4, 4) if no entries
     - Return (max_x + 2, max_y + 2) for padding
   - `clear_layout()` - clear all positions and delete file

Layout file format:
```json
{
  "version": "1.0",
  "positions": {
    "entry_id_1": {"x": 0, "y": 0},
    "entry_id_2": {"x": 1, "y": 0}
  }
}
```

Key implementation details:
- Use `Path.expanduser()` for ~ in path
- Create parent directory with `mkdir(parents=True, exist_ok=True)`
- Handle missing/corrupt JSON gracefully (return empty dict)
- Swap semantics: if moving entry A to position occupied by B, B moves to A's old position

Update __init__.py to export:
```python
from .spatial_layout import SpatialLayoutManager, SpatialPosition
```
</action>
  <verify>python3 -c "from systems.pixel_compiler.catalog import SpatialLayoutManager, SpatialPosition; mgr = SpatialLayoutManager(); print('OK')"</verify>
  <done>SpatialLayoutManager persists positions and supports swap-on-collision</done>
</task>

</tasks>

<verification>
- [ ] SpatialLayoutManager importable with SpatialPosition dataclass
- [ ] Positions persist to ~/.rts/catalog_layout.json
- [ ] move_entry() swaps positions when target is occupied
- [ ] get_grid_dimensions() returns correct grid size
- [ ] Layout survives object recreation (load from file works)
</verification>

<success_criteria>
- Spatial positions persist to JSON file in ~/.rts/
- Drag-and-drop collision causes swap (not push)
- Grid dimensions calculated from positions with padding
- Layout loads correctly after application restart
</success_criteria>

<output>
After completion, create `.planning/phases/04-visual-catalog-manager/04-02-SUMMARY.md`
</output>
