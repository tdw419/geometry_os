---
phase: 04-visual-catalog-manager
plan: 04
type: execute
wave: 3
depends_on:
  - 04-03
files_modified:
  - systems/pixel_compiler/catalog/__init__.py
  - systems/pixel_compiler/tests/test_catalog.py
  - bin/pixelrts
autonomous: true

must_haves:
  truths:
    - "CLI command `pixelrts catalog` launches the visual catalog server"
    - "CLI command `pixelrts catalog --port 8080` uses custom port"
    - "CLI command `pixelrts catalog --paths /path1,/path2` scans multiple directories"
    - "Unit tests verify CatalogScanner, ThumbnailCache, SpatialLayoutManager, and API endpoints"
  artifacts:
    - path: "bin/pixelrts"
      provides: "CLI entry point with catalog subcommand"
      contains: "cmd_catalog"
    - path: "systems/pixel_compiler/tests/test_catalog.py"
      provides: "Unit tests for catalog components"
      contains: "test_catalog_scanner"
      min_lines: 150
    - path: "systems/pixel_compiler/catalog/__init__.py"
      provides: "Package exports"
      contains: "__all__"
  key_links:
    - from: "bin/pixelrts"
      to: "catalog_server.py"
      via: "uvicorn.run"
      pattern: "uvicorn\\.run|cmd_catalog"
    - from: "test_catalog.py"
      to: "catalog_scanner.py"
      via: "unit tests"
      pattern: "CatalogScanner"
---

<objective>
Add CLI command `pixelrts catalog` to launch the visual catalog server and create comprehensive unit tests for all catalog components.

Purpose: Provide user-facing CLI access to the catalog and ensure code quality through automated testing.
Output: Updated bin/pixelrts, tests/test_catalog.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/04-visual-catalog-manager/04-RESEARCH.md
@.planning/phases/04-visual-catalog-manager/04-03-PLAN.md

# Reference existing patterns
@bin/pixelrts
@systems/pixel_compiler/tests/test_boot_bridge.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add catalog CLI subcommand to pixelrts</name>
  <files>bin/pixelrts</files>
  <action>
Add a `catalog` subcommand to the pixelrts CLI following the pattern of existing `boot` and `install` commands.

1. Add argument parser for catalog:
```python
subparsers.add_parser(
    "catalog",
    help="Launch visual catalog server"
)
catalog_parser.add_argument(
    "--port", "-p",
    type=int,
    default=8000,
    help="Port for catalog server (default: 8000)"
)
catalog_parser.add_argument(
    "--host",
    type=str,
    default="127.0.0.1",
    help="Host to bind server (default: 127.0.0.1)"
)
catalog_parser.add_argument(
    "--paths",
    type=str,
    default=None,
    help="Comma-separated directories to scan (default: current directory)"
)
catalog_parser.add_argument(
    "--no-browser",
    action="store_true",
    help="Don't open browser automatically"
)
```

2. Implement `cmd_catalog(args)` function:
   - Parse paths argument into list (split by comma if provided)
   - If paths not specified, use ["."] or RTS_REGISTRY_PATH env var
   - Set environment variables for CatalogServer to use
   - Start uvicorn server: `uvicorn.run("systems.pixel_compiler.catalog:app", host=args.host, port=args.port)`
   - If not --no-browser, open browser to http://localhost:{port}
   - Handle KeyboardInterrupt gracefully

3. Add to main dispatch:
```python
"catalog": cmd_catalog,
```

Key implementation details:
- Use `uvicorn` for ASGI server (already a dependency from FastAPI)
- Use `webbrowser.open()` for browser launch
- Print URL on startup: "Catalog server running at http://127.0.0.1:8000"
- Follow exit code conventions from existing commands
</action>
  <verify>pixelrts catalog --help 2>&1 | grep -q "port" && echo "OK"</verify>
  <done>`pixelrts catalog` launches FastAPI server and opens browser</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for catalog components</name>
  <files>systems/pixel_compiler/tests/test_catalog.py</files>
  <action>
Create comprehensive unit tests for all catalog components following the pattern from test_boot_bridge.py.

Test classes and methods:

1. TestCatalogScanner:
   - `test_scan_finds_rts_files`: Create temp .rts.png files, verify scanner finds them
   - `test_scan_extracts_metadata`: Create .rts.png with PNG metadata, verify extraction
   - `test_scan_handles_missing_files`: Test graceful handling of non-existent paths
   - `test_catalog_entry_dataclass`: Verify CatalogEntry fields

2. TestThumbnailCache:
   - `test_generate_thumbnail`: Create test image, verify thumbnail generation
   - `test_cache_hit`: Generate thumbnail twice, verify second is cached
   - `test_base64_encoding`: Verify get_thumbnail_base64 returns valid base64
   - `test_custom_size`: Test thumbnail generation with custom size

3. TestSpatialLayoutManager:
   - `test_set_and_get_position`: Set position, verify retrieval
   - `test_move_entry_swap`: Move to occupied position, verify swap
   - `test_persistence`: Save layout, create new manager, verify load
   - `test_grid_dimensions`: Add entries, verify grid calculation

4. TestCatalogServer:
   - `test_get_catalog`: Use FastAPI TestClient, verify /api/v1/catalog returns entries
   - `test_boot_entry_success`: Mock BootBridge, verify boot endpoint
   - `test_boot_entry_not_found`: Verify 404 for unknown entry
   - `test_update_layout`: POST layout update, verify persistence
   - `test_cors_headers`: Verify CORS middleware is configured

Test setup:
```python
import pytest
from fastapi.testclient import TestClient
from systems.pixel_compiler.catalog import (
    CatalogScanner, CatalogEntry,
    ThumbnailCache, ThumbnailResult,
    SpatialLayoutManager, SpatialPosition,
    app, CatalogServer
)

@pytest.fixture
def temp_catalog_dir(tmp_path):
    # Create temp .rts.png files for testing
    ...
```

Key implementation details:
- Use pytest fixtures for temp directories
- Use unittest.mock for BootBridge mocking
- Use FastAPI TestClient for API tests
- Each test should be independent (no shared state)
</action>
  <verify>python3 -m pytest systems/pixel_compiler/tests/test_catalog.py -v --collect-only 2>&1 | grep -c "test_" | head -1</verify>
  <done>All catalog components have passing unit tests</done>
</task>

</tasks>

<verification>
- [ ] `pixelrts catalog --help` shows usage
- [ ] `pixelrts catalog` starts uvicorn server
- [ ] Unit tests exist for CatalogScanner
- [ ] Unit tests exist for ThumbnailCache
- [ ] Unit tests exist for SpatialLayoutManager
- [ ] Unit tests exist for CatalogServer API
- [ ] All tests pass with `pytest test_catalog.py`
</verification>

<success_criteria>
- CLI command `pixelrts catalog` launches visual catalog
- CLI supports --port, --host, --paths, --no-browser options
- Unit tests cover all catalog components with >80% coverage
- Tests follow existing patterns from test_boot_bridge.py
</success_criteria>

<output>
After completion, create `.planning/phases/04-visual-catalog-manager/04-04-SUMMARY.md`
</output>
