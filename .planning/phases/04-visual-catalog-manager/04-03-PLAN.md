---
phase: 04-visual-catalog-manager
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified:
  - systems/pixel_compiler/catalog/catalog_server.py
  - systems/pixel_compiler/catalog/__init__.py
  - systems/pixel_compiler/catalog/templates/catalog.html
autonomous: true

must_haves:
  truths:
    - "CatalogServer exposes REST API at /api/v1/catalog for listing entries"
    - "CatalogServer exposes POST /api/v1/catalog/{id}/boot for one-click boot"
    - "CatalogServer exposes POST /api/v1/catalog/layout for updating positions"
    - "API returns thumbnails as base64 in JSON responses"
    - "Boot endpoint uses BootBridge from Phase 2"
    - "CORS middleware allows frontend access"
  artifacts:
    - path: "systems/pixel_compiler/catalog/catalog_server.py"
      provides: "FastAPI REST endpoints for catalog operations"
      exports: ["app", "CatalogServer", "get_catalog_server"]
      min_lines: 150
    - path: "systems/pixel_compiler/catalog/templates/catalog.html"
      provides: "Single-page gallery UI"
      contains: "catalog-grid"
    - path: "systems/pixel_compiler/catalog/__init__.py"
      provides: "Package exports"
      contains: "from .catalog_server import"
  key_links:
    - from: "catalog_server.py"
      to: "boot_bridge.py"
      via: "BootBridge for boot endpoint"
      pattern: "BootBridge|boot\\(\\)"
    - from: "catalog_server.py"
      to: "catalog_scanner.py"
      via: "CatalogScanner for entries"
      pattern: "CatalogScanner|scanner\\.scan"
    - from: "catalog_server.py"
      to: "thumbnail_cache.py"
      via: "ThumbnailCache for thumbnails"
      pattern: "ThumbnailCache|get_thumbnail_base64"
    - from: "/api/v1/catalog"
      to: "JSON response"
      via: "FastAPI response model"
      pattern: "@app\\.get.*catalog"
---

<objective>
Create the CatalogServer FastAPI application that provides REST endpoints for catalog operations, integrates with BootBridge for one-click boot, and serves the HTML gallery UI.

Purpose: The server is the backend that connects the frontend UI to the data layer (CatalogScanner, ThumbnailCache, SpatialLayoutManager) and boot infrastructure (BootBridge).
Output: catalog_server.py, templates/catalog.html
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/04-visual-catalog-manager/04-RESEARCH.md
@.planning/phases/04-visual-catalog-manager/04-01-PLAN.md
@.planning/phases/04-visual-catalog-manager/04-02-PLAN.md

# Reference existing patterns
@systems/pixel_compiler/boot/boot_bridge.py
@systems/pixel_compiler/api/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CatalogServer FastAPI application</name>
  <files>systems/pixel_compiler/catalog/catalog_server.py, systems/pixel_compiler/catalog/__init__.py</files>
  <action>
Create the catalog_server.py module with:

1. Pydantic models for API:
```python
class BootOptions(BaseModel):
    memory: str = "2G"
    cpus: int = 2
    cmdline: Optional[str] = None

class LayoutUpdate(BaseModel):
    entry_id: str
    new_position: dict  # {"x": int, "y": int}

class CatalogEntryResponse(BaseModel):
    id: str
    name: str
    path: str
    size: int
    kernel_version: Optional[str]
    distro: Optional[str]
    architecture: Optional[str]
    thumbnail: str  # base64
    position: dict  # {"x": int, "y": int}

class CatalogResponse(BaseModel):
    entries: List[CatalogEntryResponse]
    grid_dimensions: dict  # {"width": int, "height": int}
```

2. FastAPI app setup (follow api/main.py pattern):
```python
app = FastAPI(
    title="PixelRTS Catalog",
    description="Visual catalog for OS containers",
    version="1.0.0",
    docs_url="/docs"
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

3. REST endpoints:
- `GET /api/v1/catalog` - list all entries with thumbnails
- `POST /api/v1/catalog/{entry_id}/boot` - boot an entry (uses BootBridge)
- `POST /api/v1/catalog/layout` - update layout after drag
- `GET /api/v1/catalog/refresh` - rescan filesystem for new files
- `GET /` - serve catalog.html (HTMLResponse)

4. `CatalogServer` class (for programmatic use):
   - `__init__(watch_paths: List[str] = None)`
   - Uses CatalogScanner, ThumbnailCache, SpatialLayoutManager internally
   - `get_entries() -> List[CatalogEntryResponse]`
   - `boot_entry(entry_id: str, options: BootOptions) -> dict`

5. `get_catalog_server()` function - singleton pattern for shared server instance

Key implementation details:
- Import BootBridge from `systems.pixel_compiler.boot`
- Use `threading` for boot operation (don't block API)
- Return 404 for unknown entry_id
- Catch BootBridge exceptions and return error response
- Templates directory: `Path(__file__).parent / "templates"`

Update __init__.py to export:
```python
from .catalog_server import app, CatalogServer, get_catalog_server
```
</action>
  <verify>python3 -c "from systems.pixel_compiler.catalog import app, CatalogServer; print('OK')"</verify>
  <done>CatalogServer exposes REST API with catalog, boot, and layout endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Create catalog.html single-page gallery UI</name>
  <files>systems/pixel_compiler/catalog/templates/catalog.html</files>
  <action>
Create a single HTML file with embedded CSS and JavaScript for the catalog gallery.

Requirements:
1. HTML structure:
   - Header with title "PixelRTS Catalog"
   - Grid container with id="catalog-grid"
   - Refresh button

2. CSS (embedded in `<style>` tag):
   - `.catalog-grid`: CSS Grid with `repeat(auto-fill, minmax(200px, 1fr))`
   - `.catalog-entry`: bordered card with rounded corners, cursor: grab
   - `.catalog-entry.dragging`: opacity 0.5, scale 0.95
   - `.catalog-entry.drag-over`: green border highlight
   - `.catalog-thumbnail`: 100% width, aspect-ratio 1, contain fit
   - `.catalog-metadata`: small text for kernel/distro info
   - `.boot-button`: prominent button for boot action

3. JavaScript (embedded in `<script>` tag):
   - `loadCatalog()`: fetch /api/v1/catalog, render entries
   - `renderCatalog(entries)`: create DOM elements for each entry
   - `bootEntry(entryId)`: POST to /api/v1/catalog/{id}/boot
   - Drag-and-drop handlers:
     - dragstart: set dataTransfer, add .dragging class
     - dragover: preventDefault, add .drag-over class
     - dragleave: remove .drag-over class
     - drop: preventDefault, call swapEntries(), POST layout update
   - `swapEntries(id1, id2)`: swap in local array, re-render, POST to /api/v1/catalog/layout

4. Bootstrap sequence:
   - Call loadCatalog() on DOMContentLoaded
   - Set up auto-refresh every 30 seconds (optional)

Key implementation details:
- Use `data:image/png;base64,${entry.thumbnail}` for thumbnail src
- Show "Unknown" for missing metadata
- Alert on boot success/failure
- No external dependencies (no React, Vue, jQuery)
- Works in all modern browsers

Follow the pattern from 04-RESEARCH.md Pattern 5.
</action>
  <verify>test -f systems/pixel_compiler/catalog/templates/catalog.html && grep -q "catalog-grid" systems/pixel_compiler/catalog/templates/catalog.html && echo "OK"</verify>
  <done>catalog.html provides visual gallery with drag-and-drop and boot buttons</done>
</task>

</tasks>

<verification>
- [ ] FastAPI app importable with CORS middleware
- [ ] GET /api/v1/catalog returns entries with thumbnails
- [ ] POST /api/v1/catalog/{id}/boot uses BootBridge
- [ ] POST /api/v1/catalog/layout updates positions
- [ ] catalog.html exists with catalog-grid element
- [ ] catalog.html has drag-and-drop handlers
</verification>

<success_criteria>
- REST API exposes catalog, boot, and layout endpoints
- Thumbnails served as base64 in JSON responses
- Boot endpoint integrates with BootBridge
- CORS allows frontend access
- HTML gallery renders entries with thumbnails and boot buttons
- Native HTML5 drag-and-drop works for spatial reorganization
</success_criteria>

<output>
After completion, create `.planning/phases/04-visual-catalog-manager/04-03-SUMMARY.md`
</output>
