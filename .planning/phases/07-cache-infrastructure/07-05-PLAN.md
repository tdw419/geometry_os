---
phase: 07-cache-infrastructure
plan: 05
type: execute
wave: 2
depends_on: ["07-04"]
files_modified:
  - systems/visual_shell/web/RTSDesktopObject.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees hash verification pass/fail status for each cached container"
    - "Verification status indicator is visible in the desktop object UI"
    - "Cache status reflects current verification state (verified/failed/pending)"
  artifacts:
    - path: "systems/visual_shell/web/RTSDesktopObject.js"
      provides: "Cache status indicator in container UI"
      contains: "cacheStatusIndicator or cacheStatus display"
  key_links:
    - from: "RTSDesktopObject"
      to: "CatalogCacheManager.getVerificationStatus"
      via: "status update call"
      pattern: "getVerificationStatus|cacheStatus"
---

<objective>
Add cache verification status UI to RTSDesktopObject so users can see hash verification pass/fail state for cached containers.

Purpose: Provide visual feedback on cache integrity.
Output: RTSDesktopObject with cache verification status indicator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing UI component
@systems/visual_shell/web/RTSDesktopObject.js

# Cache manager with getVerificationStatus method
@systems/visual_shell/web/CatalogCacheManager.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cache verification status indicator to RTSDesktopObject</name>
  <files>systems/visual_shell/web/RTSDesktopObject.js</files>
  <action>
    Add cache verification status display to RTSDesktopObject following existing status indicator pattern:

    1. Add to static STATUS_COLORS (after line 29):
       ```javascript
       static CACHE_STATUS_COLORS = {
           verified: 0x00ff00,   // Green - hash verified
           failed: 0xff4444,     // Red - hash mismatch
           pending: 0xffaa00,    // Orange - verification pending
           uncached: 0x666666    // Gray - not in cache
       };
       ```

    2. Add property in constructor (after line 175 where this._status is set):
       ```javascript
       this._cacheStatus = 'uncached';  // 'verified' | 'failed' | 'pending' | 'uncached'
       ```

    3. Add cache status indicator in _createStatusIndicator method (after line 318, after the main statusIndicator stroke):
       ```javascript
       // Cache verification status indicator (smaller, below main status)
       this.cacheStatusIndicator = new PIXI.Graphics();
       this.cacheStatusIndicator.x = OBJECT_WIDTH - PADDING - 8;  // 8px indicator
       this.cacheStatusIndicator.y = PADDING + 6 + STATUS_INDICATOR_SIZE + 4;  // Below main status
       this.cacheStatusIndicator.visible = false;  // Hidden by default
       this.addChild(this.cacheStatusIndicator);
       ```

    4. Add method to update cache status (after setStatus method around line 700):
       ```javascript
       /**
        * Update the cache verification status
        * @param {string} status - Cache status: 'verified', 'failed', 'pending', 'uncached'
        */
       setCacheStatus(status) {
           this._cacheStatus = status;
           const color = RTSDesktopObject.CACHE_STATUS_COLORS[status] || RTSDesktopObject.CACHE_STATUS_COLORS.uncached;

           this.cacheStatusIndicator.clear();
           this.cacheStatusIndicator.circle(4, 4, 4);  // Smaller 8px diameter
           this.cacheStatusIndicator.fill({ color: color, alpha: 0.9 });
           this.cacheStatusIndicator.circle(4, 4, 4);
           this.cacheStatusIndicator.stroke({ color: 0x000000, width: 1 });

           // Show indicator only when cached (not 'uncached')
           this.cacheStatusIndicator.visible = (status !== 'uncached');
       }

       /**
        * Get current cache verification status
        * @returns {string} Current cache status
        */
       getCacheStatus() {
           return this._cacheStatus;
       }
       ```

    5. Add cache status update in updateFromEntry method (after line 1096 where setStatus is called):
       ```javascript
       // Update cache status if cache manager is available
       if (window.catalogBridge?.cache && entry.id) {
           window.catalogBridge.cache.init().then(() => {
               return window.catalogBridge.cache.getVerificationStatus(entry.id);
           }).then(cacheStatus => {
               this.setCacheStatus(cacheStatus || 'uncached');
           }).catch(err => {
               console.warn('[RTSDesktopObject] Cache status check failed:', err);
           });
       }
       ```
  </action>
  <verify>
    ```bash
    grep -n "CACHE_STATUS_COLORS" systems/visual_shell/web/RTSDesktopObject.js && \
    grep -n "setCacheStatus" systems/visual_shell/web/RTSDesktopObject.js && \
    grep -n "cacheStatusIndicator" systems/visual_shell/web/RTSDesktopObject.js
    ```
  </verify>
  <done>
    RTSDesktopObject has cache status indicator, setCacheStatus method, and automatic status update from entry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tooltip support for cache status indicator</name>
  <files>systems/visual_shell/web/RTSDesktopObject.js</files>
  <action>
    Enhance cache status indicator with hover tooltip explaining verification state:

    1. Add cache status tooltip text in _createCacheStatusIndicator (after creating cacheStatusIndicator):
       ```javascript
       // Cache status tooltip (shown on hover)
       this.cacheStatusTooltip = new PIXI.Text({
           text: '',
           style: {
               fontFamily: 'Courier New, monospace',
               fontSize: 9,
               fill: 0xffffff,
               align: 'left'
           }
       });
       this.cacheStatusTooltip.visible = false;
       this.cacheStatusTooltip.x = OBJECT_WIDTH - PADDING - 100;  // Left of indicator
       this.cacheStatusTooltip.y = PADDING + 6 + STATUS_INDICATOR_SIZE + 2;
       this.addChild(this.cacheStatusTooltip);
       ```

    2. Update setCacheStatus method to set tooltip text:
       Add after `this.cacheStatusIndicator.visible = ...`:
       ```javascript
       const tooltipTexts = {
           verified: 'Cache: Verified',
           failed: 'Cache: FAILED',
           pending: 'Cache: Pending...',
           uncached: ''
       };
       this.cacheStatusTooltip.text = tooltipTexts[status] || '';
       ```

    3. Add hover handlers in _setupEventHandlers (modify pointerover/pointerout):
       In _onPointerOver (around line 760), add:
       ```javascript
       if (this.cacheStatusIndicator.visible) {
           this.cacheStatusTooltip.visible = true;
       }
       ```
       In _onPointerOut (around line 772), add:
       ```javascript
       this.cacheStatusTooltip.visible = false;
       ```
  </action>
  <verify>
    ```bash
    grep -n "cacheStatusTooltip" systems/visual_shell/web/RTSDesktopObject.js && \
    grep -n "Cache: Verified" systems/visual_shell/web/RTSDesktopObject.js
    ```
  </verify>
  <done>
    Cache status indicator shows tooltip on hover with verification state text.
  </done>
</task>

</tasks>

<verification>
1. UI component verification:
   - `grep "CACHE_STATUS_COLORS" systems/visual_shell/web/RTSDesktopObject.js` returns match
   - `grep "cacheStatusIndicator" systems/visual_shell/web/RTSDesktopObject.js` returns match
   - `grep "setCacheStatus" systems/visual_shell/web/RTSDesktopObject.js` returns match

2. Integration verification:
   - `grep "getVerificationStatus" systems/visual_shell/web/RTSDesktopObject.js` returns match
   - `grep "cacheStatusTooltip" systems/visual_shell/web/RTSDesktopObject.js` returns match

3. Syntax verification:
   - No JavaScript syntax errors in RTSDesktopObject.js
</verification>

<success_criteria>
- RTSDesktopObject displays cache verification status as colored indicator
- Indicator color matches verification state (green=verified, red=failed, orange=pending)
- Tooltip shows verification state text on hover
- Status updates automatically from CatalogCacheManager.getVerificationStatus
- Indicator hidden for uncached containers
</success_criteria>

<output>
After completion, create `.planning/phases/07-cache-infrastructure/07-05-SUMMARY.md`
</output>
